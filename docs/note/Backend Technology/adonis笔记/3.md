# HTTP

## Context

## åŸºæœ¬ä»‹ç»

HTTP context æ˜¯ request ç‰¹æœ‰çš„å¯¹è±¡ï¼Œç”¨æ¥å­˜æ”¾è¯¸å¦‚ request bodyã€cookiesã€headers ç­‰ç»™å®šçš„ HTTP request ä¿¡æ¯ã€‚

HTTP context è¢«å½“åšå¼•ç”¨ä¼ é€’ç»™ route å¤„ç†å‡½æ•°ã€middlewareã€HTTP hooks ä»¥åŠ exception å‡½æ•°ã€‚

```js
Route.get('/', ({ request, auth, response }) => {
  /**
   * Request URL
   */
  console.log(request.url())

  /**
   * Request body + query params
   */
  console.log(request.all())

  /**
   * Send response
   */
  response.send('hello world')
  response.send({ hello: 'world' })

  /**
   * Available when auth is configured
   */
  console.log(auth.user)
})
```

å½“åœ¨ controller æ–¹æ³•è®¿é—® context æ—¶éœ€è¦ç¡®ä¿ HTTP çš„ context ç±»å‹æ˜¯æ˜ç¡®çš„ã€‚

```js
import { HttpContextContract } from '@ioc:Adonis/Core/HttpContext'

class HomeController {
  public async index({ request, response }: HttpContextContract) {

  }
}
```

> åœ¨ AdonisJS ä¸­ï¼Œä½ ä¸ä¼šçœ‹åˆ°åƒ req å’Œ res è¿™æ ·çš„å¯¹è±¡ï¼Œè¿™æ˜¯å› ä¸ºæ‰€æœ‰ä¸œè¥¿åŒ…æ‹¬ request å’Œ response éƒ½æ˜¯ HTTP context çš„ä¸€éƒ¨åˆ†ã€‚
>
> æˆ‘ä»¬é¼“åŠ±ä½ å°†è‡ªå®šä¹‰çš„å±æ€§æ”¾åˆ° ctx å¯¹è±¡ä¸­ï¼Œè€Œä¸æ˜¯ request å¯¹è±¡ä¸­ã€‚
>
> ä»è¿™é‡ŒæŸ¥çœ‹[æ‰©å±• context](https://docs.adonisjs.com/guides/context#extending-context)

AdonisJS ç”¨ Node.js çš„ `Async Local Storage`è®©ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è®¿é—®åˆ° HTTP context ã€‚

ä½ å¯ä»¥ç”¨ä»¥ä¸‹ä»£ç è®¿é—®åˆ°å½“å‰è¯·æ±‚çš„ context

```js
import HttpContext from '@ioc:Adonis/Core/HttpContext'

class SomeService {
  public async someOperation() {
    const ctx = HttpContext.get()
  }
}
```

## Controllers

Controllerï¼ˆæ§åˆ¶å™¨ï¼‰æ˜¯ç”¨æ¥å¤„ç† HTTP è¯·æ±‚çš„ã€‚å®ƒä»¬ä½¿æ‚¨èƒ½å¤Ÿé€šè¿‡å°†æ‰€æœ‰å†…è”è·¯ç”±å¤„ç†ç¨‹åºç§»åŠ¨åˆ°å®ƒä»¬çš„ä¸“ç”¨æ§åˆ¶å™¨æ–‡ä»¶æ¥ä¿æŒè·¯ç”±æ–‡ä»¶çš„æ•´æ´ã€‚

åœ¨ AdonisJS ä¸­ï¼Œæ‰€æœ‰çš„æ§åˆ¶å™¨éƒ½æ”¾åœ¨`app/Controllers/Http`ç›®å½•ä¸­ã€‚

**æ³¨å†Œè·¯ç”±**

```bash
node ace make:controller Post

# CREATE: app/Controllers/Http/PostsController.ts
```

å¦‚æœæ‚¨æ³¨æ„åˆ°çš„è¯ï¼Œåœ¨ä¸Šé¢çš„å‘½ä»¤ä¸­ï¼Œæˆ‘ä»¬æåˆ°å•è¯ Post æ˜¯å•æ•°ï¼Œè€Œç”Ÿæˆçš„æ–‡ä»¶åæ˜¯å¤æ•°å½¢å¼ï¼Œå¹¶æœ‰ä¸€ä¸ª Controller åç¼€ã€‚

AdonisJS åº”ç”¨è¿™äº›è½¬æ¢æ¥ç¡®ä¿æ–‡ä»¶ååœ¨æ•´ä¸ªé¡¹ç›®ä¸­ä¿æŒä¸€è‡´ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`--exact`æ ‡å¿—æŒ‡ç¤º CLI ä¸è¦åº”ç”¨è¿™äº›è½¬æ¢ã€‚

**ä½¿ç”¨è·¯ç”±**

```js
Route.get('posts', 'PostsController.index')
```

**å®ç° Controller**

```js
import { HttpContextContract } from '@ioc:Adonis/Core/HttpContext'

export default class PostsController {
  public async index(ctx: HttpContextContract) {
    return [
      {
        id: 1,
        title: 'Hello world',
      },
      {
        id: 2,
        title: 'Hello universe',
      },
    ]
  }
}
```

å¸¸è§çš„ CRUD è·¯ç”±

```js
Route.get('/posts', () => {
  return 'List all posts'
})

Route.get('/posts/create', () => {
  return 'Display a form to create a post'
})

Route.post('/posts', async () => {
  return 'Handle post creation form request'
})

Route.get('/posts/:id', () => {
  return 'Return a single post'
})

Route.get('/posts/:id/edit', () => {
  return 'Display a form to edit a post'
})

Route.put('/posts/:id', () => {
  return 'Handle post update form submission'
})

Route.delete('/posts/:id', () => {
  return 'Delete post'
})
```

## Middleware

ä¸­é—´ä»¶æ˜¯åœ¨ HTTP è¯·æ±‚åˆ°è¾¾è·¯ç”±å¤„ç†ç¨‹åºä¹‹å‰æ‰§è¡Œçš„ä¸€ç³»åˆ—åŠŸèƒ½ã€‚é“¾ä¸­çš„æ¯ä¸ªå‡½æ•°éƒ½æœ‰èƒ½åŠ›ç»“æŸè¯·æ±‚æˆ–å°†å…¶è½¬å‘ç»™ä¸‹ä¸€ä¸ªå‡½æ•°ã€‚

```js
Route.get('/users/:id', async () => {
  return 'Show user'
}).middleware(async (ctx, next) => {
  console.log(`Inside middleware ${ctx.request.url()}`)
  await next()
})
```

å°†ä¸­é—´ä»¶ç¼–å†™ä¸ºå†…è”å‡½æ•°å¯ä»¥è¿›è¡Œä¸€äº›å¿«é€Ÿæµ‹è¯•ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å»ºè®®å°†ä¸­é—´ä»¶é€»è¾‘æå–åˆ°å®ƒè‡ªå·±çš„æ–‡ä»¶ä¸­ã€‚

æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹ Ace å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸­é—´ä»¶ã€‚

```bash
node ace make:middleware LogRequest

# CREATE: app/Middleware/LogRequest.ts
```

ä¸­é—´ä»¶ç±»å­˜å‚¨ï¼ˆä½†ä¸é™äºï¼‰åœ¨ app/Middleware ç›®å½•ä¸­ï¼Œæ¯ä¸ªæ–‡ä»¶ä»£è¡¨ä¸€ä¸ªä¸­é—´ä»¶ã€‚

æ¯ä¸ªä¸­é—´ä»¶ç±»éƒ½å¿…é¡»å®ç° handle æ–¹æ³•æ¥å¤„ç† HTTP è¯·æ±‚ï¼Œå¹¶è°ƒç”¨ä¸‹ä¸€ä¸ªæ–¹æ³•å°†è¯·æ±‚è½¬å‘åˆ°ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–è·¯ç”±å¤„ç†ç¨‹åºã€‚

```js
// app/Middleware/LogRequest.ts

import { HttpContextContract } from '@ioc:Adonis/Core/HttpContext'

export default class LogRequest {
  public async handle(
    { request }: HttpContextContract,
    next: () => Promise<void>
  ) {
    console.log(`-> ${request.method()}: ${request.url()}`)
    await next()
  }
}
```

æ­¤å¤–ï¼Œæ‚¨å¯ä»¥é€šè¿‡å¼•å‘å¼‚å¸¸æˆ–ä½¿ç”¨ response.send æ–¹æ³•å‘é€å“åº”æ¥ç»ˆæ­¢æ¥è‡ªä¸­é—´ä»¶çš„è¯·æ±‚ã€‚

```js
import { HttpContextContract } from '@ioc:Adonis/Core/HttpContext'

export default class Auth {
  public async handle(
    { request, response }: HttpContextContract,
    next: () => Promise<void>
  ) {
    if (notAuthenticated) {
      response.unauthorized({ error: 'Must be logged in' })
      return
    }

    await next()
  }
}
```

è¦ä½¿ä¸­é—´ä»¶ç”Ÿæ•ˆï¼Œå¿…é¡»åœ¨ start/kernel.ts æ–‡ä»¶ä¸­å°†å…¶æ³¨å†Œä¸ºå…¨å±€ä¸­é—´ä»¶æˆ–å‘½åä¸­é—´ä»¶ã€‚

å¯¹æ‰€æœ‰ HTTP è¯·æ±‚æ‰§è¡Œå…¨å±€ä¸­é—´ä»¶çš„é¡ºåºä¸å®ƒä»¬æ³¨å†Œçš„é¡ºåºç›¸åŒã€‚

æ‚¨å¯ä»¥åœ¨ start/kernel.ts æ–‡ä»¶ä¸­å°†å®ƒä»¬æ³¨å†Œä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```js
// start/kernel.ts
Server.middleware.register([() => import('@ioc:Adonis/Core/BodyParser'), () => import('App/Middleware/LogRequest')])
```

å‘½åä¸­é—´ä»¶å…è®¸æ‚¨åœ¨è·¯ç”±/è·¯ç”±ç»„ä¸Šé€‰æ‹©æ€§åœ°åº”ç”¨ä¸­é—´ä»¶ã€‚æ‚¨é¦–å…ˆç”¨ä¸€ä¸ªå”¯ä¸€çš„åç§°æ³¨å†Œå®ƒä»¬ï¼Œç„¶ååœ¨è·¯çº¿ä¸Šç”¨è¯¥åç§°å¼•ç”¨å®ƒã€‚

```js
Server.middleware.registerNamed({
  auth: () => import('App/Middleware/Auth'),
})
```

ç°åœ¨ï¼Œæ‚¨å¯ä»¥å°† auth ä¸­é—´ä»¶é™„åŠ åˆ°ä¸€ä¸ªè·¯ç”±ï¼Œå¦‚ä¸‹é¢çš„ç¤ºä¾‹æ‰€ç¤ºã€‚

```js
Route.get('dashboard', 'DashboardController.index').middleware('auth') // ğŸ‘ˆ
```

æ‚¨è¿˜å¯ä»¥åœ¨ä¸€æ¡è·¯ç”±ä¸Šå®šä¹‰å¤šä¸ªä¸­é—´ä»¶ï¼Œæ–¹æ³•æ˜¯å°†å®ƒä»¬ä½œä¸ºæ•°ç»„ä¼ é€’æˆ–å¤šæ¬¡è°ƒç”¨ä¸­é—´ä»¶æ–¹æ³•ã€‚

```js
Route.get('dashboard', 'DashboardController.index').middleware(['auth', 'acl', 'throttle'])
```

```js
Route.get('dashboard', 'DashboardController.index').middleware('auth').middleware('acl').middleware('throttle')
```

å‘½åä¸­é—´ä»¶è¿˜å¯ä»¥é€šè¿‡ handle æ–¹æ³•æ¥å—è¿è¡Œæ—¶é…ç½®ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ã€‚ä¾‹å¦‚ï¼š

```js
export default class Auth {
  public async handle(
    { request, response }: HttpContextContract,
    next: () => Promise<void>,
    guards?: string[]
  ) {
    await next()
  }
}
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒAuth ä¸­é—´ä»¶æ¥å—ä¸€ä¸ªå¯é€‰çš„`guards`æ•°ç»„ã€‚ä¸­é—´ä»¶çš„ç”¨æˆ·å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼ä¼ é€’ï¼š

```js
Route.get('dashboard', 'DashboardController.index').middleware('auth:web,api')
```
