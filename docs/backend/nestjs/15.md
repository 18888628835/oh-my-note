# @Nextã€Middlewareã€Interceptor

åç«¯é¡¹ç›®ä¸­ï¼Œç»å¸¸ä¼šæœ‰éœ€è¦å®ç°è¯·æ±‚å‰åé€»è¾‘çš„æƒ…å†µï¼Œæ¯”å¦‚åœ¨è¯·æ±‚å‰åš IP éªŒè¯ï¼Œåœ¨è¯·æ±‚åå®ç°æ—¥å¿—è®°å½•ç­‰ç­‰ã€‚

ä¸€ä¸ªæ¯”è¾ƒå¥½çš„å®è·µæ˜¯å°†è¿™äº›å¹¶ä¸æ¶‰åŠå•ä¸ªä¸šåŠ¡é€»è¾‘çš„ä»£ç ç”¨ AOP çš„å½¢å¼ä» Controller é€»è¾‘ä¸­åˆ‡å‰²å‡ºæ¥ã€‚

ä¸‹é¢æ¥è°ˆè°ˆ Nest.js ç»™å‡ºçš„å®ç°æ–¹æ³•ï¼š

1. @Next è£…é¥°å™¨
2. Middleware
3. Interceptor

## @Next è£…é¥°å™¨

è¿™ä¸ªè£…é¥°å™¨ä¸»è¦ç”¨äºè°ƒç”¨ä¸‹ä¸€ä¸ª handler çš„ã€‚

åœ¨ Controller ä¸­ä½¿ç”¨ @Next è£…é¥°å™¨æ¥è°ƒç”¨å¦å¤–ä¸€ä¸ª handler å‡½æ•°è¯•è¯•ï¼š

```typescript
  @Get()
  getHello1(@Next() next) {
    console.log('before...');
    next();
  }
  @Get()
  getHello(@Next() next, @Response({ passthrough: true }) res: Res) {
    console.log('handle...')
    next();
    return 'Hello World!';
  }
  @Get()
  getHello2() {
    console.log('after...');
  }
```

åœ¨åŒä¸€ä¸ªè·¯ç”±ä¸‹ï¼Œä¸Šé¢çš„ä»£ç æ‰§è¡Œè¿‡ç¨‹æ˜¯ï¼š

```bash
before...
handle...
after...
```

å•ç‹¬ä½¿ç”¨`@Next()`æƒ…å†µä¸‹ï¼ŒNest ä¸ä¼šå¤„ç†è¿”å›å€¼ï¼Œå› æ­¤æœ€åä¸€ä¸ª handler çš„ç»“æœä¼šè¢«å½“åš response è¿”å›ã€‚

è¿™é‡Œæ˜¯é€šè¿‡`@Response({ passthrough: true })`è£…é¥°å™¨å‘ŠçŸ¥ Nest æŠŠ `getHello()`çš„è¿”å›å€¼ä½œä¸ºå“åº”ã€‚

## Middleware

ä¸­é—´ä»¶æ˜¯åç«¯ä¸­æœ€å¸¸ç”¨çš„é€‰é¡¹ã€‚

è·Ÿ express.js çš„ä¸­é—´ä»¶ä¸åŒçš„åœ°æ–¹åœ¨äºï¼Œ Nest.js çš„ä¸­é—´ä»¶è¿˜æ”¯æŒæ³¨å…¥ Providerã€‚

å› æ­¤åœ¨ Nestjs ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä¼˜å…ˆä½¿ç”¨ä¸­é—´ä»¶æ¥å¤„ç†è¯·æ±‚å‰åçš„ä¸€äº›é€»è¾‘ã€‚

ç”Ÿæˆä¸­é—´ä»¶

```bash
nest generate middleware test --no-spec
```

ä¸­é—´ä»¶ä»£ç ï¼Œæ³¨å…¥äº† Service ä¾èµ–ã€‚

```typescript
@Injectable()
export class TestMiddleware implements NestMiddleware {
  @Inject(AppService)
  private readonly appService: AppService
  async use(req: any, res: any, next: () => void) {
    console.log('brefore')
    const result = await this.appService.getHello()
    console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” result:', result)
    next()
    console.log('after')
  }
}
```

åœ¨ Module ä¸­æ³¨å†Œä¸­é—´ä»¶ï¼š

```ts
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(TestMiddleware).forRoutes({ path: '/', method: RequestMethod.GET })
  }
}
```

æˆ–è€…åœ¨ Module ä¸­æ³¨å†Œå…¨å±€ä¸­é—´ä»¶ï¼š

```typescript
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(TestMiddleware).forRoutes('*')
  }
}
```

æ‰§è¡Œç»“æœï¼š

```bash
brefore
â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” result: Hello World!
handle...
after
```

å¦‚æœä¸æƒ³è¦æ³¨å…¥ä¾èµ–ï¼Œä¹Ÿå¯ä»¥ç”¨çº¯å‡½æ•°ï¼Œè¿™æ ·å°±ä¸éœ€è¦ class äº†ã€‚

```typescript
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer
      .apply((req, res, next) => {
        console.log('...before')
        next()
        console.log('...after')
      })
      .forRoutes('*')
  }
}
```

æˆ–è€…ç›´æ¥åœ¨å…¥å£æ–‡ä»¶ä½¿ç”¨ app.use æ³¨å†Œå…¨å±€ä¸­é—´ä»¶(ä¹Ÿæ˜¯ä½¿ç”¨çº¯å‡½æ•°)ï¼š

```typescript
async function bootstrap() {
  const app = await NestFactory.create(AppModule)
  app.use((req, res, next) => {
    console.log('...before')
    next()
    console.log('...after')
  })
  await app.listen(3000)
}
```

å¦‚æœä¸éœ€è¦æ³¨å…¥ä¾èµ–ï¼Œé‚£å¯ä»¥å†™å‡½æ•°å½¢å¼çš„ middlewareï¼Œè¿™æ—¶å€™å’Œ Express çš„ middleware å°±æ²¡å•¥åŒºåˆ«äº†ã€‚

å¦‚æœéœ€è¦æ³¨å…¥ä¾èµ–ï¼Œé‚£å°±å†™ class å½¢å¼çš„ middlewareï¼Œå¯ä»¥ç”¨ Nest çš„ä¾èµ–æ³¨å…¥èƒ½åŠ›ã€‚

## interceptor

ç”Ÿæˆ interceptor

```bash
nest generate interceptor test --no-spec
```

ç”Ÿæˆä»£ç 

```typescript
import { CallHandler, ExecutionContext, Injectable, NestInterceptor } from '@nestjs/common'
import { Observable } from 'rxjs'

@Injectable()
export class TestInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    return next.handle()
  }
}
```

ä½¿ç”¨ Interceptor

```tsx
  @Get()
  @UseInterceptors(TestInterceptor)
  getHello(): string {
    return this.appService.getHello();
  }
```

interceptor å¦‚æœå€ŸåŠ© rx.js çš„å¼‚æ­¥æµå¼ç¼–ç¨‹ä½¿ç”¨ï¼Œèƒ½å¤Ÿå®ç°è·å–ã€ä¿®æ”¹ request æˆ– response ç­‰åŠŸèƒ½ã€‚

### tap

ä¸‹é¢æ˜¯é€šè¿‡ tap è·å– response çš„ä»£ç ï¼š

```diff
@Injectable()
export class TestInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
-  	return next.handle()
+    return next.handle().pipe(tap((value) => console.log('after...', value)));
  }
}
```

tap operator ä¸ä¼šæ”¹å˜æ•°æ®ï¼Œåªæ˜¯é¢å¤–æ‰§è¡Œä¸€æ®µé€»è¾‘ã€‚

é€šè¿‡ tap è·å–åˆ° handler ç»“æœï¼Œå¹¶ä¸”æ‰“å°å‡ºæ¥ã€‚è®¿é—®`http://localhost:3000/`å°±å¯ä»¥çœ‹åˆ°ç»“æœï¼š

```bash
after... Hello World!
```

ä½¿ç”¨ tap operator å¯ä»¥æ·»åŠ ä¸€äº›æ—¥å¿—ã€ç¼“å­˜ç­‰é€»è¾‘ã€‚å¯¹äºä¾èµ–æ³¨å…¥çš„æ”¯æŒä¹Ÿä½¿å¾—å®ç°è¿™äº›åŠŸèƒ½æ›´åŠ ä¾¿æ·ã€‚

### map

ä½¿ç”¨ map operator æ¥å¯¹ controller è¿”å›çš„æ•°æ®åšä¸€äº›ä¿®æ”¹ã€‚

```typescript
@Injectable()
export class TestInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    return next.handle().pipe(
      map((data) => ({
        code: 200,
        status: 'success',
        data,
      })),
    )
  }
}
```

### catchError

controller é‡Œå¾ˆå¯èƒ½ä¼šæŠ›å‡ºé”™è¯¯ï¼Œè¿™äº›é”™è¯¯ä¼šè¢« exception filter å¤„ç†ï¼Œè¿”å›ä¸åŒçš„å“åº”ï¼Œä½†åœ¨é‚£ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ interceptor é‡Œå…ˆå¤„ç†ä¸‹ã€‚

```typescript
import { CallHandler, ExecutionContext, Injectable, Logger, NestInterceptor } from '@nestjs/common'
import { Observable, catchError, throwError } from 'rxjs'

@Injectable()
export class TestInterceptor implements NestInterceptor {
  private readonly logger = new Logger(TestInterceptor.name)
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    return next.handle().pipe(
      catchError((err) => {
        this.logger.error(err.message, err.stack)
        return throwError(() => err)
      }),
    )
  }
}
```

### timeout

æ¥å£å¦‚æœé•¿æ—¶é—´æ²¡è¿”å›ï¼Œè¦ç»™ç”¨æˆ·ä¸€ä¸ªæ¥å£è¶…æ—¶çš„å“åº”ï¼Œè¿™æ—¶å€™å°±å¯ä»¥ç”¨ timeout operatorã€‚

```typescript
@Injectable()
export class TestInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    return next.handle().pipe(
      timeout(3000),
      catchError((err) => {
        if (err instanceof TimeoutError) {
          console.log(err)
          return throwError(() => new RequestTimeoutException())
        }
        return throwError(() => err)
      }),
    )
  }
}
```

timeout æ“ä½œç¬¦ä¼šåœ¨ 3s æ²¡æ”¶åˆ°æ¶ˆæ¯çš„æ—¶å€™æŠ›ä¸€ä¸ª TimeoutErrorã€‚

ç„¶åç”¨ catchError æ“ä½œç¬¦å¤„ç†ä¸‹ï¼Œå¦‚æœæ˜¯ TimeoutErrorï¼Œå°±è¿”å› RequestTimeoutExceptionï¼Œè¿™ä¸ªæœ‰å†…ç½®çš„ exception filter ä¼šå¤„ç†æˆå¯¹åº”çš„å“åº”æ ¼å¼ã€‚

å…¶ä½™é”™è¯¯å°±ç›´æ¥ throwError æŠ›å‡ºå»ã€‚

RequestTimeoutException çš„å“åº”æ˜¯è¿™æ ·çš„ï¼š

```json
{
  "message": "Request Timeout",
  "statusCode": 408
}
```

### å…¨å±€ Interceptor æ³¨å…¥ä¾èµ–

é»˜è®¤çš„å…¨å±€çš„ Interceptor æ˜¯è¿™æ ·ä½¿ç”¨çš„ï¼š

```typescript
import { NestFactory } from '@nestjs/core'
import { AppModule } from './app.module'
import { TestInterceptor } from './test/test.interceptor'

async function bootstrap() {
  const app = await NestFactory.create(AppModule)
  await app.useGlobalInterceptors(new TestInterceptor())
  await app.listen(3000)
}
bootstrap()
```

ä½†æ˜¯è¿™ä¸ªç”¨æ³•æ²¡åŠæ³•æ³¨å…¥å…¶ä»–æœåŠ¡ä¾èµ–ã€‚

Nest æä¾›äº†ä¸€ä¸ª tokenï¼Œç”¨è¿™ä¸ª token åœ¨ AppModule é‡Œå£°æ˜çš„ interceptorï¼ŒNest ä¼šæŠŠå®ƒä½œä¸ºå…¨å±€ interceptorã€‚

```typescript
import { Module } from '@nestjs/common'
import { AppController } from './app.controller'
import { AppService } from './app.service'
import { TestInterceptor } from './test/test.interceptor'
import { APP_INTERCEPTOR } from '@nestjs/core'

@Module({
  imports: [],
  controllers: [AppController],
  providers: [
    AppService,
    {
      provide: APP_INTERCEPTOR,
      useClass: TestInterceptor,
    },
  ],
})
export class AppModule {}
```

ç°åœ¨å°±å¯ä»¥åœ¨å…¨å±€ Interceptor ä¸­æ³¨å…¥å…¶ä»– service å•¦ï¼š

![image-20231106220941776](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202311062209545.png)

## æ€»ç»“

åç«¯é¡¹ç›®ä¸­ï¼Œç»å¸¸éœ€è¦åšè¯·æ±‚å‰ã€è¯·æ±‚åçš„ä¸€äº›é€»è¾‘ï¼Œæ¯”å¦‚ ip éªŒè¯ï¼ˆè¯·æ±‚å‰ï¼‰ã€è®°å½•æ—¥å¿—ï¼ˆè¯·æ±‚åï¼‰ã€‚

åœ¨ nest.js ä¸­æœ‰ä¸‰ç§æ–¹æ³•å¯ä»¥åšè¯·æ±‚å‰å’Œè¯·æ±‚åçš„é€»è¾‘ï¼š

1. @Next è£…é¥°å™¨
2. Middleware
3. Interceptor

è¿™å‡ ç§æ–¹æ³•éƒ½å¯ä»¥æ³¨å…¥ä¾èµ–ã€‚

@Next è£…é¥°å™¨ ä¸å¸¸ç”¨ã€‚

middleware é€‚åˆå¤„ç†é€šç”¨çš„é€»è¾‘ã€‚

interceptor å’Œ middleware åŠŸèƒ½ç±»ä¼¼ï¼Œä½†ä¹Ÿæœ‰ä¸åŒï¼Œinterceptor å¯ä»¥æ‹¿åˆ°ç›®æ ‡ classã€handler ç­‰ï¼Œä¹Ÿå¯ä»¥è°ƒç”¨ rxjs çš„ operator æ¥å¤„ç†å“åº”ï¼Œæ›´é€‚åˆå¤„ç†å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚

å¸¸ç”¨çš„ operator æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š

- tap: ä¸ä¿®æ”¹å“åº”æ•°æ®ï¼Œæ‰§è¡Œä¸€äº›é¢å¤–é€»è¾‘ï¼Œæ¯”å¦‚è®°å½•æ—¥å¿—ã€æ›´æ–°ç¼“å­˜ç­‰
- mapï¼šå¯¹å“åº”æ•°æ®åšä¿®æ”¹ï¼Œä¸€èˆ¬éƒ½æ˜¯æ”¹æˆ {code, data, message} çš„æ ¼å¼
- catchErrorï¼šåœ¨ exception filter ä¹‹å‰å¤„ç†æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå¯ä»¥è®°å½•æˆ–è€…æŠ›å‡ºåˆ«çš„å¼‚å¸¸
- timeoutï¼šå¤„ç†å“åº”è¶…æ—¶çš„æƒ…å†µï¼ŒæŠ›å‡ºä¸€ä¸ª TimeoutErrorï¼Œé…åˆ catchErrror å¯ä»¥è¿”å›è¶…æ—¶çš„å“åº”

å…¨å±€ interceptor å¯ä»¥é€šè¿‡ APP_INTERCEPTOR çš„ token å£°æ˜ï¼Œè¿™ç§èƒ½æ³¨å…¥ä¾èµ–ï¼Œæ¯” app.useGlobalInterceptors æ›´å¥½ã€‚
