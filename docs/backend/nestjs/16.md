# Pipe

## ä½¿ç”¨å†…ç½® Pipe

åœ¨å‚æ•°ä¼ é€’ç»™ handler ä¹‹å‰ï¼Œä½¿ç”¨ Pipe èƒ½å¤Ÿå¯¹å‚æ•°åšä¸€äº›éªŒè¯å’Œè½¬æ¢ã€‚

å¯ä»¥ä½¿ç”¨ `@UsePipes(ParseIntPipe)`è¿™ç§æ˜¾å¼è¯­æ³•æ¥ä½¿ç”¨ Pipeã€‚

æœ‰å¾ˆå¤šå†…ç½®çš„ Pipeï¼š

- ValidationPipeï¼šå¯¹å‚æ•°åšæ ¡éªŒçš„ Pipe
- ParseIntPipeï¼šå°†å‚æ•°è½¬åŒ–ä¸ºæ•´æ•°çš„ Pipe
- ParseBoolPipeï¼šå°†å‚æ•°è½¬åŒ–ä¸ºå¸ƒå°”å€¼çš„ Pipe
- ParseArrayPipeï¼šå°†å‚æ•°è½¬åŒ–ä¸º Array çš„åŒ…ï¼Œéœ€è¦ä¸‹è½½é¢å¤–çš„åŒ…
- ParseUUIDPipeï¼šæ ¡éªŒå‚æ•°æ˜¯å¦ä¸º uuid çš„åŒ…ã€‚
- DefaultValuePipeï¼šå½“æ²¡æœ‰å‚æ•°æ—¶é»˜è®¤æä¾›ä¸€ä¸ªå‚æ•°
- ParseEnumPipeï¼šå‚æ•°é™å®šä¸ºå®šä¹‰å¥½çš„æšä¸¾
- ParseFloatPipeï¼šå°†å‚æ•°è½¬åŒ–ä¸º float
- ParseFilePipeï¼šæ–‡ä»¶ç›¸å…³çš„ pipe

ä»–ä»¬éƒ½å®ç°äº† PipeTransform æ¥å£ã€‚

æ¯”å¦‚ ParseIntPipe çš„æºç æ˜¯è¿™æ ·çš„ï¼š

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa9cca172621448da12d1b2fcedd7fdd~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp)

æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ª Pipe èƒ½å¤ŸæŠŠå‚æ•°ä¿®æ”¹æˆæ•°å­—ã€‚

![image-20231115230629800](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202311152306840.png)

å¦‚æœä¼ é€’çš„ name ä¸èƒ½è½¬åŒ–ä¸º number çš„è¯ï¼Œnest ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚

![image-20231115230857443](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202311152308506.png)

æƒ³è¦ä¿®æ”¹è¿™æ ·çš„è¡Œä¸ºï¼Œéœ€è¦ä½¿ç”¨ new XXXPipe çš„æ–¹å¼ï¼š

```typescript
  @Get()
  getHello(
    @Query(
      'name',
      new ParseIntPipe({
        errorHttpStatusCode: HttpStatus.FORBIDDEN,
      }),
    )
    name: string,
  ): string {
    console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” name:', name);
    console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€”typeof name:', typeof name);
    return this.appService.getHello();
  }
```

æ¯”å¦‚ä¸Šé¢çš„æ–¹å¼å°±å°†é”™è¯¯æ—¶çš„çŠ¶æ€ç æ”¹ä¸ºäº† 403ã€‚

![image-20231115231228383](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202311152312440.png)

æ­¤å¤–ï¼Œè¿˜èƒ½å¤ŸåŒæ—¶æŒ‡å®šçŠ¶æ€ç å’ŒçŠ¶æ€ä¿¡æ¯ï¼š

![image-20231115231532703](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202311152315738.png)

ä½ ä¹Ÿå¯ä»¥åŠ ä¸ª @UseFilters æ¥ä½¿ç”¨è‡ªå·±çš„ exception filter å¤„ç†ã€‚

```typescript
  @Get()
  @UseFilters(ApiExceptionFilter)
  getHello(
    @Query('name', ParseIntPipe)
    name: string,
  ): string {
    console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” name:', name);
    console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€”typeof name:', typeof name);
    return this.appService.getHello();
  }
```

ApiExceptionFilter çš„ä»£ç ä¸ºï¼š

```typescript
import { ArgumentsHost, Catch, ExceptionFilter, HttpException } from '@nestjs/common'

@Catch()
export class ApiExceptionFilter implements ExceptionFilter {
  catch(exception: HttpException, host: ArgumentsHost) {
    const ctx = host.switchToHttp()
    const response = ctx.getResponse()
    const request = ctx.getRequest()
    const status = exception.getStatus()

    response.status(status).json({
      statusCode: status,
      path: request.url,
      message: exception.message,
    })
  }
}
```

![image-20231115232856881](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202311152328978.png)

## ä½¿ç”¨è‡ªå®šä¹‰ Pipe

ç”Ÿæˆè‡ªå®šä¹‰ Pipe

```bash
nest generate pipe aaa --no-spec
```

é€šè¿‡ç”Ÿæˆåçš„ä»£ç å¯ä»¥çœ‹å‡ºè‡ªå®šä¹‰ Pipe éœ€è¦ implements `PipeTransform`æ¥å£ï¼Œå¹¶ä¸”å®ç° transform æ–¹æ³•ã€‚

æˆ‘ä»¬ç”¨è‡ªå®šä¹‰ Pipe æ¥è¿”å› `aaa`è¯•è¯•ï¼š

```typescript
import { ArgumentMetadata, Injectable, PipeTransform } from '@nestjs/common'

@Injectable()
export class AaaPipe implements PipeTransform {
  transform(value: any, metadata: ArgumentMetadata) {
    console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” value:', value)
    console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” metadata:', metadata)
    return 'aaa'
  }
}
```

ä½¿ç”¨è¿™ä¸ª Pipe æ—¶ï¼Œå¯ä»¥çœ‹åˆ°å‚æ•°å–å¾—çš„ç»“æœæ˜¯è¯¥ Pipe çš„è¿”å›å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ pipe çš„è¿”å›å€¼å°±æ˜¯ä¼ ç»™ handler çš„å‚æ•°å€¼ã€‚

```typescript
  @Get()
  getHello(
    @Query('name', AaaPipe)
    name: string,
  ): string {
    console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” name:', name);
    return this.appService.getHello();
  }
```

![image-20231116221548353](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202311162215554.png)

## validationPipe

validationPipe ç”¨äºéªŒè¯ä¼ å…¥çš„æ•°æ®ã€‚å®ƒåŸºäºç±»ä¼¼äº [class-validator](https://github.com/typestack/class-validator) çš„åº“æ¥æ‰§è¡ŒéªŒè¯ã€‚

å…ˆä¸‹è½½ä¸¤ä¸ªç›¸å…³çš„åŒ…ï¼š

```bash
pnpm install class-validator class-transformer
```

å†åˆ›å»ºä¸€ä¸ª dto å¯¹è±¡ï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰ã€‚

```typescript
// src/dto/person.dto.ts
export class Person {
  name: string
  age: number
}
```

å¯¹äºè¯¥ dto å¯¹è±¡ï¼Œæˆ‘ä»¬æƒ³è¦éªŒè¯ age æ˜¯ numberï¼Œå¯ä»¥ä» class-validator åŒ…é‡Œå–åˆ°`@IsInt` è£…é¥°å™¨ã€‚

```typescript
import { IsInt } from 'class-validator'

export class Person {
  name: string
  @IsInt()
  age: number
}
```

ç„¶åå†ä½¿ç”¨ï¼š

```typescript
...
import { Person } from './dto/person.dto';

@Post()
  @UsePipes(ValidationPipe)
  getHello(
    @Body()
    person: Person,
  ): string {
    console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” person:', person);
    return this.appService.getHello();
  }
```

ç°åœ¨æˆ‘ä»¬å·²ç»ä½¿ç”¨äº† ValidationPipe ï¼Œå¹¶ä¸”å·²ç»æŠŠæƒ³è¦éªŒè¯çš„å†…å®¹å†™åˆ°äº† dto å¯¹è±¡é‡Œã€‚

è¯·æ±‚ä¸€ä¸‹çœ‹çœ‹ï¼š

![image-20231116225632747](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202311162256822.png)

validationPipe å·²ç»æ£€æŸ¥åˆ°å‚æ•°é‡Œçš„é”™è¯¯äº†ã€‚

ç®€å•æ¥è¯´æ•´ä¸ªå®ç°è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š

> **æˆ‘ä»¬å£°æ˜äº†å‚æ•°çš„ç±»å‹ä¸º dto ç±»ï¼Œpipe é‡Œæ‹¿åˆ°è¿™ä¸ªç±»ï¼ŒæŠŠå‚æ•°å¯¹è±¡é€šè¿‡ class-transformer è½¬æ¢ä¸º dto ç±»çš„å¯¹è±¡ï¼Œä¹‹åå†ç”¨ class-validator åŒ…æ¥å¯¹è¿™ä¸ªå¯¹è±¡åšéªŒè¯ã€‚**

æˆ‘ä»¬å…¶å®ä¹Ÿå¯ä»¥è‡ªå·±åŠ¨æ‰‹å®ç°ï¼š

```bash
nest generate pipe MyValidationPipe --no-spec
```

```typescript
import { ArgumentMetadata, BadRequestException, Injectable, PipeTransform } from '@nestjs/common'
import { plainToInstance } from 'class-transformer'
import { validate } from 'class-validator'

@Injectable()
export class MyValidationPipePipe implements PipeTransform {
  async transform(value: any, metadata: ArgumentMetadata) {
    const object = plainToInstance(metadata.metatype, value)
    const errors = await validate(object)
    if (errors.length > 0) {
      throw new BadRequestException('Validation failed')
    }
    return value
  }
}
```

`metadata.metatype`å…¶å®å°±æ˜¯è¿™ä¸ªï¼š

![image-20231116230453458](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202311162304510.png)

é€šè¿‡ class-transformer çš„ `plainToInstance`æ–¹æ³•å°†æ™®é€šå¯¹è±¡è½¬æ¢ä¸º dto class çš„å®ä¾‹å¯¹è±¡ã€‚

ä¹‹åè°ƒç”¨ class-validator åŒ…çš„ validate api å¯¹å®ƒåšéªŒè¯ã€‚å¦‚æœéªŒè¯ä¸é€šè¿‡ï¼Œå°±æŠ›ä¸€ä¸ªå¼‚å¸¸ã€‚

å†æ¬¡è¯·æ±‚ä¸€ä¸‹ï¼š

![image-20231116230728996](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202311162307052.png)

æˆ‘ä»¬è‡ªå·±å®ç°çš„ validationPipe å·²ç»ç”Ÿæ•ˆå•¦ã€‚

## å¯æ³¨å…¥ä¾èµ–çš„å…¨å±€ Pipe

è·Ÿ Interceptor ä¸€æ ·ï¼ŒPipe å¯ä»¥ä½¿ç”¨`useGlobalPipes`åšå…¨å±€çš„ Pipe ã€‚

```typescript
async function bootstrap() {
  const app = await NestFactory.create(AppModule)
  await app.useGlobalPipes(new MyValidationPipePipe())
  await app.listen(3000)
}
```

ä½†è¿™ç§æ–¹å¼æ— æ³•åœ¨ pipe å†…éƒ¨æ³¨å…¥ä¾èµ–ã€‚

ä½¿ç”¨ nest æä¾›çš„`APP_PIPE` token å¯ä»¥æŒ‡å®šå…¨å±€çš„ Pipeã€‚

```typescript
    {
      provide: 'pipe_config',
      useFactory() {
        return { env: 'dev' };
      },
    },
    {
      provide: APP_PIPE,
      useClass: MyValidationPipePipe,
    },
```

ç”¨è¿™ç§æ–¹å¼æ³¨å†Œçš„å…¨å±€ Pipe èƒ½å¤Ÿæ³¨å…¥ä¾èµ–ï¼š

```typescript
@Injectable()
export class MyValidationPipePipe implements PipeTransform {
  @Inject('pipe_config')
  private readonly pipeConfig: any
  async transform(value: any, metadata: ArgumentMetadata) {
    console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” pipeConfig:', this.pipeConfig)
    const object = plainToInstance(metadata.metatype, value)
    const errors = await validate(object)
    if (errors.length > 0) {
      throw new BadRequestException('Validation failed')
    }
    return value
  }
}
```

## class-validator

class-validator æä¾›äº†å¾ˆå¤šä¾›éªŒè¯çš„è£…é¥°å™¨ã€‚

ä¾‹å¦‚ï¼š

```typescript
import { Contains, IsInt, Length, IsEmail, IsFQDN, IsDate, Min, Max, IsOptional } from 'class-validator'

export class Person {
  @Length(3)
  name: string
  @IsInt()
  @Min(0)
  age: number
  @IsOptional()
  @Contains('hello')
  text: string
  @IsEmail()
  email: string
  @IsFQDN()
  website: string
  @IsDate()
  birthday: Date
  @Max(3)
  height: number
}
```

å…¶ä¸­ @IsFQDN æ˜¯æ˜¯å¦æ˜¯åŸŸåçš„æ„æ€ã€‚@IsOptional å¯ä»¥è®©è¯¥å­—æ®µå˜å¾—å¯é€‰ã€‚

å¦‚æœå‚æ•°ä¸æ­£ç¡®ï¼Œåˆ™ä¼šæœ‰æŠ¥é”™ä¿¡æ¯ï¼š

![image-20231117103934229](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202311171039320.png)

é”™è¯¯æ¶ˆæ¯ä¹Ÿæ˜¯å¯ä»¥å®šåˆ¶çš„ï¼š

```typescript
  @Length(3, 10, {
    message: 'nameé•¿åº¦ä¸ç¬¦åˆè¦æ±‚',
  })
  name: string;
  @IsInt({
    message: (arg) => `ageå¿…é¡»æ˜¯æ•´æ•°,å½“å‰ä¸º${typeof arg.value}`,
  })
```

![image-20231117104435757](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202311171044815.png)

## æ€»ç»“

å€ŸåŠ© Pipeï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å‚æ•°åšæ ¡éªŒã€‚

Nest æä¾›äº†å¾ˆå¤šå†…ç½®çš„ Pipeï¼Œä¾‹å¦‚ ParseIntPipeã€ParseUUIDPipe ç­‰ã€‚

```typescript
  @Get()
  getHello(
    @Query('id', ParseUUIDPipe) id: string,
    @Query('age', ParseIntPipe) age: number,
  )
```

ç”¨å¾—æœ€å¤šçš„æ˜¯ validationPipeï¼ŒéªŒè¯ Post è¯·æ±‚çš„å‚æ•°éå¸¸æ–¹ä¾¿ã€‚

å®ƒçš„å®ç°åŸç†æ˜¯åŸºäº class-tranformer æŠŠå‚æ•°å¯¹è±¡è½¬æ¢ä¸º dto class çš„å¯¹è±¡ï¼Œç„¶åé€šè¿‡ class-validator åŸºäºè£…é¥°å™¨å¯¹è¿™ä¸ªå¯¹è±¡åšéªŒè¯ã€‚

å¦‚æœæ˜¯å…¨å±€ pipe æƒ³æ³¨å…¥ä¾èµ–ï¼Œéœ€è¦é€šè¿‡ APP_PIPE çš„ token åœ¨ AppModule é‡Œå£°æ˜ providerã€‚
