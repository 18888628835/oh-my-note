# JSON Web Token

HTTP æ˜¯ä¸€ç§æ— çŠ¶æ€çš„é€šä¿¡åè®®ï¼Œæ‰€è°“æ— çŠ¶æ€ï¼Œå°±æ˜¯æœåŠ¡å™¨ä¸èƒ½é€šè¿‡å®ƒåˆ¤æ–­ä¸¤æ¬¡å‘è¯·æ±‚è¿‡æ¥çš„æ˜¯ä¸æ˜¯åŒä¸€ä¸ªç”¨æˆ·ã€‚å¥½åœ¨å®ƒå¯ä»¥æ‰©å±•ï¼Œé€šè¿‡æ‰©å±•ï¼Œå¯ä»¥åˆ†è¾¨å‡ºæ˜¯åŒä¸€ä¸ªç”¨æˆ·åœ¨è®¿é—®ç½‘ç«™ã€‚

æ¯”å¦‚ï¼š

ç”¨æˆ·éœ€è¦ç™»å½•åæ‰èƒ½åœ¨æ·˜å®ä¸Šè´­ä¹°å•†å“ï¼Œè¿™æ ·æœåŠ¡å™¨æ‰èƒ½çŸ¥é“è´­ä¹°å•†å“çš„äººæ˜¯è°ï¼Œåœ°å€æ˜¯å“ªé‡Œã€‚

å½“ç”¨æˆ·å°†æŸå•†å“åŠ å…¥è´­ç‰©è½¦æ—¶ï¼Œä¹Ÿä¼šå°†è¯·æ±‚å‘é€ç»™æœåŠ¡å™¨ï¼Œè€ŒæœåŠ¡å™¨åˆ™éœ€è¦é€šè¿‡ä¸Šæ¬¡ç”¨æˆ·ç™»å½•çš„è®°å¿†çŸ¥é“å‘è¯·æ±‚çš„äººæ˜¯è°ï¼Œè¿™æ ·æ‰èƒ½å°†ä¿¡æ¯æ¨åˆ°å¯¹åº”äººçš„è´­ç‰©è½¦ä¸Šã€‚

é‚£ä¹ˆï¼Œè¿™é‡Œçš„è®°å¿†åœ¨ä»¥å‰æ˜¯æŒ‡ cookieã€‚

å®ƒçš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š

- ç”¨æˆ·å‘æœåŠ¡å™¨å‘é€è´¦å·å’Œå¯†ç ã€‚
- æœåŠ¡å™¨éªŒè¯é€šè¿‡åï¼Œåœ¨å½“å‰å¯¹è¯(session)é‡Œé¢ä¿å­˜ç›¸å…³çš„æ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·è§’è‰²ï¼Œç™»å½•æ—¶é—´ç­‰ã€‚
- æœåŠ¡å™¨å‘ç”¨æˆ·è¿”å›ä¸€ä¸ª session_idï¼Œå†™å…¥ç”¨æˆ·çš„ Cookieã€‚
- ç”¨æˆ·éšåçš„æ¯ä¸€æ¬¡è¯·æ±‚ï¼Œéƒ½ä¼šé€šè¿‡ Cookieï¼Œå°† session_id ä¼ å›æœåŠ¡å™¨ã€‚
- æœåŠ¡å™¨æ”¶åˆ° session_idï¼Œå¾—çŸ¥ç”¨æˆ·çš„èº«ä»½ï¼Œå°±å¯ä»¥çŸ¥é“è¿™æ˜¯åŒä¸€ä¸ªç”¨æˆ·ã€‚

è¿™ç§æ¨¡å¼çš„ç¼ºç‚¹åœ¨äºæ‰©å±•æ€§ä¸è¶³ã€‚æ¯”å¦‚å½“ç”¨æˆ·ç™»å½•åŒä¸€å®¶å…¬å¸çš„ä¸åŒç½‘ç«™éƒ½éœ€è¦ç”¨æˆ·ä¿¡æ¯æ—¶ï¼Œsession æ•°æ® å°±éœ€è¦å…±äº«ï¼Œè®©æ¯å°æœåŠ¡å™¨éƒ½èƒ½è¯»å– sessionã€‚

å…±äº«çš„æ–¹æ³•æ˜¯è®© session æ•°æ®æŒä¹…åŒ–ï¼Œå†™å…¥æ•°æ®åº“æˆ–è€…åˆ«çš„æŒä¹…å±‚ã€‚è™½ç„¶è¿™ç§æ–¹æ³•æ¶æ„æ¸…æ™°ï¼Œä½†ä¹Ÿå·¥ç¨‹é‡å·¨å¤§ï¼Œè€Œä¸”æŒä¹…å±‚çš„ç¨³å®šæ€§è¦æ±‚é«˜ã€‚

ç”±äºä¸Šé¢çš„æ–¹æ³•ç¼ºç‚¹æ˜æ˜¾ï¼Œæ‰€ä»¥å°±éœ€è¦å¦ä¸€ç§æ–¹æ³•ï¼š

ç›´æ¥æ”¾å¼ƒ session è¿™ç§æ–¹å¼ï¼Œè€Œæ˜¯åˆ©ç”¨æ–°çš„æ–¹æ¡ˆæ›¿ä»£åŸæ¥çš„ç™»å½•ä½“ç³»ï¼ŒJWT å°±æ˜¯æµè¡Œçš„æ–¹æ¡ˆã€‚

## JWT æ–¹æ¡ˆ

JWT å…¨ç§° `JSON Web Token`ï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯ JSON æ ¼å¼çš„ ç½‘ç»œä»¤ç‰Œã€‚å®ƒä¼šç›´æ¥å°†ç”¨æˆ·çš„ä¿¡æ¯ç”Ÿæˆä¸€ä¸ª `JSON`å¯¹è±¡ï¼Œå‘è¿˜ç»™ç”¨æˆ·ã€‚

æ¯”å¦‚å½“ç”¨æˆ·ç™»å½• åï¼ŒæœåŠ¡å™¨ç»è¿‡è®¤è¯ï¼Œå‘ç°ä»–çš„ä¿¡æ¯æ˜¯è¿™æ ·çš„

```json
{
  "username": "qiuyanxi",
  "role": "admin",
  "time": "2021-07-06"
}
```

æœåŠ¡å™¨ä¼šæŠŠè¿™æ¡æ•°æ®è¿”å›ç»™ç”¨æˆ·ï¼Œå½“ç”¨æˆ·æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œéƒ½ä¼šå¸¦ä¸Šè¿™æ¡æ•°æ®ï¼ŒæœåŠ¡å™¨å°±å¯ä»¥é€šè¿‡è¿™æ¡æ•°æ®ä¸Šçš„å†…å®¹åˆ¤å®šç”¨æˆ·èº«ä»½ã€‚

è¿™æ ·çš„è¯æœåŠ¡å™¨è·Ÿå®¢æˆ·ç«¯çš„é€šä¿¡åˆä¼šå˜æˆæ— çŠ¶æ€çš„äº†ã€‚

ä¸è¿‡ç”±äºç›´æ¥è¿™æ ·ä¼ ä¼šä¸å®‰å…¨ï¼Œæ‰€ä»¥ JWT ä¼šå°†æ•´ä¸ªä¿¡æ¯ç»è¿‡åŠ å¯†å¤„ç†ï¼Œè½¬åŒ–æˆå­—ç¬¦ä¸²çš„å½¢å¼ã€‚

### JWT é•¿ä»€ä¹ˆæ ·

æ•´ä¸ª JWT å¤§æ¦‚æ˜¯è¿™æ ·çš„

![img](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202401282002663.jpg)

å®ƒæ˜¯ä¸€ä¸²å¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œä¸­é—´ç”¨`.`åˆ†å‰²æˆä¸‰ä¸ªéƒ¨åˆ†:

- Header(å¤´éƒ¨)
- Payloadï¼ˆè´Ÿè½½ï¼‰
- Signatureï¼ˆç­¾åï¼‰

![img](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202401282003264.jpg)

### Header

Header éƒ¨åˆ†æ˜¯ JSON å¯¹è±¡ï¼Œæè¿° JWT çš„å…ƒæ•°æ®ï¼Œé€šå¸¸é•¿è¿™æ ·

```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

alg å±æ€§è¡¨ç¤ºç­¾åçš„ç®—æ³•ï¼Œtyp å±æ€§è¡¨ç¤ºä»¤ç‰Œçš„ç±»å‹ã€‚

ä¸Šé¢çš„ JSON å¯¹è±¡ä¼šé€šè¿‡ Base64URL ç®—æ³•è½¬åŒ–æˆå­—ç¬¦ä¸²ã€‚

### Payload

Payload éƒ¨åˆ†ä¹Ÿæ˜¯ JSON å¯¹è±¡ï¼Œç”¨æ¥å­˜æ”¾å®é™…éœ€è¦ä¼ é€’çš„æ•°æ®ï¼ŒJWT é¢„è®¾äº†ä»¥ä¸‹å®˜æ–¹å­—æ®µï¼š

- iss (issuer)ï¼šç­¾å‘äºº
- exp (expiration time)ï¼šè¿‡æœŸæ—¶é—´
- sub (subject)ï¼šä¸»é¢˜
- aud (audience)ï¼šå—ä¼—
- nbf (Not Before)ï¼šç”Ÿæ•ˆæ—¶é—´
- iat (Issued At)ï¼šç­¾å‘æ—¶é—´
- jti (JWT ID)ï¼šç¼–å·

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å®šä¹‰ç§æœ‰å­—æ®µï¼Œæ¯”å¦‚è¿™æ ·

```json
{
  "sub": "1234567890",
  "name": "John Doe",
  "admin": true
}
```

æ³¨æ„ï¼ŒJWT é»˜è®¤æ˜¯ä¸åŠ å¯†çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥è¯»åˆ°ï¼Œæ‰€ä»¥ä¸è¦æŠŠç§˜å¯†ä¿¡æ¯æ”¾åœ¨è¿™ä¸ªéƒ¨åˆ†ã€‚

è¿™ä¸ª JSON å¯¹è±¡ä¹Ÿè¦ä½¿ç”¨ Base64URL ç®—æ³•è½¬æˆå­—ç¬¦ä¸²ã€‚

### Signature

Signature éƒ¨åˆ†æ˜¯å¯¹å‰ä¸¤éƒ¨åˆ†çš„ç­¾åï¼Œé˜²æ­¢æ•°æ®ç¯¡æ”¹ã€‚

é¦–å…ˆï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªå¯†é’¥ï¼Œè¿™ä¸ªå¯†é’¥åªæœ‰æœåŠ¡å™¨çŸ¥é“ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆä¸€æ®µéšæœºçš„å¯†é’¥ï¼š

```bash
openssl rand -base64 32
```

ç„¶åé€šè¿‡ Header é‡Œé¢çš„ç­¾åç®—æ³•ï¼ˆé»˜è®¤æ˜¯ HMAC SHA256ï¼‰ï¼ŒæŒ‰ç…§ä¸‹é¢çš„å…¬å¼äº§ç”Ÿç­¾åã€‚

```javascript
HMACSHA256(base64UrlEncode(header) + '.' + base64UrlEncode(payload), secret)
```

è®¡ç®—å‡ºç­¾ååï¼Œå°† Headerã€Payloadã€Signature ä¸‰ä¸ªéƒ¨åˆ†æ‹¼æ¥æˆå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªéƒ¨åˆ†ç”¨`.`éš”å¼€ï¼Œè¿”å›ç»™ç”¨æˆ·ã€‚

### Base64URL

Header å’Œ Payload ä¸²å‹åŒ–çš„ç®—æ³•æ˜¯ Base64URLã€‚è¿™ä¸ªç®—æ³•è·Ÿ Base64 ç®—æ³•åŸºæœ¬ç±»ä¼¼ï¼Œä½†æœ‰ä¸€äº›å°çš„ä¸åŒã€‚

JWT ä½œä¸ºä¸€ä¸ªä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œæœ‰äº›åœºåˆå¯èƒ½ä¼šæ”¾åˆ° URLï¼ˆæ¯”å¦‚ api.example.com/?token=xxxï¼‰ã€‚Base64 æœ‰ä¸‰ä¸ªå­—ç¬¦`+`ã€`/`å’Œ`=`ï¼Œåœ¨ URL é‡Œé¢æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œæ‰€ä»¥è¦è¢«æ›¿æ¢æ‰ï¼š`=`è¢«çœç•¥ã€`+`æ›¿æ¢æˆ`-`ï¼Œ`/`æ›¿æ¢æˆ`_` ã€‚è¿™å°±æ˜¯ Base64URL ç®—æ³•ã€‚

## Nodejs å®ç° JWT

ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ koa å®ç° JWTï¼Œç†è§£æ•´ä¸ªè¿‡ç¨‹ã€‚é¦–å…ˆæˆ‘ä¼šåœ¨ç™»å½•ç•Œé¢å‘é€è¯·æ±‚ï¼Œå¹¶é™„ä¸Šè´¦å·å¯†ç ã€‚

ç„¶åä½¿ç”¨ koa å®ç°ä¸€ä¸ªç®€æ˜“çš„ web æœåŠ¡ç«¯ï¼Œæ¥æ¥æ”¶è¿™ä¸ªè¯·æ±‚ï¼Œå¹¶è¿”å› JWTã€‚

```javascript
//server.js
import Koa from 'koa'
const Router = require('koa-router')
let bodyparser = require('koa-bodyparser')
const jwt = require('jsonwebtoken') //é€šè¿‡è¿™ä¸ªåº“æ¥ç”Ÿæˆ jwt
const app = new Koa()
const router = new Router()
app.use(bodyparser())

//ç™»å½•éªŒè¯
router.post('/login', async (ctx, next) => {
  const { username, password } = ctx.request.body
  if (username === 'admin' && password === 'admin') {
    //ç”Ÿæˆ jwtç­¾åï¼Œssh æ˜¯å¯†é’¥
    const token = jwt.sign({ username, exp: Math.floor(Date.now() / 1000) + 60 * 60 }, 'ssh')
    ctx.body = {
      code: 200,
      success: true,
      data: true,
      username,
      token,
    }
  } else {
    ctx.body = { code: 403 }
  }
})
// éªŒè¯æ˜¯å¦æœ‰æƒé™
router.get('/validate', async (ctx) => {
  let Authorization = ctx.get('authorization')
  let [, token] = Authorization.split(' ')
  if (token) {
    try {
      let r = jwt.verify(token, 'ssh') //æ ¸å® token
      console.log(r)
      ctx.body = {
        code: 200,
        username: r.username,
        token,
      }
    } catch (e) {
      ctx.status = 401
      ctx.body = {
        code: 401,
        data: 'æ²¡æœ‰ç™»é™†',
      }
    }
  } else {
    ctx.status = 403
    ctx.body = { message: 'ä½ æ— æ­¤æƒé™' }
  }
})

app.use(router.routes()).use(router.allowedMethods())
app.listen(3000) //ç›‘å¬3000ç«¯å£
```

ä¸Šé¢çš„ä»£ç ä¸­ä½¿ç”¨äº† [jsonwebtoken](https://github.com/auth0/node-jsonwebtoken)æ¥å®ç°ä»¤ç‰Œçš„ç”Ÿæˆ

```javascript
const token = jwt.sign({ username, exp: Math.floor(Date.now() / 1000) + 60 * 60 }, 'ssh')
```

ç”Ÿæˆåè¿”å›ç»™å®¢æˆ·ç«¯çš„æ•°æ®æ˜¯è¿™æ ·å­çš„

```JavaScript
code: 200
data: true
success: true
token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiZXhwIjoxNjI1NzUzODEzLCJpYXQiOjE2MjU3NTAyMTN9.RCCTU-KwuhmW7exexsx9WXtp2i0ec-ARSBCGIOdn_r0"
username: "admin"
```

å½“ç”¨æˆ·ç™»å½•æ—¶ï¼Œè¿˜ä¼šè¿›è¡Œä¸€å±‚æƒé™æ ¡éªŒï¼Œè¿™æ—¶å€™å®¢æˆ·ç«¯éœ€è¦å‘é€ç»™æœåŠ¡å™¨è·å–åˆ°çš„ tokenã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œtoken ä¼šå­˜åˆ°æŸä¸ª store ä¸­ï¼Œç”±å‰ç«¯å°†å…¶åŠ å…¥åˆ°è¯·æ±‚å¤´çš„`Authorization`ä¸­

```typescript
/** è·å–å½“å‰çš„ç”¨æˆ· GET /api/currentUser */
export async function currentUser(options?: { [key: string]: any }) {
  return request<API.CurrentUser>('/api/validate', {
    method: 'GET',
    headers: {
      Authorization: `Bear ${localStorage.getItem('access-token')}`,
    },
    ...(options || {}),
  })
}
```

å½“æœåŠ¡å™¨æ”¶åˆ°åï¼Œä¼šç»è¿‡å¯†é’¥è§£ç ï¼Œå–å‡ºå…¶ä¸­çš„æ•°æ®

```JavaScript
      let r = jwt.verify(token, "ssh"); //æ ¸å® token
      console.log(r);//{ username: 'admin', exp: 1625753813, iat: 1625750213 }
```

exp æ˜¯è¿‡æœŸæ—¶é—´ï¼Œè€Œ iat æ˜¯ç­¾å‘æ—¶é—´ï¼Œusername æ˜¯åœ¨ç”Ÿæˆä»¤ç‰Œæ—¶ä¼ å…¥çš„ç”¨æˆ·ä¿¡æ¯ã€‚

æ•´ä¸ªè¿‡ç¨‹å¤§è‡´å°±æ˜¯å¦‚æ­¤ã€‚

## Nest.js å®ç° JWT

åœ¨ Nest ä¸­ä½¿ç”¨ jwt éœ€è¦å¼•å…¥ @nestjs/jwt è¿™ä¸ªåŒ…

```bash
pnpm install @nestjs/jwt
```

ç„¶ååœ¨ AppModule é‡Œå¼•å…¥ JwtModuleï¼š

```typescript
import { Module } from '@nestjs/common'
import { JwtModule } from '@nestjs/jwt'
import { AppController } from './app.controller'
import { AppService } from './app.service'

@Module({
  imports: [
    JwtModule.register({
      secret: 'secret',
      signOptions: {
        expiresIn: '7d',
      },
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

JwtModule æ˜¯ä¸€ä¸ªåŠ¨æ€æ¨¡å—ï¼Œé€šè¿‡ register ä¼ å…¥ optionã€‚

ç„¶ååœ¨ controller é‡Œæ³¨å…¥ JwtModule é‡Œçš„ JwtServiceï¼š

```typescript
import { Controller, Get, Inject } from '@nestjs/common'
import { AppService } from './app.service'
import { JwtService } from '@nestjs/jwt'

@Controller()
export class AppController {
  constructor(
    private readonly appService: AppService,
    @Inject(JwtService)
    private readonly jwtService: JwtService,
  ) {}

  @Get('/token')
  async getToken() {
    const newToken = await this.jwtService.sign({ name: 'John' })

    return { accessToken: newToken }
  }

  @Get('/verify')
  async verifyToken(@Headers('authorization') authorization: string) {
    const token = authorization.replace('Bearer ', '')
    try {
      const result = this.jwtService.verify(token)
      console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” verifyToken â€”â€” result:', result)
      return result
    } catch (error) {
      throw new UnauthorizedException()
    }
  }
}
```

ç°åœ¨è®¿é—®`http://localhost:3000/token`,å°±å¯ä»¥æ‹¿åˆ° token äº†ã€‚

![image-20240128204506836](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202401282045924.png)

è¿”å› token æ—¶å¯ä»¥å°†å®ƒæ”¾åˆ°ä»»æ„åœ°æ–¹ï¼Œ`body`ã€`header`ç­‰éƒ½æ˜¯å¯ä»¥çš„ã€‚

å‰ç«¯æ‹¿åˆ° token åï¼Œå°†å…¶ä»¥`Bearer <token>`çš„å½¢å¼æ”¾åˆ°`Authorization`å­—æ®µä¸­é€šè¿‡è¯·æ±‚å›ä¼ ç»™æœåŠ¡ç«¯åšéªŒè¯ã€‚

æˆ‘ä»¬ç”¨ postman æµ‹è¯•ä¸€ä¸‹ï¼š

![image-20240128205941721](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202401282059759.png)éªŒè¯æˆåŠŸï¼Œæ‹¿åˆ°ç”¨æˆ·çš„ä¿¡æ¯äº†ã€‚

å¦‚æœä¼ ä¸€ä¸ªé”™çš„ token ä¼šæ ¡éªŒå¤±è´¥ï¼Œå¹¶ä¸”è¿”å›é”™è¯¯ä¿¡æ¯ï¼š

![image-20240128210101669](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202401282101753.png)

åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œå°±åŸºæœ¬å®ç°äº†åœ¨ Nestjs ä¸­ä½¿ç”¨ JWT åšèº«ä»½éªŒè¯ ï¼ˆAuthentication ï¼‰ã€‚

æ˜¯ä¸æ˜¯æ¯” session+redis çš„æ–¹æ¡ˆæ›´ç®€å•ï¼Ÿ

## æ€»ç»“

- JWT æ–¹æ¡ˆå¯ä»¥è®©æœåŠ¡å™¨é‡æ–°å›åˆ°æ— çŠ¶æ€çš„æƒ…å†µã€‚
- JWT æœ¬èº«åŒ…å«äº†è®¤è¯ä¿¡æ¯ï¼Œä¸€æ—¦æ³„éœ²ï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å¾—è¯¥ä»¤ç‰Œçš„æ‰€æœ‰æƒé™ã€‚ä¸ºäº†å‡å°‘ç›—ç”¨ï¼ŒJWT çš„æœ‰æ•ˆæœŸåº”è¯¥è®¾ç½®å¾—æ¯”è¾ƒçŸ­ã€‚å¯¹äºä¸€äº›æ¯”è¾ƒé‡è¦çš„æƒé™ï¼Œä½¿ç”¨æ—¶åº”è¯¥å†æ¬¡å¯¹ç”¨æˆ·è¿›è¡Œè®¤è¯ã€‚
- æœ€å¥½ä¸è¦å°†éå¸¸é‡è¦çš„ä¿¡æ¯å†™å…¥ token ä¸­ã€‚

[ä»£ç ç¤ºä¾‹](https://github.com/18888628835/learn-nest/tree/how-to-use-jwt)

## å‚è€ƒ

- [Learn how to use JSON Web Tokens](https://github.com/dwyl/learn-json-web-tokens/blob/master/README.md), by dwyl
- [JSON Web Token å…¥é—¨æ•™ç¨‹- é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿—](http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html)

enjoyï¼ï¼
