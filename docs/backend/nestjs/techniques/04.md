# ä½¿ç”¨é˜Ÿåˆ—

é˜Ÿåˆ—ï¼ˆQueueï¼‰åœ¨åç«¯å¼€å‘ä¸­æœ‰å¾ˆå¤šç”¨é€”ï¼Œä¸»è¦ç›®çš„æ˜¯æé«˜ç³»ç»Ÿçš„ä¼¸ç¼©æ€§å’Œè§£å†³ä¸€äº›æ€§èƒ½æŒ‘æˆ˜ã€‚

æœ‰å¾ˆå¤šä¾‹å­å¯ä»¥ç”¨åˆ°é˜Ÿåˆ—ï¼š

1. å¹³æ»‘å¤„ç†ç‰¹åˆ«æ¶ˆè€—æ€§èƒ½çš„ä»»åŠ¡ã€‚

   æ¯”å¦‚ä¸€äº›å ç”¨æ€§èƒ½çš„ä»»åŠ¡ã€‚å¯ä»¥å°†è¿™äº›ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œè€Œä¸æ˜¯åŒæ­¥æ‰§è¡Œå®ƒä»¬ï¼Œå†ä»¥å—æ§çš„æ–¹å¼ä»é˜Ÿåˆ—ä¸­æå–å‡ºä»»åŠ¡å¹¶äº¤ç»™ä»»åŠ¡æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰å¤„ç†ã€‚

2. æ‹†åˆ†å¯èƒ½ä¼šé˜»å¡ Node.js äº‹ä»¶å¾ªç¯çš„åºå¤§ä»»åŠ¡ã€‚ä¾‹å¦‚è§£ç è½¬ç è¿™æ ·çš„ CPU å¯†é›†å‹ä»»åŠ¡ï¼Œå¯ä»¥äº¤ç»™é˜Ÿåˆ—æ¥å¤„ç†é‡Šæ”¾ä¸»è¿›ç¨‹çš„å‹åŠ›ã€‚

3. ä¸ºä¸åŒæœåŠ¡ä¹‹é—´æä¾›é€šä¿¡ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­å°†ä»»åŠ¡æ’å…¥é˜Ÿåˆ—ï¼Œç„¶åå†åœ¨å¦å¤–ä¸€ä¸ªè¿›ç¨‹æˆ–æœåŠ¡ä¸­æ¶ˆè´¹å®ƒä»¬ã€‚è¿˜å¯ä»¥ç›‘å¬çŠ¶æ€äº‹ä»¶æ¥å¾—çŸ¥ä½œä¸šçš„ç”Ÿå‘½å‘¨æœŸï¼Œä»¥åŠå®Œæˆæƒ…å†µã€‚å¦‚æœä»»åŠ¡å¤±è´¥ï¼Œè¿˜å¯ä»¥é‡æ–°å¯åŠ¨ã€‚

åœ¨ Nodejs ä¸­ï¼ŒBull æ˜¯å¯ä»¥æä¾›é«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„é˜Ÿåˆ—å®ç°åº“ã€‚Nest å¯¹å®ƒåšäº†ä¸€å±‚å°è£…ï¼Œæä¾›äº†`@nestjs/bull` åŒ…ã€‚

## å®‰è£…å’Œä½¿ç”¨

```bash
pnpm install --save @nestjs/bull bull
```

åœ¨ AppModule ä¸­é…ç½®ï¼š

```typescript
import { Module } from '@nestjs/common'
import { BullModule } from '@nestjs/bull'

@Module({
  imports: [
    BullModule.forRoot({
      redis: {
        host: 'localhost',
        port: 6379,
      },
    }),
  ],
})
export class AppModule {}
```

è¿™ä¸€æ­¥ä¸»è¦æ˜¯é…ç½® redis çš„ä¿¡æ¯ã€‚

Bull æ˜¯ç”¨ Redis ä¿å­˜ job æ•°æ®çš„ï¼Œæ‰€ä»¥å¼€å¯ Redis æ˜¯å‰ææ¡ä»¶ã€‚

é˜Ÿåˆ—ä»»åŠ¡ç›¸å¯¹äºæ•´ä¸ªç³»ç»Ÿè€Œè¨€æ˜¯ä¸€ä¸ªéå¸¸ç‹¬ç«‹çš„åŠŸèƒ½ï¼Œæ¯”è¾ƒå¥½çš„å®ç°æ˜¯å°†å®ƒå°è£…æˆä¸€ä¸ªåŠ¨æ€ Module æ¥ä½¿ç”¨ã€‚

```bash
nest generate module nestBull --no-spec
```

æ¥ç€å®ç°åŠ¨æ€ module çš„ register æ–¹æ³•ï¼š

```typescript
import { BullModule } from '@nestjs/bull'
import { DynamicModule, Module, Provider } from '@nestjs/common'

@Module({})
export class NestBullModule {
  static register(queueName: string, consumer: Provider): DynamicModule {
    const testQueue = BullModule.registerQueue({
      name: queueName,
    })

    return {
      module: NestBullModule,
      imports: [testQueue],
      providers: [consumer, ...testQueue.providers],
      exports: [consumer, ...testQueue.exports],
    }
  }
}
```

`register` æ–¹æ³•ä¼šåŠ¨æ€è¿”å›æ•´ä¸ª `Module`ã€‚

å“ªä¸ªæ¨¡å—æƒ³ç”¨ `Queue` åŠŸèƒ½ï¼Œç›´æ¥è°ƒç”¨ `register` æ³¨å†Œä¸€ä¸‹ï¼Œä¼ å…¥`queueName` ä»¥åŠ `consumer` å³å¯ã€‚

æ³¨æ„è¿™ä¸ªä»£ç ï¼š

```typescript
      providers: [consumer, ...testQueue.providers],
      exports: [consumer, ...testQueue.exports],
```

`BullModule.registerQueue`æ–¹æ³•ä¼šè¿”å› `providers` å±æ€§å’Œ `exports` å±æ€§ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™äº›å±æ€§ï¼š

![image-20231202201228614](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202312022012155.png)

å¯ä»¥çœ‹åˆ°è¿”å›çš„æ˜¯åŠ¨æ€çš„ `provider` ä»¥åŠå®ƒçš„ `token`ã€‚

æŠŠå®ƒä»¬ä»æ¨¡å—å¯¼å‡ºåå°±å¯ä»¥è¢«å…¶ä»–æ¨¡å—çš„ `handler` æ³¨å…¥äº†ã€‚

è‡³äº `consumer`ï¼Œè¿™æ˜¯ä¸€ä¸ª `class`ï¼Œç”¨æ¥æ¶ˆè´¹ `QUEUE` çš„ä»»åŠ¡ä»¥åŠå®ç°ä¸€äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚

è¿™é‡Œå°±åšä¸€ä¸ªæœ€ç®€å•çš„å®ç°ï¼š

```typescript
import { Processor, Process } from '@nestjs/bull'
import { Job } from 'bull'

@Processor('test')
export class TestConsumer {
  @Process('doSomething')
  async handle(job: Job) {
    console.log('Job Start')
    console.log('data', job.data)
  }
}
```

- `@Processor(QUEUE_NAME) `è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª Bull çš„ Processorï¼Œé˜Ÿåˆ—åä¸ºï¼štest
- `@Process('doSomething')` è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå« doSomething çš„é˜Ÿåˆ—å¤„ç†æ–¹æ³•ã€‚`@Process` è£…é¥°å™¨æ˜¯å¿…é¡»çš„ï¼Œé˜Ÿåˆ—å¼€å§‹æ—¶ä¼šè°ƒç”¨å®ƒè£…é¥°çš„æ–¹æ³•ã€‚
- `doSomething`æ˜¯å¯ç¼ºçœçš„ï¼Œå› ä¸ºä¸€ä¸ªé˜Ÿåˆ—æœ‰å¯èƒ½æœ‰å¤šç§å¤„ç†æ–¹æ³•ï¼Œä¹Ÿå¯èƒ½åªæœ‰ä¸€ä¸ªé»˜è®¤çš„ï¼Œè¿™äº›éƒ½è¦åœ¨æ´¾å‘é˜Ÿåˆ—ä»»åŠ¡æ—¶æŒ‡å®šã€‚

ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªå¯ä»¥æ³¨å…¥å…¶ä»–æ¨¡å—çš„ **BullModule**ï¼Œå¹¶ä¸”å·²ç»å†™å¥½äº†**Consumer**ã€‚

æ¥ç€å°è¯•åœ¨ **appModule** ä¸­æ³¨å†Œè¯¥é˜Ÿåˆ—ã€‚

```typescript
import { Module } from '@nestjs/common'
import { AppController } from './app.controller'
import { AppService } from './app.service'
import { BullModule } from '@nestjs/bull'
import { NestBullModule } from './nest-bull/nest-bull.module'
import { TestConsumer } from './test-consumer/test-consumer'

@Module({
  imports: [
    BullModule.forRoot({
      redis: {
        host: 'localhost',
        port: 6379,
      },
    }),
    NestBullModule.register('test', TestConsumer),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

æ³¨å†Œæ—¶æä¾›**é˜Ÿåˆ—å**ä»¥åŠ **Consumer** å¯¹è±¡ã€‚

æ¥ç€åœ¨ appService ä¸­æ³¨å…¥è¯¥ Queue å¹¶å¾€é˜Ÿåˆ—ä¸­åŠ ä¸€ä¸ªä»»åŠ¡è¯•è¯•ã€‚

```typescript
import { InjectQueue } from '@nestjs/bull'
import { Injectable } from '@nestjs/common'
import { Queue } from 'bull'

@Injectable()
export class AppService {
  constructor(
    @InjectQueue('test')
    private readonly testQueue: Queue,
  ) {}

  async getHello(): Promise<string> {
    const queue = await this.testQueue.add('doSomething', { foo: 'bar' })
    console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” getHello â€”â€” queue.id:', queue.id)
    return 'Hello World!'
  }
}
```

`@InjectQueue` è£…é¥°å™¨æ˜¯ç”¨æ¥æ³¨å…¥æˆ‘ä»¬å†™å¥½çš„é˜Ÿåˆ—çš„ã€‚

è°ƒç”¨ `add` æ–¹æ³•å¯ä»¥å¾€é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®ã€‚

è¿™é‡Œçš„ç¬¬ä¸€ä¸ªå‚æ•°`doSomething`æ˜¯æŒ‡å®šç”¨ä»€ä¹ˆæ–¹æ³•è¿›è¡Œæ¶ˆè´¹çš„ï¼Œå¯¹åº” Consumer ä¸­çš„`@Process('doSomething')`ã€‚

ç°åœ¨æ‰“å¼€`localhost:3000`è°ƒè¯•ä¸€ä¸‹ï¼š

![image-20231202204219801](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202312022042870.png)

å¯ä»¥çœ‹åˆ°é˜Ÿåˆ—ä»»åŠ¡å·²ç»è¢« `Consumer` æ¶ˆè´¹äº†ã€‚

åŒæ—¶ add æ–¹æ³•è¿˜æ”¯æŒæŒ‡å®šå»¶æ—¶å‡ºåˆ—æ—¶é—´ã€æŒ‡å®šå›ºå®šæ—¶é—´å‡ºåˆ—ç­‰åŠŸèƒ½ï¼š

```typescript
await this.testQueue.add(
  'doSomething',
  {
    foo: 'bar',
  },
  {
    delay: 1000,
  },
)
```

åœ¨ `consumer` ä¸­æŒ‡å®šç”Ÿå‘½å‘¨æœŸå¯ä»¥çœ‹åˆ° job çš„æ‰§è¡Œæƒ…å†µï¼š

```typescript
import { Processor, Process, OnQueueActive, OnQueueCompleted } from '@nestjs/bull'
import { Job } from 'bull'

@Processor('test')
export class TestConsumer {
  @Process('doSomething')
  async handle(job: Job) {
    console.log('Job Start')
    console.log('data', job.data)
  }

  // è¿›è¡Œä¸­
  @OnQueueActive()
  onActive(job: Job) {
    console.log(`Processing job ${job.id} of type ${job.name} with data ${job.data}...`)
  }
  // å®Œæˆ
  @OnQueueCompleted()
  onCompleted(job: Job) {
    console.log(`Completed job ${job.id} of type ${job.name} with data ${job.data}...`)
  }
}
```

![image-20231202205120559](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202312022051596.png)

è¿˜æœ‰æ§åˆ¶ job çš„ APIï¼š

```typescript
await this.testQueue.pause();
await this.testQueue.resume();
...
```

è¿™äº› API éƒ½å¯ä»¥åœ¨[Nest](https://docs.nestjs.com/techniques/queues) ä¸­ç¿»åˆ°ï¼ŒåŸºæœ¬ä¸Šæ¶µç›–äº†å¼€å‘æ‰€éœ€ã€‚

## æ­é… Bull-Board å¯è§†åŒ–ç•Œé¢

è™½ç„¶ Bull æä¾›äº† API å¯ä»¥ç”¨äºæŸ¥çœ‹ Job çš„æ‰§è¡Œæƒ…å†µï¼Œå¹¶ä¸”å¯ä»¥æ§åˆ¶ job çš„è¿è¡Œã€‚

ä½†æ˜¯ Job ä¸€æ—¦å¤šäº†ï¼Œåœ¨ç»ˆç«¯ä¸­æŸ¥çœ‹æ¯ä¸ª Job æ˜¾ç„¶æ˜¯ä¸€ä»¶å¤´ç–¼çš„äº‹æƒ…ï¼Œå³ä½¿åœ¨ä½¿ç”¨ winston ç­‰æ—¥å¿—å·¥å…·çš„æƒ…å†µä¸‹ã€‚

æœ‰æ²¡æœ‰ä¸€æ¬¾å·¥å…·èƒ½å¤ŸæŸ¥çœ‹åˆ° Bull ä¸­æ¯ä¸ª Job çš„è¿è¡Œæƒ…å†µï¼Œå¦‚æœæŸä¸ª Job è¿è¡Œå¤±è´¥ï¼Œæˆ‘è¿˜å¯ä»¥çœ‹åˆ°å¤±è´¥ä¿¡æ¯å¹¶ä¸”æ‰‹åŠ¨é‡æ–°æ‰§è¡Œå®ƒå‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚

`@bull-board/nestjs`è¿™ä¸ªåŒ…å°±æ˜¯ç¤¾åŒºæä¾›çš„ä¼˜ç§€ç•Œé¢æ“ä½œå·¥å…·ã€‚

ç›´æ¥ä¸‹è½½ï¼š

```bash
pnpm install --save @bull-board/nestjs @bull-board/api
```

å†ä¸‹è½½é€‚é…å™¨ï¼š

```bash
$ pnpm install --save @bull-board/express
//or
$ pnpm install --save @bull-board/fastify
```

åœ¨ `AppModule` ä¸­å¼•å…¥å¹¶æ³¨å†Œ **BullBoard**ï¼š

```typescript
import { Module } from '@nestjs/common'
import { AppController } from './app.controller'
import { AppService } from './app.service'
import { BullModule } from '@nestjs/bull'
import { NestBullModule } from './nest-bull/nest-bull.module'
import { TestConsumer } from './test-consumer/test-consumer'
import { BullBoardModule } from '@bull-board/nestjs'
import { ExpressAdapter } from '@bull-board/express'

@Module({
  imports: [
    BullModule.forRoot({
      redis: {
        host: 'localhost',
        port: 6379,
      },
    }),
    BullBoardModule.forRoot({
      route: '/bull/queues',
      adapter: ExpressAdapter,
    }),
    NestBullModule.register('test', TestConsumer),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

ç„¶ååœ¨`register`æ–¹æ³•ä¸­æŠŠ`board`ä¹Ÿæ³¨å†Œè¿›æ¥ã€‚

```typescript
import { BullBoardModule } from '@bull-board/nestjs'
import { BullAdapter } from '@bull-board/api/bullAdapter'
import { BullModule } from '@nestjs/bull'
import { DynamicModule, Module, Provider } from '@nestjs/common'

@Module({})
export class NestBullModule {
  static register(queueName: string, consumer: Provider): DynamicModule {
    const testQueue = BullModule.registerQueue({
      name: queueName,
    })
    const testBoard = BullBoardModule.forFeature({
      name: queueName,
      adapter: BullAdapter,
    })

    return {
      module: NestBullModule,
      imports: [testBoard, testQueue],
      providers: [consumer, ...testQueue.providers],
      exports: [consumer, ...testQueue.exports],
    }
  }
}
```

ç°åœ¨æ‰“å¼€`http://localhost:3000/bull/queues/`

![Dec-02-2023 21-14-17](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202312022114214.gif)

æ‰€æœ‰ Job çš„æ‰§è¡Œæƒ…å†µéƒ½ä¼šåœ¨è¯¥ç•Œé¢ä¸­å±•ç¤ºå‡ºæ¥ï¼Œæ˜¯ä¸æ˜¯ç‰¹åˆ«ç›´è§‚ï¼Ÿ

å¦‚æœæƒ³åœ¨ `process` ä¸­æ‰“ `log` æŸ¥çœ‹ä»£ç æ‰§è¡Œæƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨`job.log`æ–¹æ³•ã€‚

```typescript
  @Process('doSomething')
  async handle(job: Job) {
    await job.log('Job Start');
    await job.log(`data${job.data}`);
    return 'success';
  }
```

è¿™äº› `log` ä¹Ÿä¼šåœ¨ `board` çš„ `Logs` ä¸­å‡ºç°ã€‚

![image-20231202211958589](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202312022119660.png)

æ˜¯ä¸æ˜¯éå¸¸æ–¹ä¾¿å‘¢ï¼Ÿ

## æ€»ç»“

åç«¯å¼€å‘ä¸­å¾ˆå¤šå ç”¨èµ„æºçš„ä»»åŠ¡æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ **QUEUE** æ¥å¤„ç†ã€‚

**nodejs** ä¸­æ¯”è¾ƒæœ‰åçš„å®ç°æ˜¯ **bull.js** è¿™ä¸ªåº“ã€‚**nestjs** å¯¹å®ƒåšäº†ä¸€å±‚å°è£…ã€‚

ä½¿ç”¨ **@nestjs/bull** éå¸¸ç®€å•ï¼Œåœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œä»…ä»…åªæ˜¯ç”¨å®ƒå°è£…äº†ä¸€ä¸ªç‹¬ç«‹çš„ **Module**ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ­é… **bull-board** æ¥å¯è§†åŒ–æ‰€æœ‰ job çš„è¿è¡Œæƒ…å†µã€‚

[ä»£ç ç¤ºä¾‹](https://github.com/18888628835/learn-nest/tree/how-to-use-queues)
