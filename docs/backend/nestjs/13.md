# Nest 使用 prisma

## 初始化

```bash
pnpm install prisma -D
```

调用 prisma CLI

```bash
 npx prisma
```

初始化 prisma

```bash
npx prisma init
```

该命令会创建一个 prisma 文件夹并生成两个文件：

1.  `schema.prisma`文件：指定数据库连接并包含数据库信息的 schema

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
```

2. `.env`：包含数据库 credentials 等环境变量信息

   ```js
   DATABASE_URL = 'postgresql://johndoe:randompassword@localhost:5432/mydb?schema=public'
   ```

默认情况下 datasource provider 为 `postgresql`。如果是 mysql，则修改为 mysql。

然后是将账号密码以及本地数据库名填入 .env。

![image-20231018222945321](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310182229174.png)

再就是定义 database 的 schema 了，这个 schema 是一种 Model，抽象描述表数据结构模型：

```js
// schema.prisma
model User {
  id           String  @id @default(uuid())
  name         String
  age          String?
  phone_number String  @unique
  Post         Post[]
}

model Post {
  id        String  @id @default(uuid())
  title     String
  content   String?
  published Boolean @default(false)
  author    User    @relation(fields: [authorId], references: [id],onDelete: Cascade,onUpdate: Cascade)
  authorId  String
}
```

后面再解释 schema 里的含义。

最后执行 migrate 让 model 跟数据表同步：

```bash
npx prisma migrate dev --name user_post
```

此时生成 migrations 文件夹，里面包含了建表的一些 sql 文件以及版本信息，还有 lock 信息。

![image-20231018230201894](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310182302943.png)

prisma 帮助我们在数据库中已经创建好了两张表：

![image-20231018230404921](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310182304976.png)

多出来的`_prisma_migrations`表是记录版本信息的，比如这次创建两张表是一个版本，下次创建新的表又是一个新的版本。（由 prisma 内部使用，不要随意删除）

## 注入 prisma

在 src 目录下创建 prisma service：

```bash
nest generate service Prisma --no-spec
```

在 `prisma.service.ts` 文件中填入：

```ts
import { Injectable, OnModuleDestroy, OnModuleInit } from '@nestjs/common'
import { PrismaClient } from '@prisma/client'

@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit, OnModuleDestroy {
  constructor() {
    // 开启日志模式，查看数据库操作日志
    super({
      log: [
        { emit: 'stdout', level: 'query' },
        { emit: 'stdout', level: 'info' },
        { emit: 'stdout', level: 'warn' },
        { emit: 'stdout', level: 'error' },
      ],
    })
  }
  async onModuleInit() {
    await this.$connect()
  }
  async onModuleDestroy() {
    await this.$disconnect()
  }
}
```

注入 prisma.service 并且写一段插入数据和查询数据的代码：

```typescript
import { Controller, Get } from '@nestjs/common'
import { User } from '@prisma/client'
import { PrismaService } from './prisma/prisma.service'
@Controller()
export class AppController {
  constructor(private prisma: PrismaService) {}

  @Get('/all')
  async getUser(): Promise<User[]> {
    return await this.prisma.user.findMany()
  }
  @Get('/create')
  async createUser(): Promise<User> {
    return await this.prisma.user.create({
      data: { name: 'Alice', email: 'aaabbb@gmail.com' },
    })
  }
}
```

现在访问`http://localhost:3000/create` 会在 User 表中创建一条记录：

![image-20231018232954252](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310182329311.png)

访问`http://localhost:3000/all`查询所有：

![image-20231018233040990](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310182330028.png)

在创建 User 时，顺便加入几条 post 的代码：

```ts
  async createUser() {
    await this.prisma.user.create({
      data: {
        name: 'test',
        phone_number: '17342123321',
        Post: {
          create: [
            { title: 'test', content: 'test' },
            { title: 'test', content: 'test' },
          ],
        },
      },
    });
  }
```

这种写法的前提是在 schema 结构中已经把 User 和 Post 做了关联：

![image-20231022125604467](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310221256716.png)

调用`createUser`方法后，查看终端的 log 日志：

![image-20231022125758928](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310221257977.png)

可以看到 prisma 内部做了以下事情：

1. 开启了一个 transaction
2. 插入了 User 和 Post 的三条记录
3. 从 User 里查询记录（用于做返回值）
4. transaction 提交

## Prisma 全部命令

> 在上面的流程中，我们已经创建好了 User 和 Post 两张表，以及 prisma 相关的 migration、sql 代码等。
>
> 为了熟悉 Prisma，所以请将\_prisma_migrations 表、跟 Prisma 相关的代码手动删除，下面的文档中，我们将重复这一过程。

### prisma init

执行 `npx prisma init`会生成 schema 文件和 env 里的数据。

![image-20231022200957586](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222009659.png)

在执行 init 后会提示我们：

1. 在.env 里修改 database 的 url
2. 在 schema.prisma 中修改 provider 信息，指定用哪种数据库
3. 执行 `prisma db pull` 将数据库已有的结构同步到 Prisma schema 中
4. 执行`prisma generate`来生成 Prisma Client 代码

### prisma db pull

执行`npx prisma db pull`试试：

![image-20231022201457508](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222014555.png)

prisma 已经将我数据库里的表转化成数据模型，并在 schema.prisma 中写好了。

由于我的数据库中依然存在 User 和 Post 两张表，这次 `db pull` 之后会同步出跟以前差不多的代码：

```typescript
model Post {
  id        String  @id
  title     String
  content   String?
  published Boolean @default(false)
  authorId  String
  User      User    @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model User {
  id           String  @id
  name         String
  age          String?
  phone_number String  @unique
  Post         Post[]
}
```

如果有差别，手动修改一下即可。

除了`prisma db pull`外，还有几个命令：

![image-20231022202507403](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222025513.png)

### prisma db push

pull 是将数据库的表结构拉取到 schema.prisma 中。

那 push 就是将 schema.prisma 的结构同步到数据库中。

先删掉 User 和 Post 两张表试一试这个命令：

```bash
npx prisma db push
```

![image-20231022202848833](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222028909.png)

提示 schema 已经同步到数据库中了，同时也生成了`Prisma Client`代码。

数据库中确实出现了这两张表。

![image-20231022203000938](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222030015.png)

### prisma db seed

seed 命令是执行脚本插入初始数据到数据库。

我们有时候会需要在数据库中加入一些用于 mock 的初始数据，就需要用到 seed 命令。

首先在 prisma 目录下创建 seed.ts 文件并写入：

```ts
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient({
  log: [
    {
      emit: 'stdout',
      level: 'query',
    },
  ],
})

async function main() {
  const user = await prisma.user.create({
    data: {
      name: '球球球球',
      phone_number: '12345678901',
      Post: {
        create: [
          {
            title: 'aaa',
            content: 'aaaa',
          },
        ],
      },
    },
  })
  console.log(user)
}

main()
```

接着在 package.json 中写脚本命令执行 seed.ts 文件：

```ts
"scripts": { ... },
"prisma":{
    "seed":"npx ts-node prisma/seed.ts"
  },
```

接着执行`npx prisma db seed`

![image-20231022204938680](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222049790.png)

seed 数据已经插入进数据库了。

### prisma db execute

`npx prisma db execute` 是用来执行 sql 的。

比如我写一个 prisma/test.sql 的文件：

```sql
DELETE FROM "User" WHERE NAME = '球球球球';
```

再执行：

```bash
npx prisma db execute --file prisma/test.sql --schema prisma/schema.prisma
```

其中 --file 是指定 sql 文件的，--schema 是指定 schema.prisma 文件用来读取数据库 URL、账号密码登信息的。

![image-20231022210032989](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222100069.png)

脚本执行成功。

### prisma migrate dev

migrate 是迁移的意思，它能够记录并体现表的结构变化。一共有这么几个命令

![image-20231022210513507](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222105558.png)

开发中最常用的是` prisma migrate dev`。

它会根据 schema 的变化生成 sql 文件，并执行这个 sql，还会生成 client 代码。

如果第一次使用该命令，会提示清空数据库里的数据：

![image-20231022210912114](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222109183.png)

选择 yes 后，看一下它会做哪些事情：

![image-20231022211128519](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222111571.png)

从上到下依次是：

- 应用此次 migration
- 生成 migration.sql
- 生成 Prisma Client 代码
- 执行 seed, 给数据库填入种子数据

生成的 migration.sql 代码记录着每一次变更 schema 并且执行`npx prisma migrate dev`后的行为变化对应的 sql 语句。

例如一开始我们写好了 User 和 Post 两个 model，并 migrate 了，它生成的 SQL 是关于创建这两张表的。

![image-20231022211720084](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222117134.png)

如果我们再修改一下 schema ：

```diff
model User {
  id           String  @id @default(uuid())
  name         String
  age          String?
+  email        String?  @unique
  phone_number String  @unique
  Post         Post[]
}
```

执行`npx prisma migrate dev --name add_email`后得到提示：

```bash
The following migration(s) have been created and applied from new schema changes:

migrations/
  └─ 20231022132056_add_email/
    └─ migration.sql

Your database is now in sync with your schema.
```

此时生成了第二个 migration.sql 。里面的内容是关于在 User 表中添加 email 字段的。

![image-20231022212402484](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222124528.png)

在数据库中有个 \_prisma_migrations 表，也记录着数据库 migration 的历史：

![image-20231022212604485](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222126657.png)

### prisma migrate reset

如果想要 reset 数据，可以使用`npx prisma migrate reset`。

它会重置所有 database 的数据并重新执行所有 migration。

![image-20231022213126633](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222131707.png)

还会生成 client 代码，并且执行 prisma db seed 来初始化数据。

### prisma generate

generate 命令只是用来生成 client 代码的，他并不会同步数据库：

![image-20231022213311730](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222133804.png)

只是根据 schema 定义，在 node_modules/@prisma/client 下生成代码，用于 CRUD。

很多命令都附带这个功能，所以这个命令用得不是很多。

### prisma studio

这个命令会生成一个 web 端的图形化界面，可以看到 model 和数据并且能做一些增删改查的可视化操作。

![image-20231022213723534](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222137576.png)

![image-20231022213857523](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222138570.png)

### prisma validate

这个是用来检查 schema 文件是否有语法错误的。

如果 vscode 里有下载 [Prisma](https://marketplace.visualstudio.com/items?itemName=Prisma.prisma) 插件则可以忽略它。

### prisma format

顾名思义，用来格式化代码的。

如果 vscode 里有下载 [Prisma](https://marketplace.visualstudio.com/items?itemName=Prisma.prisma) 插件则可以忽略它。

![image-20231022214531629](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222145694.png)

### prisma version

这个就是展示一些版本信息的。

![image-20231022214652489](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222146547.png)

### 小结

通过`npx prisma -h`查看所有命令：

![image-20231022200229679](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310222002746.png)

总结一下 prisma 的全部命令：

- init：创建 schema 文件
- generate： 根据 shcema 文件生成 client 代码
- db：同步数据库和 schema
- migrate：生成数据表结构更新的 sql 文件
- studio：用于 CRUD 的图形化界面
- validate：检查 schema 文件的语法错误
- format：格式化 schema 文件
- version：版本信息

其中，prisma init、prisma migrate dev 是最常用的。

prisma db pull、prisma db push 也可以方便的用来做 schema 和数据库的同步。

## 总结

1. 安装 prisma 并用 cli 生成 schema 文件，在 schema 文件中定义数据库信息以及通过 model 描述表结构。

2. prisma migrate dev 根据 schema 文件生成 sql 文件并执行。
3. 在 nest.js 中用 service 的方式注入并使用即可。
