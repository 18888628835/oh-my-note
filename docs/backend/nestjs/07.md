# AOP æ¶æ„

åç«¯æ¡†æ¶éƒ½é‡‡ç”¨çš„æ˜¯ MVC æ¶æ„ã€‚

MVC æ˜¯ Model View Controller çš„ç®€å†™ã€‚MVC æ¶æ„ä¸‹ï¼Œè¯·æ±‚ä¼šå…ˆå‘é€ç»™ Controllerï¼Œç”±å®ƒè°ƒåº¦ç»™ Model å±‚çš„ Service æ¥å®Œæˆä¸šåŠ¡é€»è¾‘ï¼Œç„¶åè¿”å›å¯¹åº”çš„ Viewã€‚

![image-20231003200111047](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310032001078.png)

åœ¨ MVC çš„åŸºç¡€ä¸Šï¼ŒNest è¿˜æä¾›äº† AOPï¼ˆAspect Oriented Programmingï¼‰çš„èƒ½åŠ›ï¼Œå³é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚

é¢å‘åˆ‡é¢ç¼–ç¨‹çš„å«ä¹‰å¯ä»¥ä¾æ®å®é™…åœºæ™¯ç†è§£ï¼š

å½“è¯·æ±‚è¿‡æ¥æ—¶ï¼Œä¼šç»è¿‡ Controllerã€Serviceã€Viewã€‚

å¦‚æœæœ‰ä¸€äº›é€šç”¨çš„é€»è¾‘ï¼Œæ¯”å¦‚æ—¥å¿—è®°å½•ã€æƒé™æ§åˆ¶ã€å¼‚å¸¸å¤„ç†ç­‰ï¼Œè¿™äº›éƒ½åº”è¯¥æ”¾åœ¨å“ªä¸€å±‚ï¼Ÿå¾ˆæ˜æ˜¾ï¼Œæ”¾åœ¨ Controller å±‚æ¯”è¾ƒå¥½ï¼Œå› ä¸ºå®ƒç”¨äºæ§åˆ¶ã€‚

ä½†æ˜¯ Controller å±‚æˆ‘ä»¬ä¸€èˆ¬ä¼šå†™å¾ˆå¤šè·Ÿä¸šåŠ¡ç›¸å…³çš„é€»è¾‘ï¼Œå¦‚æœå†åŠ å…¥é€šç”¨çš„é€»è¾‘ï¼Œè¿™ä¸€å±‚çš„ä»£ç å°±ä¼šå˜å¾—è‡ƒè‚¿ã€‚

æ‰€ä»¥æœ€å¥½çš„å¤„ç†æ–¹å¼æ˜¯åœ¨ Controller å±‚ä¹‹å‰æˆ–è€…ä¹‹ååŠ å…¥ä¸€å±‚å¤„ç†é€šç”¨é€»è¾‘çš„é˜¶æ®µã€‚

![img](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310032007135.awebp)

è¿™ç§æ¨ªå‘çš„æ‰©å±•ç‚¹å°±å«åšåˆ‡é¢ï¼ŒåŠ å…¥ä¸€äº›åˆ‡é¢é€»è¾‘çš„ç¼–ç¨‹å°±å«åš AOPã€‚

**AOP çš„å¥½å¤„æ˜¯å¯ä»¥æŠŠä¸€äº›é€šç”¨é€»è¾‘åˆ†ç¦»åˆ°åˆ‡é¢ä¸­ï¼Œä¿æŒä¸šåŠ¡é€»è¾‘çš„çº¯ç²¹æ€§ï¼Œè¿™æ ·åˆ‡é¢é€»è¾‘å¯ä»¥å¤ç”¨ï¼Œè¿˜å¯ä»¥åŠ¨æ€çš„å¢åˆ ã€‚**

Nest å®ç° AOP çš„æ–¹å¼å¾ˆå¤šï¼Œä¸€å…±æœ‰äº”ç§ï¼ŒåŒ…æ‹¬ Middlewareã€Guardã€Pipeã€Interceptorã€ExceptionFilterã€‚

## ä¸­é—´ä»¶ Middleware

ä¸­é—´ä»¶åˆ†å…¨å±€ä¸­é—´ä»¶å’Œè·¯ç”±ä¸­é—´ä»¶ï¼š

å…¨å±€ä¸­é—´ä»¶æ˜¯è¿™ä¹ˆå†™çš„ï¼š

```ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule)
  await app.use(logger)
  await app.listen(3000)
}
bootstrap()
```

è·¯ç”±ä¸­é—´ä»¶åˆ™æ˜¯é’ˆå¯¹æŸä¸ªè·¯ç”±æ¥è¯´çš„ï¼š

```ts
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(LoggerMiddleware).forRoutes('cats')
  }
}
```

## è·¯ç”±å®ˆå« Guard

Guard æ˜¯è·¯ç”±å®ˆå«çš„æ„æ€ï¼Œå¯ä»¥ç”¨äºåœ¨è°ƒç”¨æŸä¸ª Controller ä¹‹å‰åˆ¤æ–­æƒé™ï¼Œè¿”å› true æˆ–è€… false æ¥å†³å®šæ˜¯å¦æ”¾è¡Œï¼š

1. åˆ›å»º guard

   ```bash
   nest generate guard

   ? What name would you like to use for the guard? Roles
   CREATE src/roles-guard/roles-guard.guard.spec.ts (185 bytes)
   CREATE src/roles-guard/roles-guard.guard.ts (305 bytes)
   ```

   æ­¤æ—¶ç”Ÿæˆ guard ä»£ç ï¼š

   ```ts
   @Injectable()
   export class RolesGuard implements CanActivate {
     canActivate(context: ExecutionContext): boolean | Promise<boolean> | Observable<boolean> {
       return true
     }
   }
   ```

2. é€šè¿‡@UseGuards è£…é¥°å™¨æ³¨å…¥åˆ° Controller ä¸­

   ```ts
   @Controller()
   export class AppController {
     @Get()
     @UseGuards(RolesGuard)
     getHello(): string {
       return 'Hello World!'
     }
   }
   ```

Controller æœ¬èº«ä¸éœ€è¦åšå•¥ä¿®æ”¹ï¼Œå´é€æ˜çš„åŠ ä¸Šäº†æƒé™åˆ¤æ–­çš„é€»è¾‘ï¼Œè¿™å°±æ˜¯ AOP æ¶æ„çš„å¥½å¤„ã€‚

å°±åƒ Middleware æ”¯æŒå…¨å±€çº§åˆ«å’Œè·¯ç”±çº§åˆ«ä¸€æ ·ï¼ŒGuard ä¹Ÿå¯ä»¥å…¨å±€å¯ç”¨ï¼š

```ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule)
  app.useGlobalGuards(new RolesGuard())
  await app.listen(3000)
}
bootstrap()
```

## æ‹¦æˆªå™¨ Interceptor

Guard å¯ä»¥æŠ½ç¦»è·¯ç”±çš„è®¿é—®æ§åˆ¶é€»è¾‘ï¼Œä½†æ˜¯ä¸èƒ½å¯¹è¯·æ±‚ã€å“åº”åšä¿®æ”¹ï¼Œè¿™ç§é€»è¾‘å¯ä»¥ä½¿ç”¨ Interceptorã€‚

Interceptor æ˜¯æ‹¦æˆªå™¨çš„æ„æ€ï¼Œå¯ä»¥åœ¨ç›®æ ‡ Controller æ–¹æ³•å‰ååŠ å…¥ä¸€äº›é€»è¾‘ï¼š

```bash
nest generate interceptor Route
```

ç”Ÿæˆä»£ç 

```ts
@Injectable()
export class RouteInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    console.log('...before')

    return next.handle().pipe(tap(() => console.log('...after')))
  }
}
```

Interceptor è¦å®ç° NestInterceptor æ¥å£ï¼Œå®ç° intercept æ–¹æ³•ï¼Œè°ƒç”¨ next.handle() å°±ä¼šè°ƒç”¨ç›®æ ‡ Controllerï¼Œå¯ä»¥åœ¨ä¹‹å‰å’Œä¹‹ååŠ å…¥ä¸€äº›å¤„ç†é€»è¾‘ã€‚

Controller ä¹‹å‰ä¹‹åçš„å¤„ç†é€»è¾‘å¯èƒ½æ˜¯å¼‚æ­¥çš„ã€‚Nest é‡Œé€šè¿‡ rxjs æ¥ç»„ç»‡å®ƒä»¬ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ rxjs çš„å„ç§ operatorã€‚

åœ¨å•ä¸ª Controller ä¸­ä½¿ç”¨ï¼š

```ts
@Controller()
export class AppController {
  @Get()
  @UseInterceptors(new RouteInterceptor())
  getHello(): string {
    return 'Hello World!'
  }
}
```

å…¨å±€ä½¿ç”¨ï¼š

```ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule)
  app.useGlobalInterceptors(new RouteInterceptor())
  await app.listen(3000)
}
bootstrap()
```

## ç®¡é“ Pipe

é™¤äº†è·¯ç”±çš„æƒé™æ§åˆ¶ã€ç›®æ ‡ Controller ä¹‹å‰ä¹‹åçš„å¤„ç†è¿™äº›éƒ½æ˜¯é€šç”¨é€»è¾‘å¤–ï¼Œå¯¹å‚æ•°çš„å¤„ç†ä¹Ÿæ˜¯ä¸€ä¸ªé€šç”¨çš„é€»è¾‘ï¼Œæ‰€ä»¥ Nest ä¹ŸæŠ½å‡ºäº†å¯¹åº”çš„åˆ‡é¢ï¼Œä¹Ÿå°±æ˜¯ Pipeï¼š

```ts
nest generate pipe App
```

ç”Ÿæˆä»£ç ï¼š

```ts
@Injectable()
export class AppPipe implements PipeTransform {
  transform(value: any, metadata: ArgumentMetadata) {
    return value
  }
}
```

Pipe è¦å®ç° PipeTransform æ¥å£ï¼Œå®ç° transform æ–¹æ³•ï¼Œé‡Œé¢å¯ä»¥å¯¹ä¼ å…¥çš„å‚æ•°å€¼ value åšå‚æ•°éªŒè¯ï¼Œæ¯”å¦‚æ ¼å¼ã€ç±»å‹æ˜¯å¦æ­£ç¡®ï¼Œä¸æ­£ç¡®å°±æŠ›å‡ºå¼‚å¸¸ã€‚ä¹Ÿå¯ä»¥åšè½¬æ¢ï¼Œè¿”å›è½¬æ¢åçš„å€¼.

å†…ç½®çš„æœ‰ 9 ä¸ª Pipeï¼Œä»åå­—å°±èƒ½çœ‹å‡ºå®ƒä»¬çš„æ„æ€ï¼š

- ValidationPipe
- ParseIntPipe
- ParseBoolPipe
- ParseArrayPipe
- ParseUUIDPipe
- DefaultValuePipe
- ParseEnumPipe
- ParseFloatPipe
- ParseFilePipe

åŒæ ·ï¼ŒPipe å¯ä»¥åªå¯¹æŸä¸ªå‚æ•°ç”Ÿæ•ˆï¼š

```tsx
@Controller()
export class AppController {
  @Get(':id')
  getHello(@Param('id', AppPipe) id: string): string {
    console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” id:', id)
    return 'Hello World!'
  }
}
```

åªå¯¹æŸä¸ªè·¯ç”±ç”Ÿæ•ˆï¼š

```ts
  @Post()
  @UsePipes(AppPipe)
  async create(@Body() createUser: CreateUserDto) {
    // ...
  }
```

global ç”Ÿæ•ˆï¼š

```ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule)
  app.useGlobalPipes(new AppPipe())
  await app.listen(3000)
}
bootstrap()
```

## å¼‚å¸¸å¤„ç† ExceptionFilter

ExceptionFilter å¯ä»¥å¯¹æŠ›å‡ºçš„å¼‚å¸¸åšå¤„ç†ï¼Œè¿”å›å¯¹åº”çš„å“åº”ï¼š

```bash
nest generate filter HttpException
```

ç”Ÿæˆä»£ç 

```ts
@Catch(HttpException)
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: HttpException, host: ArgumentsHost) {
    const ctx = host.switchToHttp()
    const response = ctx.getResponse()
    const request = ctx.getRequest()
    const status = exception.getStatus()
    response.status(status).json({
      statusCode: status,
      path: request.url,
      message: exception.message,
    })
  }
}
```

é¦–å…ˆè¦å®ç° ExceptionFilter æ¥å£ï¼Œå®ç° catch æ–¹æ³•ï¼Œå°±å¯ä»¥æ‹¦æˆªå¼‚å¸¸äº†ï¼Œä½†æ˜¯è¦æ‹¦æˆªä»€ä¹ˆå¼‚å¸¸è¿˜éœ€è¦ç”¨ @Catch è£…é¥°å™¨æ¥å£°æ˜ï¼Œæ‹¦æˆªäº†å¼‚å¸¸ä¹‹åï¼Œå¯ä»¥è¿”å›å¯¹åº”çš„å“åº”ï¼Œç»™ç”¨æˆ·æ›´å‹å¥½çš„æç¤ºã€‚

Nest å†…ç½®äº†å¾ˆå¤š http ç›¸å…³çš„å¼‚å¸¸ï¼Œéƒ½æ˜¯ HttpException çš„å­ç±»ï¼š

- BadRequestException
- UnauthorizedException
- NotFoundException
- ForbiddenException
- NotAcceptableException
- RequestTimeoutException
- ConflictException
- GoneException
- PayloadTooLargeException
- UnsupportedMediaTypeException
- UnprocessableException
- InternalServerErrorException
- NotImplementedException
- BadGatewayException
- ServiceUnavailableException
- GatewayTimeoutException

ä¹Ÿå¯ä»¥è‡ªå·±æ‰©å±•ï¼Œåªéœ€è¦ç»§æ‰¿è‡ª HttpException å³å¯

```ts
export class IpRestriction extends HttpException {
  constructor() {
    super('Forbidden', 403)
  }
}
```

**Nest é€šè¿‡è¿™æ ·çš„æ–¹å¼å®ç°äº†å¼‚å¸¸åˆ°å“åº”çš„å¯¹åº”å…³ç³»ï¼Œä»£ç é‡Œåªè¦æŠ›å‡ºä¸åŒçš„å¼‚å¸¸ï¼Œå°±ä¼šè¿”å›å¯¹åº”çš„å“åº”ï¼Œå¾ˆæ–¹ä¾¿ã€‚**

åŒæ ·ï¼ŒExceptionFilter ä¹Ÿå¯ä»¥é€‰æ‹©å…¨å±€ç”Ÿæ•ˆæˆ–è€…æŸä¸ªè·¯ç”±ç”Ÿæ•ˆï¼š

æŸä¸ªè·¯ç”±ç”Ÿæ•ˆï¼š

```ts
@Controller()
export class AppController {
  @Get()
  @UseFilters(new HttpExceptionFilter())
  getHello(): string {
    return 'Hello World!'
  }
}
```

å…¨å±€è·¯ç”±ç”Ÿæ•ˆï¼š

```ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule)
  app.useGlobalFilters(new HttpExceptionFilter())
  await app.listen(3000)
}
bootstrap()
```

## é¡ºåº

è¿™é‡Œæœ‰ä¸€å¼ åˆ«äººæ€»ç»“å¥½çš„å›¾ï¼Œæ ¹æ®éœ€è¦åœ¨ä¸åŒçš„åˆ‡é¢é‡ŒåŠ å…¥ä¸åŒçš„é€»è¾‘å³å¯ã€‚

![img](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310032134636.awebp)

## æ€»ç»“

Nest åœ¨ä¼ ç»Ÿ MVC æ¶æ„åŸºç¡€ä¸Šï¼ŒåŠ å…¥äº† AOP ç¼–ç¨‹çš„æ€æƒ³ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™äº›åˆ‡é¢å®Œæˆé¢å¤–çš„æŸäº›é€»è¾‘ï¼Œè®© Controller åªä¸“æ³¨äºå®ç°ä¸šåŠ¡é€»è¾‘ã€‚

Nest é€šè¿‡ä»¥ä¸‹æ‰©å±•ç‚¹ï¼ˆé¡ºåºæ’æ”¾ï¼‰å®ç° AOPï¼š

1. Middleware ä¸­é—´ä»¶
2. Guard è·¯ç”±å®ˆå«ï¼Œå¯ä»¥æ§åˆ¶æ˜¯å¦è®© request è¿›å…¥ handler é€»è¾‘
3. Interceptor æ‹¦æˆªå™¨ï¼Œå¯ä»¥åšå‚æ•°å¤„ç†ï¼Œä¿®æ”¹ request å’Œ Response
4. Pipe ç®¡é“ï¼šå‚æ•°å¤„ç†ï¼ˆè½¬æ¢ã€æ ¡éªŒç­‰ï¼‰
5. ExceptionFilter ï¼šé”™è¯¯å¤„ç†
