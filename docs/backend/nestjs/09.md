# åˆ‡æ¢ä¸Šä¸‹æ–‡

Nest æ”¯æŒåˆ›å»º HTTP æœåŠ¡ã€WebSocket æœåŠ¡ï¼Œè¿˜æœ‰åŸºäº TCP é€šä¿¡çš„å¾®æœåŠ¡ã€‚

è¿™äº›ä¸åŒç±»å‹çš„æœåŠ¡éƒ½éœ€è¦ Guardã€Interceptorã€Exception Filter åŠŸèƒ½ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼š

ä¸åŒç±»å‹çš„æœåŠ¡å®ƒèƒ½æ‹¿åˆ°çš„å‚æ•°æ˜¯ä¸åŒçš„ï¼Œæ¯”å¦‚ http æœåŠ¡å¯ä»¥æ‹¿åˆ° requestã€response å¯¹è±¡ï¼Œè€Œ ws æœåŠ¡å°±æ²¡æœ‰ï¼Œå¦‚ä½•è®© Guardã€Interceptorã€Exception Filter è·¨å¤šç§ä¸Šä¸‹æ–‡å¤ç”¨å‘¢ï¼Ÿ

Nest çš„è§£å†³æ–¹æ³•æ˜¯ ArgumentHost å’Œ ExecutionContext ç±»ã€‚

## ArgumentHost

åœ¨æ•è·å¼‚å¸¸æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ° ArgumentHost å‚æ•°ã€‚

ä¸ºäº†åšè¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ª filter

```bash
nest generate filter aaa
```

è¿™æ—¶ä¼šç”Ÿæˆä»¥ä¸‹ä»£ç ï¼š

```typescript
// aaa.filter.ts
import { ArgumentsHost, Catch, ExceptionFilter } from '@nestjs/common'
import { AaaException } from 'src/exception/aaaException'

@Catch()
export class AaaFilter<T> implements ExceptionFilter {
  catch(exception: T, host: ArgumentsHost) {}
}
```

Nest ä¼š catch æ‰€æœ‰æœªæ•è·å¼‚å¸¸ï¼Œå¦‚æœæ˜¯ Exception Filter å£°æ˜çš„å¼‚å¸¸ï¼Œé‚£å°±ä¼šè°ƒç”¨ filter æ¥å¤„ç†ã€‚

å†åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰å¼‚å¸¸ class

```ts
export class AaaException {
  constructor(public aaa: string, public bbb: string) {
    console.log('aaa', aaa)
    console.log('bbb', bbb)
  }
}
```

åœ¨ @Catch è£…é¥°å™¨é‡Œå£°æ˜ï¼Œè®© filter å¤„ç†è¯¥å¼‚å¸¸ï¼š

```typescript
@Catch(AaaException)
export class AaaFilter implements ExceptionFilter {
  catch(exception: AaaException, host: ArgumentsHost) {
    console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” exception:', exception)
    console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” host:', host.getType())
  }
}
```

ç„¶åéœ€è¦å¯ç”¨å®ƒï¼š

```typescript
  @Get()
  @UseFilters(AaaFilter)
  getHello(): string {
    throw new AaaException('aaa', 'bbb');
    return this.appService.getHello();
  }
```

ç›´æ¥è®¿é—®`http://localhost:3000/`å°±å¯ä»¥çœ‹åˆ°æ•è·åˆ°å¼‚å¸¸äº†ï¼š

![image-20231007213000122](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310072130340.png)

è¿™ä¸ª host æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿé€šè¿‡ Typescript èƒ½å¤Ÿçœ‹åˆ°å®ƒæœ‰ä¸€äº›æ–¹æ³•ï¼š

![image-20231007213142698](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310072131463.png)

åœ¨ debug æ—¶ï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥é€šè¿‡`DEBUG CONSOLE`æ¥æŸ¥çœ‹ host çš„æ–¹æ³•é‡Œéƒ½æœ‰äº›ä»€ä¹ˆï¼š

![image-20231007213617687](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310072136737.png)

host.getArgs æ–¹æ³•å°±æ˜¯å–å‡ºå½“å‰ä¸Šä¸‹æ–‡çš„ reqeustã€responseã€next å‚æ•°ã€‚

host.getArgByIndex æ–¹æ³•æ˜¯æ ¹æ®ä¸‹æ ‡å–å‚æ•°ã€‚ï¼ˆè¿™ç§æŒ‰ç…§ä¸‹æ ‡å–å‚æ•°çš„å†™æ³•ä¸å¤ªå»ºè®®ç”¨ï¼Œå› ä¸ºä¸åŒä¸Šä¸‹æ–‡å‚æ•°ä¸åŒï¼Œè¿™æ ·å†™å°±æ²¡æ³•å¤ç”¨åˆ° wsã€tcp ç­‰ä¸Šä¸‹æ–‡äº†ï¼‰

getType æ–¹æ³•æ˜¯è·å–å½“å‰è¯·æ±‚ç±»å‹ä¸º http è¯·æ±‚ã€‚

å½“å‰æ˜¯ http è¯·æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬è°ƒç”¨ä¸€ä¸‹`host.switchToHttp()`æ–¹æ³•ï¼Œæ­¤æ—¶ä¼šå¤šå‡ºæ¥ä¸€äº›æ–¹æ³•ï¼š

![image-20231007214132782](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310072141827.png)

é€šè¿‡è¿™äº›æ–¹æ³•å°±èƒ½å¤Ÿè·å–åˆ°å¯¹åº”çš„ä¸Šä¸‹æ–‡å†…å®¹ã€‚

å¦‚æœæ˜¯ wsã€åŸºäº tcp çš„å¾®æœåŠ¡ç­‰ä¸Šä¸‹æ–‡ï¼Œå°±åˆ†åˆ«è°ƒç”¨ host.swtichToWsã€host.switchToRpc æ–¹æ³•ã€‚

æœ€ç»ˆç”¨æ¥å¤„ç†ä¸åŒæœåŠ¡çš„ä¸Šä¸‹æ–‡çš„ä»£ç ç»“æ„å°±ç±»ä¼¼äºè¿™æ ·ï¼š

```typescript
import { ArgumentsHost, Catch, ExceptionFilter } from '@nestjs/common'
import { AaaException } from 'src/dto/AaaException'

@Catch(AaaException)
export class AaaFilter implements ExceptionFilter {
  catch(exception: AaaException, host: ArgumentsHost) {
    const type = host.getType()
    switch (type) {
      case 'http':
        const ctx = host.switchToHttp()
        const response = ctx.getResponse()
        const request = ctx.getRequest()
        response.status(200).json({
          aaa: exception.aaa,
          bbb: exception.bbb,
          url: request.url,
        })
        break
      case 'ws':
        break
      case 'rpc':
        break
      default:
        break
    }
  }
}
```

**ArgumentHost æ˜¯ç”¨äºåˆ‡æ¢ httpã€wsã€rpc ç­‰ä¸Šä¸‹æ–‡ç±»å‹çš„ï¼Œå¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡ç±»å‹å–åˆ°å¯¹åº”çš„ argument**ã€‚

## ExecutionContext

ExecutionContext æ˜¯ ArgumentHost çš„ä¸€ä¸ªå­ç±»ã€‚å®ƒæ˜¯ä¸“ç”¨äº Guard å’Œ Interceptor çš„ä¸Šä¸‹æ–‡å‚æ•°ã€‚

ä¸ºäº†éªŒè¯ä¸Šé¢çš„ç»“è®ºï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ª guardï¼š

```bash
nest generate guard aaa --no-spec --flat
```

```typescript
import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common'
import { Observable } from 'rxjs'

@Injectable()
export class AaaGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean | Promise<boolean> | Observable<boolean> {
    return true
  }
}
```

ä½¿ç”¨ guardï¼š

```typescript
@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  @UseGuards(AaaGuard)
  getHello(): string {
    return this.appService.getHello()
  }
}
```

context çš„ç±»å‹æ˜¯ ExecutionContextï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹å®ƒçš„æ–¹æ³•ï¼š

![image-20231008224450102](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310082244757.png)

æ¯” ArgumentHost å¤šäº†ä¸¤ä¸ªæ–¹æ³•ï¼Œä»¥ä¸‹æ˜¯æºç ï¼š

```typescript
export interface ExecutionContext extends ArgumentsHost {
  getClass<T = any>(): Type<T>
  getHandler(): Function
}
```

é‚£ä¹ˆè¿™ä¸¤ä¸ªæ–¹æ³•èƒ½è·å¾—ä»€ä¹ˆå‘¢ï¼Ÿé€šè¿‡æ–­ç‚¹æŸ¥çœ‹ä¸€ä¸‹ï¼š

![image-20231008224917303](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310082249373.png)

å¯ä»¥çœ‹åˆ°è¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«å¾—åˆ°äº†ä½¿ç”¨ guard çš„è·¯ç”±ä»¥åŠå®ƒçš„ Controllerã€‚

ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸¤ä¸ªæ–¹æ³•å‘¢ï¼Ÿ

å› ä¸º Guardã€Interceptor çš„é€»è¾‘å¯èƒ½è¦æ ¹æ®ç›®æ ‡ classã€handler æœ‰æ²¡æœ‰æŸäº›è£…é¥°è€Œå†³å®šæ€ä¹ˆå¤„ç†ã€‚

æ¯”å¦‚ç°åœ¨æˆ‘æœ‰ä¸€ä¸ª metaData åœ¨è·¯ç”±ä¸Šï¼š

```ts
  @Get()
  @SetMetadata('roles', ['admin'])
  @UseGuards(AaaGuard)
  getHello(): string {
    return this.appService.getHello();
  }
```

è¿™æ®µä»£ç è¡¨ç¤ºéœ€è¦ admin ç”¨æˆ·æ‰èƒ½æŸ¥çœ‹è¯¥è·¯ç”±ã€‚

ç„¶ååœ¨ guard ä¸Šè®¾ç½®è·¯ç”±å®ˆå«ï¼Œæ ¹æ®ç”¨æˆ·çš„è§’è‰²åˆ¤æ–­æ˜¯å¦æ”¾è¡Œï¼š

```typescript
@Injectable()
export class AaaGuard implements CanActivate {
  @Inject(Reflector)
  private readonly reflector: Reflector;
  canActivate(
    context: ExecutionContext,
  ): boolean | Promise<boolean> | Observable<boolean> {
    const requester = 'user';
    const roles = this.reflector.get('roles', context.getHandler());
    if (Array.isArray(roles) && roles.includes(requester)) {
      return true;
    }

    return false;
  }
```

è¿™é‡Œæˆ‘éœ€è¦ Nest æ³¨å…¥ reflectorï¼Œä½†å¹¶ä¸éœ€è¦åœ¨æ¨¡å—çš„ provider å£°æ˜ã€‚

ç”±äº`requester`æ˜¯`user`ï¼Œä¸ç¬¦åˆè¯¥è·¯ç”±çš„ `roles`è¦æ±‚ï¼Œæ‰€ä»¥ guard ä¸å…è®¸æ”¾è¡Œï¼Œæˆ‘ä»¬æ¥æŸ¥çœ‹è¯·æ±‚ç»“æœï¼š

![image-20231008231922605](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202310082319652.png)

è¿™è¯´æ˜ Guard ç”Ÿæ•ˆäº†ã€‚

è¿™å°±æ˜¯ Guard é‡Œçš„ ExecutionContext å‚æ•°çš„ç”¨æ³•ã€‚

Interceptor ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ã€‚

## æ€»ç»“

ä¸ºäº†è®© Filterã€Guardã€Exception Filter æ”¯æŒ httpã€wsã€rpc ç­‰åœºæ™¯ä¸‹å¤ç”¨ï¼ŒNest è®¾è®¡äº† ArgumentHost å’Œ ExecutionContext ç±»ã€‚

ArgumentHost å¯ä»¥é€šè¿‡ getArgs æˆ–è€… getArgByIndex æ‹¿åˆ°ä¸Šä¸‹æ–‡å‚æ•°ï¼Œæ¯”å¦‚ requestã€responseã€next ç­‰ã€‚

æ›´æ¨èçš„æ–¹å¼æ˜¯æ ¹æ® getType çš„ç»“æœåˆ†åˆ« switchToHttpã€switchToWsã€swtichToRpcï¼Œç„¶åå†å–å¯¹åº”çš„ argumentã€‚

è€Œ ExecutionContext è¿˜æä¾› getClassã€getHandler æ–¹æ³•ï¼Œå¯ä»¥ç»“åˆ reflector æ¥å–å‡ºå…¶ä¸­çš„ metadataã€‚

åœ¨å†™ Filterã€Guardã€Exception Filter çš„æ—¶å€™ï¼Œæ˜¯éœ€è¦ç”¨åˆ°è¿™äº› api çš„ã€‚
