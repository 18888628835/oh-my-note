# REST API æ•°æ®ä¼ è¾“

## é€šè¿‡ URL

æœ€åŸºæœ¬çš„é€šè¿‡ url ä¼ è¾“å½¢å¼æ˜¯è¿™æ ·çš„ï¼š

```js
http://localhost/user/:id
```

é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ª user çš„ `controller`

```bash
nest generate controller user
```

é€šè¿‡`@Get(':id')`æ¥å£°æ˜è·¯ç”± ä»¥åŠé€šè¿‡`@Param(å‚æ•°å)`è£…é¥°å™¨å–å‡ºå‚æ•°æ³¨å…¥åˆ° controllerï¼š

```js
@Controller('user')
export class UserController {
  @Get(':id')
  urlParam(@Param('id') id: string) {
    return `received: id=${id}`
  }
}
```

ç°åœ¨`@Controller('user')`å’Œ`@Get(':id')`ä¼šæ‹¼æ¥æˆä¸º`/user/:id`è¿™æ ·çš„ URLã€‚

æ‰§è¡Œ`pnpm start:dev`å‘½ä»¤ï¼Œæˆ‘ä»¬å¯åŠ¨ nest serverï¼Œé»˜è®¤çš„ç«¯å£å·ä¸º 3000ï¼Œè¿™äº›éƒ½æ˜¯åœ¨`main.ts`ä¸­çš„`bootstrap`ä¸­å†™å¥½çš„ï¼š

```js
async function bootstrap() {
  const app = await NestFactory.create(AppModule)
  await app.listen(3000)
}
bootstrap()
```

ç°åœ¨æˆ‘ä»¬åœ¨æµè§ˆå™¨è®¿é—®`http://localhost:3000/user/1`,è¿™ä¸ª`GET`è¯·æ±‚ä¼šç»è¿‡`@Controller('user')`å’Œ`@Get(':id')`è£…é¥°å™¨ä¸‹çš„`urlParam`æ–¹æ³•ï¼Œå°†ç»“æœè¿”å›ç»™æˆ‘ä»¬ï¼š

```js
received: id = 1
```

## é€šè¿‡ query

é€šè¿‡ query ä¼ è¾“çš„å½¢å¼æ˜¯è¿™æ ·çš„ï¼š

```js
http://localhost/user?id=xxx&age=30
```

å¦‚æœç”¨ query ä¼ è¾“ï¼Œå¯ä»¥ä½¿ç”¨ `query-string`æˆ–è€… `qs`å°†å¯¹è±¡è§£ææˆ`xx=xx&yy=yy`è¿™æ ·çš„å­—ç¬¦ä¸²ç¼–ç ï¼ŒåŒæ—¶è¿™äº›ä¸‰æ–¹åº“ä¼šå¯¹éè‹±æ–‡å­—ç¬¦åšç¼–ç å¤„ç†ã€‚

> å¦‚æœè‡ªå·±å†™çš„è¯ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨è°ƒç”¨ API å¯¹ä¸€äº›éè‹±æ–‡å­—ç¬¦åšç¼–ç ã€‚
>
> å¯¹æ•´ä¸ª URL åšç¼–ç ä½¿ç”¨`encodeURI`,å•ç‹¬å¯¹éƒ¨åˆ†åšç¼–ç åˆ™ä½¿ç”¨`encodeURIComponent`ã€‚

```js
const query = '?name=' + encodeURIComponent('åŠ å¯†')
// '?name=%E5%8A%A0%E5%AF%86'
```

è·Ÿ url param ç±»ä¼¼ï¼Œæˆ‘ä»¬ç»§ç»­ç”¨è£…é¥°å™¨å®šä¹‰ä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼š

```ts
  @Get('find')
  urlQuery(@Query('id') id: string, @Query('name') name: string) {
    return `received from Query: id=${id} name=${name}`;
  }
```

ä¸åŒä¹‹å¤„åœ¨äºæ²¡æœ‰ä½¿ç”¨`:`å£°æ˜ï¼Œä»¥åŠæå–å‚æ•°ç”¨çš„è£…é¥°å™¨ä¸º`@Query('å‚æ•°å')`ã€‚

ç»§ç»­åœ¨æµè§ˆå™¨è®¿é—®ï¼š

```js
http://localhost:3000/user/find?id=123&name=qiuyanxi
```

å¯ä»¥å¾—åˆ°ç»“æœï¼š

```js
received from Query: id=123 name=qiuyanxi
```

æ³¨æ„ç°åœ¨çš„ä»£ç ï¼š

```ts
@Controller('user')
export class UserController {
  // queryåœ¨å‰
  @Get('find')
  urlQuery(@Query('id') id: string, @Query('name') name: string) {
    return `received from Query: id=${id} name=${name}`
  }
  // paramåœ¨å
  @Get(':id')
  urlParam(@Param('id') id: string) {
    return `received: id=${id}`
  }
}
```

è¿™æ˜¯å› ä¸º`Controller`å†…çš„æ–¹æ³•ä¼šæŒ‰ç…§é¡ºåºåŒ¹é…ï¼Œå½“è®¿é—®`user/find`æ—¶ï¼Œä¹Ÿå¯èƒ½ä¼šè¢«`user/:id`è·¯ç”±åŒ¹é…åˆ°ã€‚

## é€šè¿‡ form-urlencoded

ç›´æ¥ä½¿ç”¨ form è¡¨å•æäº¤æ—¶æ˜¯é‡‡ç”¨`form-urlencoded`è¿›è¡Œä¼ è¾“ã€‚

`content-type`æ˜¯`application/x-www-form-urlencoded`ã€‚

å®ƒçš„æ„æ€æ˜¯ï¼šâ€œè¿™æ˜¯å·²ç¼–ç ä¸º URL å‚æ•°çš„è¡¨å•æ•°æ®ã€‚â€

è¿™æ˜¯ä¸€ç§ä½¿ç”¨ Post è¯·æ±‚å¹¶å°† `url query`æ”¾åœ¨` body` ä¼ è¾“çš„æ–¹æ³•ã€‚æ‰€ä»¥éè‹±æ–‡çš„å‚æ•°éƒ½éœ€è¦ç»è¿‡ç¼–ç ï¼ˆencodeï¼‰ã€‚ï¼ˆæ–¹æ³•åŒ queryï¼‰

```http
POST /test HTTP/1.1
Host: foo.example
Content-Type: application/x-www-form-urlencoded
Content-Length: 27

name=%E5%8A%A0%E5%AF%86&field2=value2
```

åœ¨ Nest ä¸­æ¥å— body å†…çš„æ•°æ®ï¼Œéœ€è¦ç”¨åˆ° @Body è£…é¥°å™¨ï¼ŒNest ä¼šè§£æè¯·æ±‚ä½“ï¼Œæ³¨å…¥åˆ° dtoï¼ˆdata transfer objectï¼‰ä¸­ã€‚

å…ˆå®šä¹‰ä¸€ä¸ª dto å¯¹è±¡

```ts
// src/dto/person.dto.ts

export class PersonDto {
  name: string
  age: number
}
```

å†ä½¿ç”¨`@Post`è£…é¥°å™¨å®šä¹‰è·¯ç”±ä»¥åŠä½¿ç”¨`@Body`è£…é¥°å™¨å–å‡º Body å†…çš„å‚æ•°ã€‚

```ts
import { PersonDto } from 'src/dto/person.dto'

@Controller('user')
export class UserController {
  @Post('get')
  body(@Body() getPersonDto: PersonDto) {
    return `received: ${JSON.stringify(getPersonDto)}`
  }
}
```

ä½¿ç”¨ postman è¯·æ±‚æµ‹è¯•ä¸€ä¸‹

![image-20230929152010323](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202309291520976.png)

## é€šè¿‡ JSON

åœ¨ json æ•°æ®æ ¼å¼è¢«å¹¿æ³›ç”¨äº HTTP ä¼ è¾“åï¼Œå¤§å¤šæ•°çš„ REST API éƒ½ä½¿ç”¨ json ä¼ è¾“æ•°æ®ã€‚

`content-type`ä¸º`application/json`ã€‚

éƒ½æ˜¯ä» Body ä¸­å–å€¼ï¼ŒNest å†…éƒ¨åšäº†å°è£…ï¼Œèƒ½å¤Ÿå¯¹åº”ä¸åŒçš„` content-type` ä» body ä¸­æ‹¿åˆ°æ•°æ®ã€‚æ‰€ä»¥ä»£ç å‡ ä¹æ²¡æœ‰å˜åŒ–ã€‚

```ts
  @Post('get')
  getUserByJSON(@Body() getPersonDto: PersonDto) {
    return `received: ${JSON.stringify(getPersonDto)}`;
  }
```

å”¯ä¸€å˜åŒ–çš„å°±æ˜¯å‰ç«¯è¯·æ±‚æ—¶ï¼Œéœ€è¦ä¿®æ”¹`content-type`

![image-20230929153749565](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202309291537613.png)

## é€šè¿‡ formdata

å¦‚æœä½ æƒ³è¦å‘é€æ–‡ä»¶ï¼Œä½ éœ€è¦ä½¿ç”¨ formdata çš„æ–¹å¼ä¼ è¾“ã€‚

`content-type` ä¸º`multipart/form-data`ã€‚

å› ä¸ºæ•°æ®å°†è¢«åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªæ–‡ä»¶å•ç‹¬å ç”¨ä¸€ä¸ªéƒ¨åˆ†ï¼Œè¡¨å•æ­£æ–‡ä¸­åŒ…å«çš„æ–‡æœ¬æ•°æ®ï¼ˆå¦‚æœæ–‡æœ¬ä¹Ÿè¾“å…¥åˆ°è¡¨å•ä¸­ï¼‰å ç”¨ä¸€ä¸ªéƒ¨åˆ†ã€‚

Nest è§£æ form data ä½¿ç”¨ FilesInterceptor çš„æ‹¦æˆªå™¨ï¼Œç”¨ @UseInterceptors è£…é¥°å™¨å¯ç”¨ï¼Œç„¶åé€šè¿‡ @UploadedFiles æ¥å–ã€‚

éæ–‡ä»¶çš„å†…å®¹ï¼ŒåŒæ ·æ˜¯é€šè¿‡ @Body æ¥å–ã€‚

æ¥å—æ–‡ä»¶çš„ Nest ä»£ç å¦‚ä¸‹ï¼š

```ts
  @Post('form-data')
  @UseInterceptors(
    AnyFilesInterceptor({
      dest: 'uploads/',
    }),
  )
  body2(
    @Body() getPersonDto: PersonDto,
    @UploadedFiles() files: Array<Express.Multer.File>,
  ) {
    console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” files:', files);
    return `received: ${JSON.stringify(getPersonDto)}`;
  }
```

ä¸Šé¢çš„ä»£ç è¿˜éœ€è¦é¢å¤–å®‰è£…`Express.Multer`çš„ç±»å‹å£°æ˜

```bash
pnpm install -D @types/multer
```

æ¥ç€ç”¨ postman æµ‹è¯•ä¸€ä¸‹ï¼š

![image-20230929160600564](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202309291606625.png)

ç°åœ¨æ–‡ä»¶å·²ç»æˆåŠŸä¼ è¾“åˆ°`dest: 'uploads/'`ä¸­ï¼š

![image-20230929161139952](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202309291611011.png)

## æ€»ç»“

Nest å¯¹æ¯ç§ä¸åŒçš„ REST API éƒ½åšäº†å°è£…ï¼Œå¹¶ä¸”æœ‰ä¸åŒçš„ Typescript è£…é¥°å™¨æ–¹ä¾¿æˆ‘ä»¬è·å–æ•°æ®ã€‚

å…¶ä¸­ä½¿ç”¨ URL ä¼ è¾“çš„ä¸ºï¼š

- url paramï¼Œå³`http://localhost/user/:id`ï¼Œä½¿ç”¨@Param è£…é¥°å™¨å–æ•°æ®

- url query ,å³`http://localhost/user?id=xxx`ï¼Œä½¿ç”¨@Query è£…é¥°å™¨å–æ•°æ®

ä½¿ç”¨ body ä¼ è¾“çš„ä¸ºï¼š

- form-urlencodedï¼Œå°† url query å­—ç¬¦ä¸² ç”¨ post æ–¹å¼ä¼ è¾“ï¼Œä½¿ç”¨@Body()è£…é¥°å™¨å–æ•°æ®

- jsonï¼Œjson æ•°æ®ä¼ è¾“ï¼Œä½¿ç”¨@Body()è£…é¥°å™¨å–æ•°æ®

- form-data ï¼Œé€‚ç”¨äºæ–‡ä»¶ä¸æ–‡æœ¬æ•°æ®ä¼ è¾“ï¼Œä½¿ç”¨@UploadedFiles è£…é¥°å™¨å–æ•°æ®

æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›è£…é¥°å™¨ï¼š

- @Get è£…é¥°å™¨å£°æ˜ get è¯·æ±‚ã€‚
- @Post è£…é¥°å™¨å£°æ˜ post è¯·æ±‚ã€‚
- @UseInterceptors è£…é¥°å™¨å¯ç”¨æ‹¦æˆªå™¨ã€‚
- @AnyFilesInterceptor è£…é¥°å™¨å¯¹æ–‡ä»¶è¿›è¡Œæ‹¦æˆªå¹¶ä¸”è§£æã€‚
