# å¦‚ä½•ç”¨ AWS å®ç°é‚®ä»¶å‘é€å’Œæ¥æ”¶

## SES

SES å…¨å `Simple Email Service`ï¼Œæ˜¯ Amazon æä¾›çš„ç”µå­é‚®ä»¶å‘é€æœåŠ¡ã€‚

### é…ç½® SES

åœ¨ä½¿ç”¨ SES å‘é€ç”µå­é‚®ä»¶ä¹‹å‰ï¼Œéœ€è¦é…ç½®åœ¨ Amazon ä¸­é…ç½®ä¸€ä¸‹ã€‚

è¿›å…¥ SES æœåŠ¡ä¸­ï¼Œç‚¹å‡» Identitiesï¼Œå¹¶ç‚¹å‡» Create identity æŒ‰é’®ï¼š

![image-20240413130536802](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404131305501.png)

æ¥ç€é€‰æ‹© Identity typeï¼Œè¿™å°†å†³å®šä½¿ç”¨ç‰¹å®šçš„ Domain å‘é€é‚®ä»¶è¿˜æ˜¯ä»…ä½¿ç”¨ç‰¹å®šçš„é‚®ç®±å‘é€ã€‚

![image-20240413131603352](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404131316388.png)

- é€‰æ‹© Email Address é…ç½®é‚®ç®±å‘é€ã€‚

  ![image-20240413131758848](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404131317888.png)

  å¡«å†™å¥½ Email åœ°å€åï¼Œç‚¹å‡»ç¡®å®šåˆ›å»ºã€‚

  Amazon ä¼šç»™è¯¥é‚®ç®±å‘é€ä¸€ä¸ªéªŒè¯é‚®ä»¶ã€‚

  ![img](https://d1.awsstatic.com/AmazonSES/send-email_4.4d78fe52dcd0e6cc5240c67fe7e40e5adb8cca4e.png)

  ç‚¹å‡» URL ç¡®è®¤ã€‚

  å†è¿”å› AWS æ§åˆ¶å°çš„ Identities ç®¡ç†é¡µé¢ï¼Œå½“æ˜¾ç¤ºè¯¥ Email åœ°å€ä¸º`Verified`åå³ä»£è¡¨ç”Ÿæ•ˆã€‚

  ![image-20240413132729203](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404131327266.png)

- é€‰æ‹© Domain type é…ç½® Domain å‘é€ã€‚

  æˆ‘ä»¬ç»å¸¸ä¼šæ”¶åˆ°è¿™æ ·ä¸€ç§é‚®ä»¶ï¼Œå®ƒæ¥è‡ªäºæŸä¸ªç½‘ç«™ï¼Œå®ƒå¯èƒ½é•¿è¿™æ ·ï¼š

  ![image-20240420210724843](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404202107880.png)

  å…¶ä¸­ `algolia.com`å°±æ˜¯åŸŸåã€‚`no-reply@algolia.com`æ˜¯æ¥è‡ªäºè¿™ä¸ªåŸŸåçš„ã€‚

  ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ SES ä¸­é…ç½® Domainã€‚

  ![image-20240420212220530](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404202122564.png)

  è¾“å…¥å¯¹åº”çš„åŸŸååï¼Œç‚¹å‡» Create identity æŒ‰é’®ã€‚

  æ¥ç€å°±ä¼šçœ‹åˆ°ä¸€æ®µä¿¡æ¯ï¼š

  ![image-20240420212815689](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404202128746.png)

  åœ¨ publish record ä¸­æ‰¾åˆ°å¯¹åº”çš„ CNAMEï¼Œæ‹·è´åˆ°åŸŸåæ‰˜ç®¡çš„ DNS è®°å½•ä¸­ã€‚

  ![image-20240420213025247](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404202130282.png)

  > å¦‚æœä½ çš„åŸŸåæ˜¯ç”¨ Route 53 æ‰˜ç®¡çš„ï¼Œé‚£ä¹ˆ AWS ä¼šè‡ªåŠ¨å¸®ä½ æ·»åŠ åˆ° Route 53 ä¸­ã€‚
  >
  > å¦‚æœä½ çš„åŸŸåç”¨å…¶ä»–å¹³å°ï¼ˆè…¾è®¯äº‘ã€é˜¿é‡Œäº‘ï¼‰ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨æ‹·è´è®°å½•åˆ° DNS è®°å½•ä¸­ã€‚

  ç”±äºæˆ‘çš„åŸŸåæ˜¯äº¤ç»™ Route 53 æ‰˜ç®¡çš„ï¼Œæ‰€ä»¥ä¼šè‡ªåŠ¨å¸®æˆ‘æ‹·è´è¿‡å»ã€‚

  ![image-20240420213624251](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404202136290.png)

  ç„¶åç­‰å¾…å®¡æ ¸ï¼Œå®¡æ ¸é€šè¿‡åä¹Ÿä¼šæœ‰ä¸€ä¸ª Verified çŠ¶æ€ã€‚

  ![image-20240413132617071](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404131326113.png)

  å½“çœ‹åˆ°è¿™ä¸ªçŠ¶æ€ï¼Œæ„å‘³ç€é…ç½®ç”Ÿæ•ˆäº†ã€‚

### å‘é€æµ‹è¯•é‚®ä»¶

æˆ‘ä»¬ä»¥ domain ä¸ºä¾‹ï¼Œç‚¹å‡»å‘é€æµ‹è¯•é‚®ä»¶ã€‚

![image-20240420214247970](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404202142006.png)

ç„¶åå¡«å†™ no-reply ä½œä¸º `subdomain`,å¡«å†™ä½ æƒ³è¦é€è¾¾çš„é‚®ç®±åœ°å€å’Œé‚®ä»¶å†…å®¹ï¼š

![image-20240420214738173](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404202147204.png)

> è¿™é‡Œæœ‰ä¸€ä¸ªå°çš„æ³¨æ„ç‚¹ï¼Œå¦‚æœå½“å‰è¿˜æ˜¯ SES æ²™ç›’æ¨¡å¼ï¼Œå°±åªèƒ½å‘é€ç»™å·²éªŒè¯è¿‡çš„é‚®ç®±ï¼ˆæˆ–è€…å·²éªŒè¯è¿‡çš„åŸŸåä¸‹çš„é‚®ç®±ï¼‰ã€‚
>
> å¯¹æ­¤ AWS åšäº†æç¤ºï¼Œå°±æ˜¯è¿™è¡Œå°å­—ã€‚
>
> ![image-20240420215421673](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404202154748.png)

æœ€åç‚¹å‡»å‘é€ã€‚

å¦‚æœæ²¡æœ‰æ„å¤–çš„è¯ï¼Œä½ å°†æ”¶åˆ°è¿™å°é‚®ä»¶ï¼š

![image-20240420210600452](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404202106795.png)

## SNS

æˆ‘ä»¬çš„ç½‘ç«™æœ‰å¯èƒ½ä¼šæœ‰ä¸“é—¨ç”¨äºå¤„ç†æ¥æ”¶é‚®ä»¶çš„åº”ç”¨ç¨‹åºä»£ç ï¼Œæ¯”å¦‚æ¥å—åˆ°ä¸€å°é‚®ä»¶åè½¬å‘ç»™å¯¹åº”çš„å¤„ç†ä¸“å‘˜ï¼›æˆ–è€…æ¥æ”¶é‚®ä»¶åï¼Œä¸ºç”¨æˆ·ç”Ÿæˆä¸€ä¸ªè®¢å•ã€‚

å¯¹æ­¤ï¼Œå‘å¸ƒè®¢é˜…æ¨¡å¼æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¤„ç†æ–¹æ¡ˆã€‚

è¿™ä¸ªæ–¹æ¡ˆå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š

1. ç»™æ¥æ”¶åˆ°çš„é‚®ä»¶é…ç½®ä¸€ä¸ª publishï¼Œè®©é‚®ä»¶å¯ä»¥å‘å¸ƒå‡ºæ¥ã€‚
2. è®¢é˜…è¯¥å‘å¸ƒè¡Œä¸ºï¼Œå½“æ‹¿åˆ°å‘å¸ƒçš„å†…å®¹åï¼Œè®©å†…å®¹è½¬å‘åˆ°æˆ‘ä»¬è‡ªå·±å†™çš„ API ä¸­ã€‚

**ç”¨ SNS å®ç°**

Amazon Simple Notification Service (SNS) å°±æ˜¯ä¸€ä¸ª AWS æä¾›çš„å®Œå…¨æ‰˜ç®¡çš„å‘å¸ƒ/è®¢é˜…æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿã€‚

é€šè¿‡ SNS å’Œ SES çš„ç»“åˆï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾å®ç°æ¥æ”¶é‚®ä»¶å¹¶å¤„ç†çš„é€»è¾‘ã€‚

åœ¨ SES çš„ Configuration ä¸­ï¼Œç‚¹å‡» Email receivingï¼Œå¹¶åœ¨å³ä¾§ç‚¹å‡» Create rule Setã€‚

![image-20240420221532655](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404202215689.png)

æ·»åŠ  rule name

![image-20240422102944319](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221029440.png)

è®¾ç½®æ¡ä»¶

![image-20240422103032356](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221030392.png)

è®¾ç½® action

![image-20240422103059638](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221030680.png)

å¦‚æœæ­¤æ—¶æ²¡æœ‰ SNS topicï¼Œåˆ™è¦åˆ›å»ºä¸€ä¸ª

![image-20240422103149074](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221031118.png)

![image-20240422103334938](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221033988.png)

å®Œæˆåˆ›å»ºåé€‰æ‹©è¯¥ topicï¼Œå¹¶ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œç¡®è®¤æ— è¯¯åï¼Œç‚¹å‡» Create ruleã€‚

æœ€åè¿”å›åˆ°åˆ—è¡¨é¡µï¼ŒæŸ¥çœ‹å·²ç»è®¾ç½®å®Œæˆçš„ rule åˆ—è¡¨ã€‚

![image-20240422103546168](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221035215.png)

è™½ç„¶ Status å·²ç»æ˜¯ Enabled çŠ¶æ€äº†ï¼Œä½†æ˜¯è¿˜éœ€è¦å°†å…¶è®¾ç½®ä¸º active æ‰èƒ½çœŸæ­£ç”Ÿæ•ˆã€‚

ç‚¹å‡»`Set as active`æŒ‰é’®ï¼Œæœ€ç»ˆçš„ç»“æœåº”å½“æ˜¯è¿™æ ·çš„ï¼š

![image-20240422123636895](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221236995.png)

**åˆ›å»ºè®¢é˜…**

ç°åœ¨æˆ‘ä»¬å·²ç»å°†æ¥æ”¶åˆ°çš„é‚®ä»¶ç”¨ SNS å‘å¸ƒäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯åˆ›å»ºè®¢é˜…ã€‚

åœ¨ SNS ä¸­ï¼Œç‚¹å‡»åˆšæ‰åˆ›å»ºçš„ `email-receiving-publish` topicã€‚

![image-20240422104555373](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221045425.png)

åˆ›å»ºä¸€ä¸ªè®¢é˜…

![image-20240422104654460](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221046516.png)

é€‰æ‹© protocol

![image-20240422104837413](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221048463.png)

è¿™é‡Œå¯é€‰çš„å¾ˆå¤šï¼Œæˆ‘å°†ä»¥ HTTPS ä¸ºä¾‹ï¼Œè®© SNS æ¥å—åˆ°çš„é‚®ä»¶èƒ½å¤Ÿè½¬å‘åˆ°æˆ‘çš„æœ¬åœ° API ä¸­ã€‚

å…ˆåœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ª Adonisjs ç®€æ˜“çš„ API ç¨‹åºï¼š

```js
Route.post('/', async ({ request, response }: HttpContextContract) => {
  console.log('â€”â€”â€”â€”â€”â€”ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ â€”â€” Route.get â€”â€” request:', request.raw())
  response.send('Hello world')
})
```

å†å¼€å¯ä¸€ä¸ª ngrok ä»¥æ˜ å°„åˆ°å…¬ç½‘ä¸Šï¼š

```bash
ngrok http 3000
```

ç¡®ä¿ä½¿ç”¨ ngrok æä¾›çš„å…¬ç½‘åŸŸåèƒ½å¤Ÿè®¿é—®åˆ°ä½ çš„æœ¬åœ°ç¨‹åºï¼š

![image-20240422114840558](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221148645.png)

ç„¶åå°†è¿™ä¸ªå…¬ç½‘åŸŸåå¡«å†™åˆ° SNS ä¸Šã€‚

![image-20240422105750419](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221057477.png)

ç‚¹å‡» `Create subscription`æŒ‰é’®ã€‚

ä½ å°†åœ¨æ§åˆ¶å°çœ‹åˆ° SubscribeURL è¿™ä¸ªå­—æ®µï¼š

![image-20240422112811334](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221128392.png)

è¿™æ˜¯ AWS å‘é€çš„ç¡®è®¤èº«ä»½çš„ URLï¼Œæ‰“å¼€å®ƒä»¥éªŒè¯èº«ä»½ä»è€Œä½¿å¾—è®¢é˜…ç”Ÿæ•ˆã€‚

éªŒè¯æˆåŠŸåï¼Œä½ çš„ subscription å°†å˜æˆ **Confirmed** çŠ¶æ€ã€‚

![image-20240422113150418](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221131508.png)

**è®¾ç½® MX è®°å½•**

*é‚®ä»¶äº¤æ¢å™¨*è®°å½•ï¼ˆ_MX è®°å½•_ï¼‰æ˜¯ä¸€ç§é…ç½®ï¼ŒæŒ‡å®šå“ªäº›é‚®ä»¶æœåŠ¡å™¨å¯ä»¥æ¥å—å‘é€åˆ°ä½ çš„åŸŸåçš„ç”µå­é‚®ä»¶ã€‚

è¦è®© Amazon SES ç®¡ç†æ‚¨çš„ä¼ å…¥ç”µå­é‚®ä»¶ï¼Œéœ€è¦å°† MX è®°å½•æ·»åŠ åˆ°åŸŸçš„ DNS é…ç½®ä¸­ã€‚

æˆ‘ä»¬åˆ° Route 53 ä¸­é…ç½®ä¸€ä¸‹ MX è®°å½•ã€‚

![image-20240422124324180](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221243241.png)

è®°å½•åç§°æ˜¯æˆ‘ä»¬éœ€è¦æ¥æ”¶é‚®ä»¶çš„åŸŸåã€‚

å€¼æ˜¯å›ºå®šçš„ï¼Œæ ¼å¼æ˜¯è¿™æ ·çš„ï¼š

```bash
10 inbound-smtp.<region>.amazonaws.com
```

å°† region æ”¹æˆç”¨æˆ·çš„ AWS åŒºåŸŸå³å¯ã€‚

ä¾‹å¦‚æˆ‘è®¾ç½®çš„ä½ç½®æ˜¯ Toykoï¼Œæ‰€ä»¥å°±æ˜¯ `ap-northeast-1`ã€‚

æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼š

![image-20240422113427788](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221134848.png)

å‘é€åï¼Œä½ çš„ç»ˆç«¯åº”è¯¥å°±å¯ä»¥æ‰“å°å‡ºæ¥å—åˆ°çš„é‚®ä»¶çš„å†…å®¹äº†ï¼š

![image-20240422124834356](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202404221248448.png)

å¦‚æœæƒ³è¦è§£æ email çš„åŸå§‹å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼äº [mailparser](https://github.com/nodemailer/mailparser)è¿™æ ·çš„ npm åŒ…è§£æå‡ºå®Œæ•´çš„ Email ä¿¡æ¯ã€‚

## æ€»ç»“

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°† AWS çš„ SES å’Œ SNS ç»“åˆï¼Œå®Œæˆäº†å‘é€é‚®ä»¶å’Œæ¥æ”¶é‚®ä»¶çš„é€»è¾‘ã€‚

åœ¨ SES çš„é…ç½®ä¸­ï¼Œåˆ†æˆ domain å’Œ email ä¸¤ä¸ªç±»å‹ã€‚

1. domain å°±æ˜¯ä½ çš„ç½‘ç«™çš„åŸŸï¼Œå¦‚æœä½ æƒ³è¦ç”¨ä½ çš„ç½‘ç«™ä½œä¸ºå‘é€äººæ¥å‘é€ä¿¡æ¯ï¼Œå°±éœ€è¦é…ç½®å®ƒã€‚
2. email å°±æ˜¯ç‰¹å®šçš„é‚®ç®±ï¼Œå¦‚æœä½ æœ‰ç‰¹å®šçš„é‚®ç®±æ¥å‘é€ä¿¡æ¯ï¼Œå°±éœ€è¦é…ç½®å®ƒã€‚

æ¥æ”¶é‚®ä»¶çš„é…ç½®è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š

1. åœ¨ SES ä¸­é…ç½®æ¥æ”¶è§„åˆ™ã€‚
2. æ¥æ”¶è§„åˆ™ä¸­å¯ä»¥æŒ‡å®šæ¥æ‰‹ååšçš„ actionï¼Œè¿™é‡Œæ˜¯å°†å…¶å‘å¸ƒç»™ SNSã€‚
3. åœ¨ SNS ä¸­ï¼Œæˆ‘ä»¬é…ç½®äº†ä¸€ä¸ªè®¢é˜…ï¼Œå°†é‚®ä»¶å†…å®¹å‘å¸ƒåˆ°æœ¬åœ° API ä¸­ã€‚
4. é…ç½®å®Œ SES æ¥æ”¶è§„åˆ™åï¼Œéœ€è¦è®¾ç½®æˆ active çŠ¶æ€æ‰çœŸæ­£ç”Ÿæ•ˆã€‚
5. SES å’Œ SNS éƒ½é…ç½®å®Œåï¼Œè¿˜è¦è®°å¾—é…ç½® MX è®°å½•ï¼Œè¿™æ ·é‚®ä»¶å¯ä»¥å‘é€åˆ° AWS çš„é‚®ä»¶æœåŠ¡å™¨ä¸­å¹¶ä¸”è¢« SES å¤„ç†ã€‚
