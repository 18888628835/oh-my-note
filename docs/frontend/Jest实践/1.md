# Jest åŸºç¡€

## åˆ›å»ºé¡¹ç›®

å»ºé¡¹ç›®

```bash
mkdir jest-ts
cd jest-ts
npm init -y
```

å®‰è£… jestã€ts-node å’Œ typescript ä»¥åŠä¸€äº›ç±»å‹å£°æ˜æ–‡ä»¶

```bash
npm i -D jest @types/jest @jest/types ts-node typescript
npx jest --init
```

`--init`æ˜¯ç”¨`jest-cli`åˆå§‹åŒ– `jest` é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®æç¤ºå’Œè‡ªå·±çš„éœ€æ±‚é…ç½®å³å¯ã€‚

è¿™é‡Œè´´ä¸€ä¸‹æˆ‘çš„é…ç½®

![image-20230224210849945](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052016162.png)

è§£é‡Šä¸€ä¸‹ï¼š

- ç¬¬ä¸‰ä¸ªé€‰é¡¹â€”â€”å‰ç«¯æµ‹è¯•ä¼šæ¶‰åŠ dom æ“ä½œï¼Œæ‰€ä»¥ç”¨ browser-likeï¼Œå¦‚æœæ˜¯ node ç¯å¢ƒï¼Œåˆ™å¯ä»¥é€‰ nodeã€‚
- ç¬¬å››ä¸ªé€‰é¡¹â€”â€”è¦†ç›–ç‡æŠ¥å‘Šï¼Œéœ€è¦ç”¨åˆ°
- ç¬¬äº”ä¸ªé€‰é¡¹â€”â€”ç”¨ babel å¯ä»¥é¿å…æŸäº›å…¼å®¹æ€§é—®é¢˜
- æµ‹è¯•å®Œæˆåè‡ªåŠ¨æ¸…ç† mockï¼Œå®ä¾‹ç­‰ç¼“å­˜ä»¥é¿å…ç”¨ä¾‹ä¹‹é—´äº’ç›¸å½±å“

> å³ä½¿é€‰é¡¹ä¸ä¸€è‡´ä¹Ÿæ²¡é—®é¢˜ï¼Œå› ä¸ºåé¢å¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶æ¥ä¿®æ”¹ä¸Šé¢çš„é€‰æ‹©é…ç½®

æ‰§è¡Œå®Œä¹‹åï¼Œä¼šç”Ÿæˆ`jest.config.js`çš„é…ç½®æ–‡ä»¶ã€‚

## TS Support

æƒ³è¦æ”¯æŒ TypeScriptï¼Œå°±å¿…é¡»è½¬è¯‘ ts ä»£ç ã€‚

Jest æœ¬èº«ä¸æ”¯æŒä»£ç è½¬è¯‘ã€‚åœ¨æ‰§è¡Œæ—¶ä¼šè°ƒç”¨**è½¬è¯‘å™¨/ç¼–è¯‘å™¨**åšä»£ç è½¬è¯‘ã€‚

è¿™æ ·å°±èƒ½å¤Ÿå¯¹ TypeScript è½¬è¯‘æˆ JS ä»£ç ä»è€Œè®© Jest æ”¯æŒå¯¹ TypeScript çš„æµ‹è¯•ã€‚

è½¬è¯‘å™¨æœ‰ä¸¤ç§ï¼Œæˆ‘ä¸»è¦ä½¿ç”¨ `babel`ä»¥å‡å°‘æŸäº›å…¼å®¹æ€§å¯¼è‡´çš„å½±å“ã€‚

### ä½¿ç”¨ ts-jest

```bash
npm i -D ts-jest
```

- å®‰è£… ts-jest ã€‚ts-jest ç”¨æ¥è½¬è¯‘ TypeScript çš„ä»£ç 
- æŒ‰ç…§ jest ç±»å‹å£°æ˜
- ts-node ç”¨æ¥å¯åŠ¨ TypeScript ä»£ç 

> ts-jest çš„å¤§ç‰ˆæœ¬è¦å’Œ jest çš„ä¸€è‡´ï¼Œå¦åˆ™å®¹æ˜“äº§ç”Ÿå…¼å®¹é—®é¢˜ã€‚

ç”Ÿæˆ TypeScript é…ç½®æ–‡ä»¶

```bash
tsc --init
```

åœ¨`jest.config.js`ä¸­æ·»åŠ é…ç½®ï¼š

```js
module.exports = {
  transform: {
    '^.+\\.ts?$': 'ts-jest',
  },
  ...
  }
```

### babal è½¬è¯‘

```bash
npm install --save-dev babel-jest @babel/core @babel/preset-env @babel/preset-react @babel/preset-typescript
```

è¿™é‡Œä¸»è¦å®‰è£… babel çš„é¢„è®¾æ’ä»¶å’Œ react ä»¥åŠ typescript çš„é¢„è®¾æ’ä»¶ã€‚

å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬åœ¨æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª `babel.config.js` æ–‡ä»¶ç”¨äº babel çš„é…ç½®

```js
module.exports = {
  presets: [
    ['@babel/preset-env', { targets: { node: 'current' } }],
    ['@babel/preset-react', { runtime: 'automatic' }], // è‡ªåŠ¨å¯¼å…¥react
    '@babel/preset-typescript',
  ],
}
```

## å¼•å…¥ dom ç¯å¢ƒ

ä¸ºäº†è¿˜åŸæµè§ˆå™¨çš„å…¨éƒ¨åŠŸèƒ½ï¼Œéœ€è¦å¼•å…¥ jest æä¾›çš„ jsdom ç¯å¢ƒã€‚

jest 28 ç‰ˆæœ¬éœ€è¦é¢å¤–å®‰è£…ä¾èµ–

```bash
npm i -D jest-environment-jsdom
```

`jest-environment-jsdom`å¯ä»¥çœ‹æˆæ˜¯ç‹¬ç«‹çš„åŒ…ï¼Œå®ƒå†…éƒ¨å®ç°äº†æµè§ˆå™¨çš„å¤§éƒ¨åˆ†åŠŸèƒ½ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ Jest ç‰ˆæœ¬çš„ä»¿æµè§ˆå™¨å®¿ä¸»ç¯å¢ƒã€‚

å½“è¿™ä¸ªåŒ…å®‰è£…å¥½ä¹‹åï¼Œéœ€è¦è®© Jest è¯†åˆ«åˆ°è¿™ä¸ªç¯å¢ƒï¼Œæœ‰ä¸¤ç§ä¸åŒçš„æ–¹æ³•:

1. åœ¨ `jest.config.js`ä¸­é…ç½®

   ```js
   module.exports = {
     testEnvironment: 'jest-environment-jsdom',
     ...
     }
   ```

2. å°†è¿™ä¸ªåŒ…ä½œä¸ºå…¨å±€ mock

   åœ¨ src ç›®å½•ä¸‹åˆ›å»º test ç›®å½•ï¼Œå¹¶åˆ›å»º setup.ts æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

   ```js
   // setup.ts
   import 'jest-environment-jsdom'
   ```

   åœ¨`jest.config.js`ä¸­é…ç½®

   ```js
   module.exports = {
     setupFilesAfterEnv: ['./src/test/setup.ts'],
     ...
     }
   ```

   è¿™ä¸ªé€‰é¡¹æ˜¯ç”¨æ¥æ‰§è¡Œè£…è½½æ–‡ä»¶çš„â€”â€”å½“ Jest æµ‹è¯•ç¯å¢ƒå¯åŠ¨åï¼Œä¼šå°†æŒ‡å®šè·¯å¾„ä¸‹çš„æ–‡ä»¶è¿è¡Œä¸€éï¼Œä¸€èˆ¬ç”¨æ¥è£…è½½å…¨å±€ mock ç¯å¢ƒã€‚

   å¾ˆå¤šç¬¬ä¸‰æ–¹çš„ mock æ’ä»¶å®‰è£…åéƒ½ä¼šç»è¿‡ setup æ–‡ä»¶ç»™ Jest ç¯å¢ƒè£…è½½æŸäº›åŠŸèƒ½ã€‚

   > è·Ÿ `setupFilesAfterEnv` ç±»ä¼¼è¿˜æœ‰ä¸€ä¸ª `setupFiles` é€‰é¡¹ï¼Œå®ƒä¹Ÿå¯ä»¥ç”¨æ¥è®¾ç½®å…¨å±€ Mock æ•°æ®ã€‚
   >
   > ![image-20221016031742426](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052016631.png)
   >
   > `setupFiles` æ¯” `setupFilesAfterEnv`æ›´æ—©æ‰§è¡Œï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç”¨æ¥è®¾ç½® Mock å…¨å±€å˜é‡ã€‚
   >
   > ä¸åŒä¹‹å¤„åœ¨äºï¼Œç”±äº`setupFilesAfterEnv`æ˜¯åœ¨å¼•å…¥æµ‹è¯•æ¡†æ¶ Jest ä¹‹åè¿è¡Œçš„ï¼Œæ‰€ä»¥èƒ½å¤Ÿåœ¨æ­¤å¼•å…¥å’Œé…ç½®`Jset/Jasmine`çš„æ’ä»¶ã€‚
   >
   > å¦‚æœåœ¨`setupFiles`ä¸­æ·»åŠ  Jest çš„æ‰©å±•å’Œæ’ä»¶ï¼Œå°±ä¼šå¾—åˆ°æŠ¥é”™ã€‚
   >
   > è¿™é‡Œæœ‰ä¸ª [issue](https://github.com/testing-library/jest-dom/issues/122#issuecomment-650520461) å¯ä»¥å‚è€ƒ

## é¢å¤–æ‰©å±•

1. é¢å¤–çš„æ‰©å±•åè¯†åˆ«

   å› ä¸º Jest ä¸ä½¿ç”¨ Webpack ç­‰æ‰“åŒ…å·¥å…·ï¼Œå› æ­¤å®ƒä¸çŸ¥é“å¦‚ä½•åŠ è½½é™¤ js/jsx ä¹‹å¤–çš„å…¶ä»–æ–‡ä»¶æ‰©å±•åï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºå®ƒåŠ ä¸€ä¸ªè½¬æ¢å™¨ã€‚

   ```js
   // jest.config.ts
   export default {
     // ... other config
     transform: {
       // ...
       '^.+.(js|ts|tsx)$': '<rootDir>/node_modules/babel-jest',
     },
   }
   ```

2. SVG mock

   æˆ‘ä»¬é¡¹ç›®ä¸­å¯èƒ½ä¼šæœ‰ç”¨åˆ° svg ç­‰å›¾ç‰‡ï¼Œè¿™ä¸ªå¯¹äº Jest æ˜¯æ— æ³•è¯†åˆ«çš„ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å®ƒè¿›è¡Œ mockï¼Œè¿”å›ç›¸åŒçš„è¾“å‡ºç»“æœã€‚

   ```js
   // jest.config.ts
   export default {
     // ... other config
     transform: {
       // ...
       '^.+.svg$': '<rootDir>/mock/svg-transform.js',
     },
   }
   ```

   ```js
   // mock/svg-transform.js
   module.exports = {
     process() {
       return { code: 'module.exports = {};' }
     },
     getCacheKey() {
       return 'svgTransform' // SVGå›ºå®šè¿”å›è¿™ä¸ªå­—ç¬¦ä¸²
     },
   }
   ```

3. CSS ä»£ç†

   Jest æœ¬èº«ä¸çŸ¥é“å¦‚ä½•å¤„ç†ä¸åŒæ‰©å±•çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®ä»£ç†çš„æ–¹å¼ï¼Œå‘Šè¯‰ Jest å°†æ­¤å¯¹è±¡æ¨¡æ‹Ÿä¸ºå¯¼å…¥çš„ CSS æ¨¡å—ã€‚

   ```bash
   npm install --save-dev identity-obj-proxy
   ```

   ```js
   // jest.config.ts
   export default {
     // ... other config
     moduleNameMapper: {
       '.(css|less|sass|scss)$': 'identity-obj-proxy',
     },
   }
   ```

## æµ‹è¯• TypeScript ä»£ç 

**æµ‹è¯• sum å‡½æ•°**

```js
// src/utils/sum.ts
export function sum(a: number, b: number) {
  return a + b
}
```

```js
// src/test/sum.test.ts
import { sum } from '../utils/sum'

describe('æµ‹è¯• sum å‡½æ•°', () => {
  it('ç›¸åŠ ', () => {
    expect(sum(1, 2)).toBe(3)
  })
})
```

**æµ‹è¯•æ˜¯å¦æ”¯æŒ DOM**ç¯å¢ƒ

```js
// src/utils/dom.ts
export function addDiv() {
  const div = document.createElement('div')
  document.body.append(div)
}
```

```js
// src/test/dom.test.ts
import { addDiv } from '../util/dom'

describe('æµ‹è¯•æ˜¯å¦æ”¯æŒæµè§ˆå™¨ç¯å¢ƒ', () => {
  it('addDiv', () => {
    addDiv()
    expect(document.body.querySelectorAll('div')).toHaveLength(1)
  })
})
```

é¡¹ç›®ç»“æ„

```bash
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ test
â”‚   â”‚   â”œâ”€â”€ dom.test.ts
â”‚   â”‚   â”œâ”€â”€ setup.ts
â”‚   â”‚   â””â”€â”€ sum.test.ts
â”‚   â””â”€â”€ util
â”‚       â”œâ”€â”€ dom.ts
â”‚       â””â”€â”€ sum.ts
â””â”€â”€ tsconfig.json
```

å¯åŠ¨æµ‹è¯•ï¼š

```
npm run test
```

å¾—åˆ°è¦†ç›–ç‡æŠ¥å‘Š

![image-20221105232754102](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052016247.png)

## è‡ªåŠ¨è¿è¡Œ jest

å¦‚æœå¸Œæœ›èƒ½å¤Ÿåœ¨ä¿®æ”¹ test æ–‡ä»¶åè‡ªåŠ¨è¿è¡Œ jestï¼Œæˆ‘ä»¬éœ€è¦åœ¨`package.json`çš„è„šæœ¬å‘½ä»¤ååŠ ä¸Š`--watchAll`ï¼š

```json
  "scripts": {
    "test": "jest --watchAll"
  },
```

`--watchAll` ä¼šåœ¨å˜æ›´åæµ‹è¯•æ‰€æœ‰çš„æ–‡ä»¶ã€‚

å¦‚æœåªå¸Œæœ›æµ‹è¯•å˜æ›´è¿‡çš„æ–‡ä»¶ï¼Œåˆ™å¯ä»¥æ”¹æˆ

```json
  "scripts": {
    "test": "jest --watch"
  },
```

åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œä¼šè‡ªåŠ¨è¿è¡Œ `o æ¨¡å¼` â€”â€”å‚è§ [æµ‹è¯•æ—¶å‘½ä»¤æ¨¡å¼](#æµ‹è¯•æ—¶å‘½ä»¤æ¨¡å¼)

## å•æ–‡ä»¶æµ‹è¯•

å¦‚æœåªæƒ³è¦æµ‹è¯•ä¸€ä¸ª js æ–‡ä»¶ï¼Œåˆ™ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
npm run test <æ–‡ä»¶ç›¸å¯¹è·¯å¾„>
```

ä¾‹å¦‚ï¼š

```bash
 npm run test ./src/test/sum.test.ts
```

## è¦†ç›–ç‡æŠ¥å‘Š

ç»ˆç«¯å±•ç¤ºçš„æ˜¯è¦†ç›–ç‡æƒ…å†µï¼Œè¿˜æœ‰æ›´åŠ è¯¦ç»†çš„è¦†ç›–ç‡æŠ¥å‘Šã€‚

è¦†ç›–ç‡æŠ¥å‘Šåœ¨æ–°ç”Ÿæˆçš„`coverage`ç›®å½•ä¸­ï¼Œæœ‰ä¸åŒæ ¼å¼çš„è¦†ç›–ç‡æŠ¥å‘Š

```bash
â”œâ”€â”€ clover.xml
â”œâ”€â”€ coverage-final.json
â”œâ”€â”€ lcov-report
â”‚   â”œâ”€â”€ base.css
â”‚   â”œâ”€â”€ block-navigation.js
â”‚   â”œâ”€â”€ dom.ts.html
â”‚   â”œâ”€â”€ favicon.png
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ prettify.css
â”‚   â”œâ”€â”€ prettify.js
â”‚   â”œâ”€â”€ sort-arrow-sprite.png
â”‚   â”œâ”€â”€ sorter.js
â”‚   â””â”€â”€ sum.ts.html
â””â”€â”€ lcov.info
```

æˆ‘ä»¬å¯ä»¥æ‰“å¼€ index.html æ¥æŸ¥çœ‹ç½‘é¡µç‰ˆæœ¬çš„æŠ¥å‘Š

```js
cd coverage/lcov-report
hs -c-1 . // ç”¨ http-server æ‰“å¼€index.html
```

![image-20221105234317849](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052016987.png)

## è·¯å¾„åˆ«å

æ‰€è°“è·¯å¾„åˆ«åå°±æ˜¯æˆ‘å¸Œæœ›ä»è¿™ä¸ªå¼•å…¥ï¼š

```js
import { sum } from '../util/sum'
```

æ¢æˆè¿™ä¸ªå¼•å…¥

```js
import { sum } from 'util/sum'
```

å®é™…ä¸Šå°±æ˜¯æŠŠ`utils`æ˜ å°„æˆ`src/utils`ã€‚

é¦–å…ˆè¦åœ¨ `moduleDirectories`ä¸­é…ç½®

```json
// jest.config.js
 moduleDirectories: ['node_modules', 'src'],
```

è¿™é‡Œçš„æ„æ€æ˜¯è®© jest å¯ä»¥ç›´æ¥åˆ° `node_modules` æˆ–è€… `src` ä¸‹å»æ‰¾æ–‡ä»¶ã€‚

å…¶æ¬¡åœ¨`tsconfig`ä¸­é…ç½® path

```js
    "baseUrl": "./",
    "paths": {
      "util/*": ["src/util/*"]
    },
```

è¿™æ · ts æ–‡ä»¶å°±èƒ½å¤ŸæŒ‰ç…§ paths çš„é…ç½®å»å¯¹åº”çš„æ˜ å°„è·¯å¾„ä¸­æ‰¾åˆ°è¯¥æ–‡ä»¶ã€‚

å¦‚æœè¦æ”¹æˆè¿™æ ·å¼•å…¥ï¼š

```js
import { addDiv } from '@/util/dom'
```

`@`ä»£è¡¨`src`ã€‚

jest æƒ³è¦è¯†åˆ«è¿™ä¸ªç¬¦å·å°±éœ€è¦åœ¨`moduleNameMapper`ä¸­é…ç½®ï¼š

```js
modulex.exports = {
  moduleNameMapper: { '@/(.*)': '<rootDir>/src/$1' },
}
```

è¿™æ˜¯ jest çš„è·¯å¾„åŒ¹é…ã€‚

ç„¶å tsconfig ä¸­ä¹ŸåŠ å…¥å¯¹`@`çš„æ˜ å°„ã€‚

```js
    "baseUrl": "./",
    "paths": {
      "utils/*": ["src/utils/*"],
      "@/*": ["src/*"]
    },
```

æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥ç”¨ä¸¤ç§æ–¹å¼å¼•å…¥å•¦

```js
import { sum } from '@/utils/sum'
// import { sum } from 'utils/sum';

describe('sum', () => {
  it('å¯ä»¥ç›¸åŠ ', () => {
    expect(sum(1, 1)).toEqual(2)
  })
})
```

## æµ‹è¯•ä»£ç å¦‚ä½• debug

åœ¨ vscode ä¸Šç”¨ Typescript æ‰“æ–­ç‚¹å®åœ¨è¿‡äºéº»çƒ¦ï¼Œéœ€è¦å„ç§é…ç½®ï¼Œè€Œä¸”ç»“åˆ jest ä¼šé‡åˆ°å„ç§å„æ ·çš„é—®é¢˜ã€‚

è¿™é‡Œä»‹ç»ä¸€ç§ç®€å•çš„ï¼Œé€šè¿‡ chrome æµè§ˆå™¨çš„ dev-tool æ‰“æ–­ç‚¹çš„æ–¹æ³•ï¼š

åœ¨`package.json`ä¸­é…ç½®ä¸€ä¸ªè„šæœ¬ï¼š

```js
    "debug": "node --inspect ./node_modules/jest/bin/jest --runInBand --no-cache --no-watchman"
```

æ‰“å¼€ chrome æµè§ˆå™¨ï¼Œåœ¨åœ°å€æ è¾“å…¥

```
chrome://inspect/
```

ç‚¹å‡»è¿™é‡Œï¼š

![image-20230224234051591](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052016667.png)

åœ¨ä»£ç ä¸­è¾“å…¥`debugger`ï¼Œç„¶åæ‰§è¡Œ`npm run debug`ï¼Œä¼šå‡ºç°ä»¥ä¸‹`chrome inspect`ç•Œé¢

![2023-02-24.234344](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052017253.png)

ç„¶åå°±å¯ä»¥æ„‰å¿«åœ°æ‰“æ–­ç‚¹+è°ƒè¯•ä»£ç å•¦ã€‚

## å‘½ä»¤æ¨¡å¼

åœ¨`--watch<All>`çš„æƒ…å†µä¸‹ï¼Œä¼šæœ‰ä¸€ç§äº¤äº’å‹çš„å‘½ä»¤æ¨¡å¼ã€‚

![image-20221023223817345](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052017812.png)

- f åªè·‘å¤±è´¥çš„ç”¨ä¾‹
- o åªæµ‹è¯•æ”¹å˜çš„æ–‡ä»¶ï¼ˆé…åˆ git ä½¿ç”¨,ç›¸å½“äº --watchï¼‰
- p æ ¹æ®æ­£åˆ™è¡¨è¾¾å¼æµ‹è¯•å¯¹åº”çš„æ–‡ä»¶åé‡Œçš„ç”¨ä¾‹
- t æ ¹æ®æ­£åˆ™è¡¨è¾¾å¼æµ‹è¯• test å‡½æ•°é‡Œå¯¹åº”çš„ name çš„ç”¨ä¾‹
- q é€€å‡º watch æ¨¡å¼
- i ä»¥äº¤äº’æ–¹å¼è¿è¡Œå¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹
- enter é‡æ–°è§¦å‘ä¸€æ¬¡æµ‹è¯•
- a æµ‹è¯• all æ–‡ä»¶ï¼ˆç›¸å½“äº --watchAllï¼‰

è¿™äº›å‘½ä»¤æ¨¡å¼ä¸»è¦åŠŸèƒ½æ˜¯æ›´å¥½åœ°æ”¯æ’‘ç”¨æˆ·å¯¹æµ‹è¯•çš„éœ€æ±‚ã€‚

> ã€å¼ºçƒˆæ¨èã€‘ç¼–è¾‘å™¨è¿˜å¯ä»¥ä¸‹è½½ Jest å®˜æ–¹æ’ä»¶ï¼Œç”¨å¯è§†åŒ–çš„ç•Œé¢æ”¯æ’‘ Jest æµ‹è¯•ï¼Œä¾‹å¦‚ VSCode å¹³å°ä¸‹çš„[Jest](https://marketplace.visualstudio.com/items?itemName=Orta.vscode-jest)

## æ–­è¨€åŒ¹é…å™¨

Jest ä½¿ç”¨**æ–­è¨€åŒ¹é…å™¨**æ¥å¸®åŠ©æˆ‘ä»¬ç¼–å†™åŸºæœ¬çš„æµ‹è¯•é¢„æœŸï¼Œä¸»è¦æ˜¯å¯¹ä¸€äº›æ•°æ®çš„é¢„æœŸåˆ¤æ–­ã€‚

åŒ¹é…å™¨ï¼ˆmatcherï¼‰æœ‰å¾ˆå¤šç§ï¼Œå¸¸è§çš„æœ‰ï¼š

- toBe åŒ¹é…ç®€å•æ•°æ®ç±»å‹æ˜¯å¦ç›¸ç­‰

  ```js
  expect(1 + 2).toBe(3)
  ```

- toEqual æ·±åº¦åŒ¹é…å¯¹è±¡å†…å®¹ç›¸ç­‰

  ```js
  expect({ age: 12 }).toEqual({ age: 12 })
  ```

- toBeNull æ˜¯å¦ä¸º null

  ```js
  let n = null
  expect(n).toBeNull()
  ```

- toBeUndefined æ˜¯å¦ä¸º undefined

  ```js
  let u = undefined
  expect(u).toBeUndefined()
  ```

- toBeFalsy æ˜¯å¦ä¸º å‡å€¼

  ```js
  let s = 0
  expect(s).toBeFalsy()
  ```

- toBeDefined æ˜¯å¦ä¸ºé undefined

  ```js
  let u = null
  expect(u).toBeDefined()
  ```

- toBeTruthy æ˜¯å¦ä¸º çœŸå€¼

  ```js
  let t = 1
  expect(t).toBeTruthy()
  ```

- not.to<xxx> åŒ¹é…å™¨å–å

  ```js
  let t = 1
  expect(t).not.toBeUndefined()
  ```

- toBeGreaterThan æ¯”æŸä¸ªå¤§

- toBeLessThan æ¯”æŸä¸ªå°

- toBeGreaterThanOrEqual å¤§äºæˆ–è€…ç­‰äº

- toBeLessThanOrEqual å°äºæˆ–è€…ç­‰äº

- toBeCloseTo æ˜¯å¦æ¥è¿‘äº,ç”¨äºæµ®ç‚¹æ•°çš„è®¡ç®—

  ```js
  expect(0.1 + 0.2).toBeCloseTo(0.3)
  ```

- toMatch å­—ç¬¦ä¸²æ˜¯å¦åŒ¹é…

- ```js
  expect('hello world').toMatch(/hello/)
  ```

- toContain æ•°ç»„æˆ–è€… Set ç»“æ„æ˜¯å¦åŒ…å«ä¸€ä¸ªé¡¹ï¼ˆç®€å•æ•°æ®ç±»å‹ï¼‰

  ```js
  expect(['123', '456']).toContain('123')
  ```

- toContainEqual æ•°ç»„æˆ–è€… Set ç»“æ„æ˜¯å¦åŒ…å«ä¸€ä¸ªé¡¹ï¼ˆå¤æ‚æ•°æ®ç±»å‹ï¼‰

  ```js
  expect([{ name: 'qxy' }]).toContainEqual({ name: 'qxy' })
  ```

- toThrow æ˜¯å¦æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸,å¯ä»¥ä¼ å…¥å­—ç¬¦ä¸²æ£€æŸ¥æŠ›å‡ºçš„å†…å®¹

  ```js
  expect(throwError).toThrowError()
  expect(throwError).toThrowError('get an error')
  ```

- toMatchObject åŒ¹é…å¯¹è±¡çš„å†…å®¹

  ```js
  expect({ name: 'qyx', age: 12 }).toMatchObject({ age: 12 })
  expect([{ name: 'qyx', age: 12 }]).toMatchObject([{ age: 12 }])
  ```

...ç­‰ç­‰

## æµ‹è¯•å¼‚æ­¥ä»£ç 

### æµ‹è¯• callback

```js
// fetchData.ts
import axios from 'axios'

export async function fetchData(callback: (d: any) => void) {
  const api = 'https://api.github.com/users/18888628835'
  axios.get(api).then((res) => callback(res.data))
}
```

```js
// fetchData.test.ts
import { fetchData } from '../util/fetchData'

describe('æµ‹è¯•å¼‚æ­¥å‡½æ•°', () => {
  it('fetchData callback', (done) => {
    fetchData((res) => {
      expect(res.login).toBe('18888628835')
      done()
    })
  })
})
```

`callback` ä¼šåœ¨ `then` åè¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œè¿™æ—¶å€™`fetchData`å‡½æ•°å·²ç»è°ƒç”¨å®Œæ¯•äº†ã€‚æˆ‘ä»¬è¯¥å¦‚ä½•å‘Šè¯‰ jestï¼Œè¿˜éœ€è¦ç­‰å¼‚æ­¥å‡½æ•°è°ƒç”¨ç»“æŸæµ‹è¯•æ‰ç®—å®Œæˆ?

jest æä¾›äº†ä¸€ä¸ª done å‡½æ•°ï¼Œåªæœ‰ done å‡½æ•°æ‰§è¡Œå®Œæˆï¼Œæ‰è¡¨ç¤ºæµ‹è¯•çš„å¼‚æ­¥å‡½æ•°è°ƒç”¨ç»“æŸäº†ã€‚

### æµ‹è¯• promise

é€šè¿‡ async await æ¥æµ‹è¯• promise

```js
import axios from 'axios'

describe('æµ‹è¯• promise', () => {
  function fetchData() {
    const api = 'https://api.github.com/users/18888628835'
    return axios.get(api)
  }
  it('async await', async () => {
    const res = await fetchData()
    expect(res.data.login).toBe('18888628835')
  })
})
```

é€šè¿‡ **then** å’Œ **return**

```js
describe('æµ‹è¯• promise', () => {
  function fetchData() {
    const api = 'https://api.github.com/users/18888628835'
    return axios.get(api)
  }
  it('é€šè¿‡ then å’Œ return', () => {
    return fetchData().then((res) => expect(res.data.login).toBe('18888628835'))
  })
})
```

é€šè¿‡ **resolves**

```js
describe('æµ‹è¯• promise', () => {
  function fetchData() {
    const api = 'https://api.github.com/users/18888628835'
    return axios.get(api)
  }
  it('é€šè¿‡ resolves', () => {
    return expect(fetchData()).resolves.toMatchObject({
      data: { login: '18888628835' },
    })
  })
})
```

### æµ‹è¯•æ˜¯å¦èƒ½ catch åˆ° error

é€šè¿‡**catch å’Œ assertions**

```js
import axios from 'axios'

describe('æµ‹è¯• catch error', () => {
  function fetchData() {
    const api = 'http://www.dell-lee.com/react/api/demo2.json'
    return axios.get(api)
  }
  it('fetchData fails with error', () => {
    expect.assertions(1)
    return fetchData().catch((e) => {
      console.log('ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ - e:', e.toString()) //e: AxiosError: Request failed with status code 404
      expect(e.toString().indexOf('404') > -1).toBe(true)
    })
  })
})
```

é€šè¿‡`expect.assertions`æ–­è¨€ expect è‡³å°‘èƒ½å¤Ÿæ‰§è¡Œä¸€æ¬¡ã€‚

å¦åˆ™ä¸Šé¢çš„ä»£ç å³ä½¿æ²¡æœ‰ catch åˆ° errorï¼Œä¹Ÿèƒ½é€šè¿‡æµ‹è¯•ã€‚å› ä¸º fetchData é¡ºåˆ©æ‰§è¡Œäº†ã€‚

é€šè¿‡ **rejects**å’Œ**toThrow**

```js
describe('æµ‹è¯•å¼‚æ­¥å‡½æ•°', () => {
  function fetchData() {
    const api = 'http://www.dell-lee.com/react/api/demo1.json'
    return axios.get(api)
  }
  it('fetchData with rejects and toThrow', () => {
    return expect(fetchData()).rejects.toThrow()
  })
})
```

é€šè¿‡ **try** å’Œ **catch**

```js
describe('æµ‹è¯•å¼‚æ­¥å‡½æ•°', () => {
  function fetchData() {
    const api = 'http://www.dell-lee.com/react/api/demo1.json'
    return axios.get(api)
  }
  it('fetchData', async () => {
    expect.assertions(1)
    try {
      await fetchData()
    } catch (error) {
      if (error instanceof Error) {
        expect(error.toString()).toMatch('Error')
      }
    }
  })
})
```

## é’©å­å‡½æ•°

é’©å­å‡½æ•°æ˜¯è‡ªåŠ¨è¿è¡Œçš„å›è°ƒå‡½æ•°ã€‚Jest å…è®¸æ¯æ¬¡åœ¨æ‰§è¡Œæµ‹è¯•å‰åè‡ªåŠ¨è¿è¡Œé’©å­å‡½æ•°é‡Œæ³¨å†Œçš„å‡½æ•°ã€‚

### beforeAll

ä¾‹å¦‚ï¼Œä¸‹é¢æœ‰ä¸€ä¸ª Counter ç±»

```js
export class Counter {
  number
  constructor() {
    this.number = 0
  }
  addOne() {
    this.number += 1
  }
  minusOne() {
    this.number -= 1
  }
}
```

å®ƒæœ‰ä¸€ä¸ª`addOne` å’Œä¸€ä¸ª`minusOne` çš„æ–¹æ³•

å½“æˆ‘å¯¹è¿™ä¸¤ä¸ªå‡½æ•°è¿›è¡Œæµ‹è¯•

```js
import { Counter } from '../util/counter'

let counter: Counter

describe('æµ‹è¯• counter', () => {
  beforeAll(() => {
    console.log('beforeAll', counter)
    counter = new Counter()
  })

  it('æµ‹è¯• addOne', () => {
    counter.addOne()
    expect(counter.number).toBe(1)
  })

  it('æµ‹è¯• minusOne', () => {
    counter.minusOne()
    expect(counter.number).toBe(0)
  })
})
```

ä¸Šé¢çš„ä»£ç ä½¿ç”¨`beforeAll`è¿™ä¸ªé’©å­å‡½æ•°ï¼Œæ‰§è¡Œ it å‡½æ•°å‰ï¼Œéƒ½ä¼šè°ƒç”¨`beforeAll`å‡½æ•°é‡Œçš„ä»£ç åˆå§‹åŒ– `counter` å˜é‡ã€‚

### afterAll

ä¸ä¸Šé¢å¯¹åº”ï¼Œå½“æ‰§è¡Œå®Œæ‰€æœ‰ it å‡½æ•°åï¼Œä¼šè°ƒç”¨ afterAll é’©å­å‡½æ•°ã€‚

### beforeEach

æ¯ä¸€ä¸ª`it` å‡½æ•°æ‰§è¡Œå‰ï¼Œéƒ½ä¼šæ‰§è¡Œ beforeEach é’©å­å‡½æ•°ã€‚

```js
describe('æµ‹è¯• counter', () => {
  beforeEach(() => {
    counter = new Counter()
  })

  it('æµ‹è¯• addOne', () => {
    counter.addOne()
    expect(counter.number).toBe(1)
  })

  it('æµ‹è¯• minusOne', () => {
    counter.minusOne()
    expect(counter.number).toBe(-1)
  })
})
```

ä¸Šé¢çš„ä»£ç åœ¨æ¯æ¬¡æ‰§è¡Œ it å‡½æ•°å‰ï¼Œéƒ½ä¼šè°ƒç”¨ä¸€ä¸‹ beforeEach é‡Œçš„å‡½æ•°å°† counter åˆå§‹åŒ–ä¸ºä¸€ä¸ªæ–°çš„ Counter å®ä¾‹ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯èƒ½å¤Ÿä¿è¯å„ä¸ª it å‡½æ•°å†…çš„æ•°æ®ä¸å—äº’ç›¸çš„å½±å“ã€‚

### afterEach

ä¸ beforeEach å¯¹åº”ï¼Œåœ¨æ¯ä¸ª it å‡½æ•°è°ƒç”¨ä¹‹åä¼šæ‰§è¡Œ afterEach æ³¨å†Œçš„å‡½æ•°ã€‚

### describe

describe å‡½æ•°æ˜¯åˆ†ç»„å‡½æ•°ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé’©å­å‡½æ•°ã€‚

åœ¨ä¸€ä¸ª test æ–‡ä»¶ä¸­ä½¿ç”¨å¤šä¸ªåˆ†ç»„å‡½æ•°èƒ½å¤Ÿå¸®åŠ©æ¢³ç†ä¸åŒçš„é€»è¾‘ã€‚

describe å†…çš„é’©å­å‡½æ•°æ˜¯æœ‰ä½œç”¨åŸŸçš„ã€‚æ¯”å¦‚ä»¥ä¸‹ä»£ç ï¼š

```js
import { Counter } from '../utils/counter'

let counter: Counter
beforeEach(() => {
  console.log('æˆ‘çš„ä½œç”¨åŸŸå…¨ä½“')
  counter = new Counter()
})
describe('æµ‹è¯• åŠ æ³•', () => {
  beforeEach(() => {
    console.log('æˆ‘çš„ä½œç”¨åŸŸåœ¨é‡Œé¢')
  })
  it('æµ‹è¯• addOne', () => {
    counter.addOne()
    expect(counter.number).toBe(1)
  })
  it('æµ‹è¯• addOne', () => {
    counter.addOne()
    expect(counter.number).toBe(1)
  })
})

describe('æµ‹è¯• å‡æ³•', () => {
  it('æµ‹è¯• minusOne', () => {
    counter.minusOne()
    expect(counter.number).toBe(-1)
  })
  it('æµ‹è¯• minusOne', () => {
    counter.minusOne()
    expect(counter.number).toBe(-1)
  })
})
```

ç¬¬ä¸€ä¸ª beforeEach æ˜¯å…¨å±€çš„ï¼Œæ¯ä¸€ä¸ª describe å‡½æ•°å†…çš„ it æ‰§è¡Œå‰éƒ½ä¼šæ‰§è¡Œå®ƒã€‚

ç¬¬äºŒä¸ª beforeEach åªåœ¨ç¬¬ä¸€ä¸ª describe å†…æœ‰ä½œç”¨ã€‚

> tips:å¯ä»¥ä½¿ç”¨ `describe.only` æˆ–è€… `it.only`æ¥ä»…æ‰§è¡Œå•ç»„æˆ–å•ä¸ªæµ‹è¯•ç”¨ä¾‹

## DoneCallback

ç°åœ¨æœ‰ä¸€ä¸ªå‡½æ•°

```js
// src/utils/after1000ms.ts
type AnyFunction = (...rest: any[]) => any

export function after1000ms(callback?: AnyFunction) {
  // è¿™é‡Œæœ‰å¤§é‡çš„é€»è¾‘ï¼Œç”¨ for å¾ªç¯ä»£æ›¿
  for (let i = 0; i < 100000; i++) {}
  setTimeout(() => {
    callback && callback()
  }, 1000)
}
```

è¿™ä¸ªå‡½æ•°ä¼šä¼ å…¥ä¸€ä¸ª callbackï¼Œå¹¶ä¸”åœ¨ 1000 ç§’åæ‰§è¡Œ callbackã€‚å‡è®¾æˆ‘å¸Œæœ›çŸ¥é“ä¼ å…¥çš„ callback **æœ‰æ²¡æœ‰è¢«è°ƒç”¨**ï¼Œè¯¥å¦‚ä½•åš?

åœ¨ it çš„å›è°ƒå‡½æ•° `ProvidesCallback`ä¸­æœ‰ä¸€ä¸ª cb å‚æ•°ï¼Œå³ `DoneCallback`ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨è°ƒç”¨`after1000ms`åè°ƒç”¨ä¸€ä¸‹è¿™ä¸ª`DoneCallback`,å°±èƒ½å¤Ÿé€šçŸ¥ Jest è¢«æµ‹è¯•çš„å‡½æ•°è¢«è°ƒç”¨è¿‡äº†ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```js
// src/tests/after1000ms.test.ts
import { after1000ms } from 'utils/after1000ms'
describe('after1000ms', () => {
  it('æµ‹è¯•å‡½æ•°è¢«è°ƒç”¨äº†', (done) => {
    after1000ms(() => {
      expect('å‡½æ•°è¢«è°ƒç”¨äº†')
      done()
    })
  })
})
```

## useFakeTimers

useFakeTimers èƒ½å¤Ÿæ¨¡æ‹Ÿ setTimeout çš„å»¶è¿Ÿæ—¶é—´ï¼ŒåŸæœ¬éœ€è¦ 1000ms çš„ç­‰å¾…æ—¶é—´ï¼Œä½¿ç”¨è¿™ä¸ª API å°±èƒ½å¤Ÿè·³è¿‡ç­‰å¾…æ—¶é—´ã€‚

> æ³¨æ„ï¼Œæœ€å¥½åœ¨ä½¿ç”¨ useFakeTimers æ—¶æ­é… beforeEach æ„é€ å‡½æ•°ï¼Œè¿™æ ·èƒ½åœ¨æ¯æ¬¡ it å‡½æ•°æ‰§è¡Œå‰é‡æ–°åˆå§‹åŒ–ä¸€ä¸‹ã€‚ä½¿å„ä¸ª it å‡½æ•°å†…éƒ¨çš„`jest.runAllTimers`æˆ–`advanceTimersByTime`ä¸äº’ç›¸å½±å“

- **æ­é… `jest.runAllTimers`**

  æ¯”å¦‚ä¸Šé¢çš„å¼‚æ­¥å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦è·³è¿‡ç­‰å¾… 1000msï¼Œå¹¶ä¸”éªŒè¯ callback å‡½æ•°è¢«è¿è¡Œäº†ä¸€æ¬¡ï¼Œå¯ä»¥è¿™ä¹ˆå†™ï¼š

  ```js
  beforeEach(() => {
    jest.useFakeTimers()
  })
  describe('mock timer', () => {
    it('timer callback', () => {
      const after1000ms = (callback: () => void) => {
        setTimeout(callback, 1000)
      }
      const fn = jest.fn()
      after1000ms(fn)
      jest.runAllTimers()
      expect(fn).toBeCalledTimes(1)
    })
  })
  ```

  å…¶ä¸­`jest.useFakeTimers`ç”¨æ¥å¼€å¯ä½¿ç”¨è™šå‡ timers åŠŸèƒ½ï¼Œ`jest.runAllTimers`ç”¨æ¥è·³è¿‡ **æ‰€æœ‰** setTimeout çš„ç­‰å¾…æ—¶é—´ã€‚

- **æ­é…`jest.advanceTimersByTime`**

  `advanceTimersByTime`é¡¾åæ€ä¹‰æ˜¯å¿«è¿›ä¸€äº›æ—¶é—´ã€‚å¯ä»¥ç†è§£ä¸ºæŠŠ `setTimeout`çš„ç­‰å¾…æ—¶é—´å¿«è¿›äº†ã€‚

  è¿˜æ˜¯åŒæ ·çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬ç”¨è¿™ä¸ª API æ¥å°†æ—¶é—´å¿«è¿› 100 ç§’ã€‚

  ```js
  beforeEach(() => {
    jest.useFakeTimers()
  })
  describe('mock timer', () => {
    it('timer callback', () => {
      const after1000ms = (callback: () => void) => {
        setTimeout(callback, 100000)
      }
      const fn = jest.fn()
      after1000ms(fn)
      jest.advanceTimersByTime(100000)
      expect(fn).toBeCalledTimes(1)
    })
  })
  ```

  è·Ÿ`runAllTimers`çš„åŒºåˆ«æ˜¯è¿™ä¸ª`advanceTimersByTime` æ›´åŠ çµæ´»ï¼Œæ¯”å¦‚æˆ‘æœ‰ä¸¤å±‚ `setTimeout`

  ```js
  beforeEach(() => {
    jest.useFakeTimers()
  })
  describe('mock timer', () => {
    it('timer callback', () => {
      const after1000ms = (callback: () => void) => {
        setTimeout(() => {
          callback()
          setTimeout(() => {
            callback()
          }, 1000)
        }, 1000)
      }
      const fn = jest.fn()
      after1000ms(fn)
      jest.advanceTimersByTime(1000)
      expect(fn).toBeCalledTimes(1)
    })
  })
  ```

  æˆ‘ä»¬å¯ä»¥æŠŠæ—¶é—´å¿«è¿› 1000 ç§’ï¼Œè¿™æ ·å°±èƒ½æ–­è¨€å‡º`fn` æ‰§è¡Œäº†ä¸€æ¬¡ã€‚

  ç”¨ `runAllTimers`ä¼šè·³è¿‡ä¸¤æ¬¡ `setTimeout`,æ²¡åŠæ³•åªæ–­è¨€ç¬¬ä¸€æ¬¡ `setTimeout` æ—¶ `fn` æ‰§è¡Œäº†ä¸€æ¬¡ã€‚

- **æ­é…`jest.runOnlyPendingTimers`**

  åœ¨å¼€å‘æ—¶ï¼Œè¿˜æœ‰ä¸€ç§è½®è¯¢çš„åœºæ™¯ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨åµŒå¥—`setTimeout`å†™çš„è½®è¯¢å‡½æ•°ã€‚

  ```js
  function loopSleep(handler: () => void, delay: number) {
    setTimeout(() => {
      handler()
      loopSleep(handler, delay)
    }, delay)
  }
  ```

  å‡è®¾æˆ‘éœ€è¦æµ‹è¯•è¯¥è½®è¯¢å‡½æ•°æ˜¯å¦æ‰§è¡Œäº† `handler`,æˆ‘å¯ä»¥ç”¨`mock`ä¸€ä¸ªå‡½æ•°ã€‚

  ```js
  beforeEach(() => {
    jest.useFakeTimers()
  })
  it('loopSleep', (done) => {
    const fn = jest.fn()
    loopSleep(fn, 1000)
    jest.runAllTimers()
    expect(fn).toBeCalled()
  })
  ```

  è¿™æ—¶ä¼šæŠ¥ä¸€ä¸ªé”™è¯¯

  ![image-20230302202206967](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052017834.png)

  åŸå› æ˜¯ `runAllTimers`ä¼šæ¥ç®¡æ‰€æœ‰`setTimeout`ï¼Œæ‰€ä»¥ä¼šä¸€ç›´å¾ªç¯è°ƒç”¨`loopSleep`ã€‚

  é’ˆå¯¹è¿™ç§åœºæ™¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`runOnlyPendingTimers`ï¼Œå®ƒåªä¼šè¿è¡Œç›®å‰æŒ‚èµ·çš„å®šæ—¶å™¨ã€‚

  ```diff
    it('loopSleep', (done) => {
      const fn = jest.fn()
      loopSleep(fn, 1000)
  -    jest.runAllTimers()
  +    jest.runOnlyPendingTimers()
      expect(fn).toBeCalled()
    })
  ```

- **åœ¨ `setTimeout` ä¸­æ‰§è¡Œå¾®ä»»åŠ¡çš„æƒ…å†µ**

  åœ¨å¼€å‘ä¸­ï¼Œè¿˜æœ‰ä¸€ç§åœ¨å®šæ—¶å™¨å†…æ‰§è¡Œå¾®ä»»åŠ¡çš„æƒ…å†µï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå¾®ä»»åŠ¡æ˜¯ `promise.then`ã€‚

  å‚è€ƒä¸‹é¢çš„`afterDelay`å‡½æ•°ï¼š

  ```js
  function afterDelay(handler: () => void, delay: number) {
    setTimeout(() => {
      Promise.resolve().then(() => handler())
    }, delay)
  }
  ```

  å‡è®¾æˆ‘éœ€è¦æ–­è¨€`handler`æ˜¯å¦æ‰§è¡Œï¼Œèƒ½ä¸èƒ½ç”¨ä»¥ä¸‹ä»£ç ï¼Ÿ

  ```js
  beforeEach(() => {
    jest.useFakeTimers()
  })
  it('afterDelay', () => {
    const fn = jest.fn()
    afterDelay(fn, 1000)
    jest.runAllTimers()
    expect(fn).toBeCalled()
  })
  ```

  å¾ˆä¸å¹¸ï¼Œç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚

  ![image-20230302204230799](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052017498.png)

  åŸå› æ˜¯`useFakeTimers`æ›¿æ¢äº†æµè§ˆå™¨çš„å®šæ—¶å™¨è°ƒåº¦å‡½æ•°ï¼Œä½¿ç”¨`useFakeTimers()`åçš„`afterDelay`é‡Œé¢çš„`setTimeout`æˆ‘ä»¬å¯ä»¥çœ‹ä½œæ˜¯åŒæ­¥ä»£ç ï¼Œä½†æ˜¯`promise.then`ä¾ç„¶æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥`expect`ä¼šåœ¨`then`ä¹‹å‰æ‰§è¡Œï¼Œè€Œ`handler`åœ¨`then`åè¢«æ‰§è¡Œï¼Œæœ€ç»ˆå¯¼è‡´æµ‹è¯•ç”¨ä¾‹çš„å¤±è´¥ã€‚

  è§£å†³çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦ä¿è¯æ–­è¨€åœ¨`promise.then`ä¹‹åè¿è¡Œå³å¯ã€‚

  ```js
  it('afterDelay', async () => {
    const fn = jest.fn()
    afterDelay(fn, 1000)
    jest.runAllTimers()
    // ç”¨ await é˜»å¡
    await Promise.resolve()
    expect(fn).toBeCalled()
  })
  ```

  ä¸Šé¢çš„ä»£ç ç”¨`await`é˜»å¡äº†`Promise.resolve`,è®©æ•´è¡Œä»£ç ä»¥åŠä¸‹é¢çš„ä»£ç éƒ½å˜æˆäº†å¼‚æ­¥å‡½æ•°ã€‚

  æ­¤æ—¶å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„é˜Ÿé¦–æ˜¯`promise.then`ï¼Œå…¶æ¬¡æ˜¯`Promise.resolve`ï¼Œè¿™æ ·å°±èƒ½ä¿è¯`expect`åœ¨`promise.then`ä¹‹åè¿è¡Œã€‚

## Mock

### mock å‡½æ•°

jest æä¾›äº†ä¸€ä¸ªå¯ä¾› mock çš„ fn å‡½æ•°ï¼Œ fn å‡½æ•°å¯ä»¥è¢«æ•è·åˆ°æ˜¯å¦æ‰§è¡Œè¿‡ã€‚

æ¯”å¦‚ï¼Œæœ‰ä¸€ä¸ª runCallback çš„å‡½æ•°,æˆ‘éœ€è¦æ•æ‰åˆ°ä¼ ç»™å®ƒçš„ callback èƒ½å¦è¢«æ­£å¸¸è°ƒç”¨

```js
describe('mock', () => {
  function runCallback(callback: Function) {
    callback()
  }
  it('callbackæ‰§è¡Œäº†', () => {
    const func = jest.fn()
    expect(runCallback(func)).toBeCalled()
  })
})
```

åŒæ—¶ jest.fn è¿˜æ”¯æŒæ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„è¿”å›ç»“æœå°†å˜æˆ jest.fn çš„è¿”å›ç»“æœã€‚

```js
it('callbackæ‰§è¡Œäº†', () => {
  const func = jest.fn(() => 123)
  runCallback(func)
  // expect(runCallback(func)).toBeCalled();
  console.log('ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ - func', func.mock)
})
/* {
        calls: [ [] ], è¢«è°ƒç”¨äº†å¤šå°‘æ¬¡
        contexts: [ undefined ],
        instances: [ undefined ], æ¯æ¬¡è°ƒç”¨å this çš„æŒ‡å‘
        invocationCallOrder: [ 1 ], æ‰§è¡Œçš„é¡ºåº
        results: [ { type: 'return', value: 123 } ], è¿”å›ç»“æœ
        lastCall: []
      } */
```

é€šè¿‡æ‰“å° `func.mock`,èƒ½å¤Ÿè·å–åˆ°å‡½æ•°è¢«è°ƒç”¨ä¹‹åçš„è¿”å›ç»“æœï¼Œå³ä¸Šé¢æ³¨é‡Šä¸­çš„`results`å±æ€§ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜èƒ½å¤Ÿé€šè¿‡å†…éƒ¨çš„`mockReturnValue`æ¥æ‰‹åŠ¨æŒ‡å®šç»“æœã€‚

```js
it('callbackæ‰§è¡Œäº†', () => {
  const func = jest.fn()
  func.mockReturnValueOnce('666')
  func.mockReturnValue('888')
  runCallback(func)
  runCallback(func)
  // expect(runCallback(func)).toBeCalled();
  console.log('ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ - func', func.mock)
})
/* {
        calls: [ [], [] ],
        contexts: [ undefined, undefined ],
        instances: [ undefined, undefined ],
        invocationCallOrder: [ 1, 2 ],
        results: [
          { type: 'return', value: '666' },
          { type: 'return', value: '888' }
        ],
        lastCall: []
      } */
```

ä»¥ä¸‹æ˜¯å¸¸ç”¨çš„èƒ½å¤Ÿæ‰‹åŠ¨æŒ‡å®š`mockFn`ç»“æœçš„ APIï¼š

| mockFn æä¾›çš„ API                     | ç”¨é€”                                  |
| ------------------------------------- | ------------------------------------- |
| `mockFn.mockReturnValue(value)`       | Mock è¿”å›å€¼ï¼ŒåŒæ­¥                     |
| `mockFn.mockReturnValueOnce(value)`   | Mock è¿”å›å€¼ï¼ŒåŒæ­¥ï¼Œåªç”Ÿæ•ˆä¸€æ¬¡         |
| `mockFn.mockResolvedValue(value)`     | Mock resolve è¿”å›å€¼ï¼Œå¼‚æ­¥             |
| `mockFn.mockResolvedValueOnce(value)` | Mock resolve è¿”å›å€¼ï¼Œå¼‚æ­¥ï¼Œåªç”Ÿæ•ˆä¸€æ¬¡ |
| `mockFn.mockRejectedValue(value)`     | Mock reject è¿”å›å€¼ï¼Œå¼‚æ­¥              |
| `mockFn.mockRejectedValueOnce(value)` | Mock reject è¿”å›å€¼ï¼Œå¼‚æ­¥, åªç”Ÿæ•ˆä¸€æ¬¡  |

### mock object

`jest.spyOn`æ–¹æ³•èƒ½å¤Ÿ mock `object`ï¼ˆclassã€object å®ä¾‹ç­‰ï¼‰çš„æ–¹æ³•ã€‚

```js
jest.spyOn(object, method, accessType)
```

ä¾‹å¦‚å½“å‰æœ‰ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼š

```js
const person = { say: () => 'hello', playing: () => 'basketball' }
```

å¦‚æœæˆ‘å¸Œæœ›`mock` å®ƒçš„`say`æ–¹æ³•ï¼Œå¯ä»¥ç”¨`jest.spyOn`æ¥ç®¡å®ƒ

```js
it('mock person.say', async () => {
  const person = { say: () => 'hello', playing: () => 'basketball' }
  jest.spyOn(person, 'say').mockReturnValue('yes')
  const sayWhat = person.say()
  const playWhat = person.playing()
  //  sayæ–¹æ³•è¢«æ¥ç®¡äº†
  expect(sayWhat).toBe('yes')
  //  playingæ–¹æ³•æ²¡æœ‰è¢«æ¥ç®¡
  expect(playWhat).toBe('basketball')
})
```

`spyOn`æ–¹æ³•ä¹Ÿå¯ä»¥æ¥å— `class`,ä¸‹é¢æ˜¯ mock `class` çš„`static`æ–¹æ³•çš„ç¤ºä¾‹ï¼š

```js
class People {
  static getName() {
    return 'name'
  }
}
it('mock People.getName', async () => {
  jest.spyOn(People, 'getName').mockReturnValue('yes')
  const res = People.getName()
  expect(res).toBe('yes')
})
```

é™¤æ­¤ä¹‹å¤–ï¼Œ`spyOn`æ–¹æ³•æºç ä¸­å¯¹ç±»å‹åšäº†å¤„ç†ï¼Œèƒ½å¤Ÿæ ¹æ®ä¼ å‚è‡ªåŠ¨è·å–ç±»å‹ã€‚

![image-20230303224144067](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052017745.png)

ä»æºç å¯ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒçš„æºç ä½¿ç”¨æ³›å‹ `T extends {}` é™åˆ¶å’ŒåŒ¹é…ç¬¬ä¸€ä¸ªå‚æ•°ä¸º Object ç±»å‹ï¼Œç¬¬äºŒä¸ªå‚æ•° `method`åˆ™åŒ¹é…ç¬¬ä¸€ä¸ªå‚æ•°å†…çš„ `key`â€”â€”`Key extends keyof T`ã€‚

å¦‚æœä»…éœ€è¦`mock`å•ä¸ªæ–¹æ³•,`spyOn`è¶³å¤Ÿè¦†ç›–æˆ‘ä»¬ç»å¤§éƒ¨åˆ†çš„ä½¿ç”¨åœºæ™¯äº†ã€‚

ä½†å¦‚æœè¦`mock`å…¨ä½“æ–¹æ³•ï¼Œé‚£ä¹ˆè¿˜éœ€è¦å…¨å±€ `mock`ã€‚

### å…¨å±€ mock

åœ¨ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå¯¼å…¥ä¸€äº›å¤–éƒ¨ä¾èµ–è¿›è¡Œæµ‹è¯•ï¼Œé’ˆå¯¹è¿™äº›å¤–éƒ¨ä¾èµ–ï¼Œæˆ‘ä»¬å¯èƒ½å¹¶ä¸å…³å¿ƒå®ƒçš„å†…éƒ¨é€»è¾‘æ˜¯æ€ä¹ˆæ ·çš„ï¼Œæˆ‘ä»¬åªéœ€è¦å®ƒè¿”å›é¢„æœŸçš„ç»“æœå°±å¥½ã€‚

å¯¹äºè¿™ç§åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡å–å…¨å±€ mock çš„æ–¹å¼ï¼Œjest ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ª å…¨å±€ mock çš„ APIã€‚

```js
jest.mock(path, moduleFactory)
```

å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œ`path` å’Œ `moduleFactory`ï¼Œå…¶ä¸­ `path` æ˜¯éœ€è¦ `mock` çš„æ–‡ä»¶è·¯å¾„ï¼Œ`moduleFactory` æ˜¯è¿™ä¸ªæ¨¡å—çš„å·¥å‚å‡½æ•°ï¼Œç±»å‹ä¸æ¨¡å—ä¿æŒä¸€è‡´å°±è¡Œï¼Œå¯ä»¥è¿›è¡Œæ›´è‡ªå®šä¹‰çš„ `mock`ã€‚

**è¿™ä¸ª `mock` çš„æ‰§è¡Œä¼šæ›¿ä»£åŸæœ‰çš„æ¨¡å—å†…å®¹ï¼Œæ¥ç®¡åŸæœ‰æ¨¡å—æš´éœ²å‡ºæ¥çš„æ–¹æ³•ï¼Œå¹¶ä¸”æŠŠå®ƒä»¬éƒ½å˜æˆ `mockFn`ã€‚**

ä¸‹é¢æœ‰ä¸€ä¸ªä¾‹å­ï¼š

`jest.mock`æ¥ç®¡ `axios` æš´éœ²å‡ºæ¥çš„ `API`ï¼Œå¹¶ä¸”å°†å®ƒä»¬å˜ä¸º `mockFn`ä»¥ä¾¿æˆ‘ä»¬æ–­è¨€ã€‚

```js
import axios from 'axios';

jest.mock('axios');
const mockedAxios = axios as jest.Mocked<typeof axios>;
describe('mock', () => {
  function getData() {
    return axios.get('http://www.dell-lee.com/react/api/demo1.json');
  }

  it('getDataå‘é€è¯·æ±‚äº†', async () => {
    mockedAxios.get.mockResolvedValue({ data: 'anything' });
    const res = await getData();
    // console.log('ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€ - res', res);
    expect(res).toEqual({ data: 'anything' });
  });
});
```

1. æˆ‘ä»¬å…ˆç”¨ `jest.mock('axios')`mock äº† axiosã€‚

2. æ¥ç€ç”¨`mockedAxios.get.mockResolvedValue`æŒ‡å®š mock ç»“æœä¸º`{ data: 'anything' }`ã€‚

3. æœ€åï¼Œæˆ‘ä»¬æ–­è¨€ç»“æœä¸º`{ data: 'anything' }`è¡¨ç¤º`axios.get`è¯·æ±‚ç¡®å®å·²å‘é€å¹¶å·²æ‹¿åˆ°è¯·æ±‚ç»“æœã€‚

è¿™ç§è¡Œä¸ºå¹¶ä¸ä¼šçœŸå®å‘é€ `axios.get` è¯·æ±‚ï¼ŒåŒæ—¶ä¹Ÿä¸åœ¨ä¹è¿”å›ç»“æœã€‚åœ¨ä¸æµ‹è¯•åç«¯è¿”å›å€¼çš„åœºæ™¯ä¸‹éå¸¸èŠ‚çœæµ‹è¯•æ—¶é—´ã€‚

**è§£å†³ç±»å‹æŠ¥é”™é—®é¢˜**

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€è¡Œä»£ç ï¼š

```js
const mockedAxios = axios as jest.Mocked<typeof axios>;
```

è¿™ä¸ªä»£ç ä¸»è¦ç”¨æ¥è§£å†³ mock `axios` æ—¶å¸¦æ¥çš„ç±»å‹æŠ¥é”™é—®é¢˜

ç›´æ¥ä½¿ç”¨`axios`ä¼šæœ‰ç±»å‹æŠ¥é”™

![image-20230303210617860](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052017332.png)

å› ä¸ºæˆ‘ä»¬è™½ç„¶`mock`äº† `axios`ï¼Œä½†æ˜¯å®ƒå†…éƒ¨çš„ç±»å‹æ²¡æœ‰å¾—åˆ°ä¿®æ”¹ï¼Œæ‰€ä»¥`TypeScript`ä¼šæœ‰ç±»å‹æ£€æŸ¥çš„æŠ¥é”™ã€‚

é™¤äº†ä½¿ç”¨å¼ºåˆ¶ç±»å‹æ–­è¨€å¤–ï¼Œè¿˜èƒ½ä½¿ç”¨`jest.mocked`æ–¹æ³•è§£å†³ç±»å‹æŠ¥é”™é—®é¢˜ã€‚

```js
const { mocked } = jest
```

ç°åœ¨æŠ¥é”™æ¶ˆå¤±äº†ã€‚

![image-20230303211050141](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052017310.png)

### mock class

å¯¹ class ä¸­çš„å‡½æ•°æˆ–è€…è¿”å›å€¼çš„æµ‹è¯•å°±è·Ÿæ™®é€šçš„å‡½æ•°æ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚ä»¥ä¸‹ classï¼š

```js
// util/Util.ts
export default class Util {
  init() {
    return 1
  }
  start() {
    return 2
  }
}
```

æˆ‘è¦å¯¹å®ƒçš„è¿”å›ç»“æœåšæµ‹è¯•ï¼Œåˆ™å¯ä»¥å•ç‹¬åˆ›å»ºå®ƒçš„æµ‹è¯•ç”¨ä¾‹ï¼š

```js
import Util from '../util/Util'

let util: Util
beforeAll(() => {
  util = new Util()
})

describe('æµ‹è¯• Util ç±»', () => {
  it('æµ‹è¯• util æ–¹æ³•çš„ç»“æœ', () => {
    expect(util.init()).toBe(1)
    expect(util.start()).toBe(2)
  })
})
```

ç„¶è€Œï¼Œclass çš„è°ƒç”¨å¾€å¾€ä¼šåœ¨å¤§å¤šæ•°å…¶ä»–çš„å‡½æ•°ä¸­ä¸€èµ·è¢«è°ƒç”¨ï¼Œæ¯”å¦‚ä¸‹é¢çš„ foo å‡½æ•°å°±åœ¨å†…éƒ¨ä½¿ç”¨äº† Util ç±»

```js
import Util from './Util'

export function foo() {
  let util = new Util()
  util.init()
  util.start()
}
```

æˆ‘ä»¬å·²ç»å¯¹ Util æ„é€ å‡ºæ¥çš„å®ä¾‹æ–¹æ³•äº§ç”Ÿçš„ç»“æœè¿›è¡Œè¿‡æµ‹è¯•äº†,æ‰€ä»¥æˆ‘ä¸åœ¨ä¹ `util.init`å’Œ `util.start`äº§ç”Ÿçš„ç»“æœã€‚

æˆ‘åªæƒ³æµ‹è¯•åˆ° foo å‡½æ•°ä¸­ util æ˜¯å¦è°ƒç”¨è¿‡ init å’Œ start å‡½æ•°?è¿™å°±éœ€è¦`mock class`ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ `mock Util`,å°±è·Ÿ `mock axios` æ˜¯ä¸€æ ·çš„

```js
jest.mock('../util/Util')
import Util from '../util/Util'
import { foo } from '../util/foo'

const mockedUtil = jest.mocked(Util)
```

æ­¤æ—¶çš„æ•ˆæœçº¦ç­‰äºï¼š

```js
Util = jest.fn()
Util.init = jest.fn()
Util.start = jest.fn()
```

è¿™æ—¶å€™å°±èƒ½å¤Ÿè¿½è¸ªåˆ°å®ƒæ˜¯å¦è¢«è°ƒç”¨è¿‡ã€‚

```js
describe('æµ‹è¯• foo', () => {
  it('foo æ–¹æ³•ä¸­çš„ init å’Œ start æ–¹æ³•è¢«è°ƒç”¨äº†', () => {
    foo()
    expect(mockedUtil).toBeCalled()
    expect(mockedUtil.mock.instances[0].init).toBeCalled()
    expect(mockedUtil.mock.instances[0].start).toBeCalled()
  })
})
```

> æˆ‘ä»¬å•ç‹¬å¯¹ class ä¸­çš„æ–¹æ³•ç»“æœåšå‡ºçš„æµ‹è¯•ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå•å…ƒæµ‹è¯•ï¼Œåªå¯¹æŸä¸ªæ¨¡å—åŠŸèƒ½è´Ÿè´£ã€‚
>
> å¯¹åƒ foo è¿™æ ·çš„ï¼Œåœ¨å†…éƒ¨ä½¿ç”¨äº†å„ä¸ªåŠŸèƒ½çš„å‡½æ•°çš„æµ‹è¯•ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºé›†æˆæµ‹è¯•ã€‚

## snapshot

snapshot æ˜¯å¿«ç…§çš„æ„æ€ã€‚å®ƒä¼šç”Ÿæˆä¸€ä¸ª`__snapshots__`æ–‡ä»¶å¤¹æ¥ä¿å­˜ä¸€ä¸ªæµ‹è¯•å¿«ç…§ï¼Œè¿™ä¸ªå¿«ç…§çš„å†…å®¹å°±æ˜¯æ‰§è¡Œçš„ç»“æœã€‚

ä¾‹å¦‚ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªç”Ÿæˆé…ç½®é¡¹çš„å‡½æ•°ï¼š

```js
// snapshot
export const generateConfig = () => {
  return {
    server: 'localhost',
    port: 8080,
    protocol: 'http://',
  }
}
```

å¦‚æœå¯¹å®ƒè¿›è¡Œæµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆå†™ï¼š

```js
it('æµ‹è¯• generateConfig', () => {
  expect(generateConfig()).toEqual({
    server: 'localhost',
    port: 8080,
    protocol: 'http://',
  })
})
```

è¿™æ ·æ˜¯èƒ½å¤Ÿé€šè¿‡æµ‹è¯•çš„ï¼Œä½†æ˜¯éšç€æˆ‘ä»¬é…ç½®é¡¹çš„ä¸æ–­æ›´æ–°ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¾—ä¸åŒæ—¶æ›´æ–°æµ‹è¯•ç”¨ä¾‹é‡Œçš„ä»£ç ï¼Œè¿™æ ·å°±éå¸¸éº»çƒ¦ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`toMatchSnapshot`åŒ¹é…å™¨æ¥ç”Ÿæˆä¸€ä¸ªå¿«ç…§ï¼Œè¿™ä¸ªå¿«ç…§å°†ç»“æœå‚¨å­˜èµ·æ¥ï¼Œæ¯æ¬¡æµ‹è¯•æ—¶ï¼Œéƒ½ä¼šå»è·Ÿå¿«ç…§å¯¹æ¯”ï¼Œå¦‚æœå¯¹æ¯”æˆåŠŸå°±é€šè¿‡ã€‚

å‡å¦‚æˆ‘ä»¬å¢åŠ äº†é…ç½®ï¼Œé‚£ä¹ˆåŒæ—¶æ›´æ–°å¿«ç…§å³å¯ã€‚

### ä½¿ç”¨å¿«ç…§

æŒ‰ç…§å¿«ç…§çš„é€»è¾‘ï¼Œæˆ‘ä»¬å°†æµ‹è¯•ç”¨ä¾‹ä»£ç æ”¹æˆè¿™æ ·ï¼š

```js
it('æµ‹è¯• generateConfig', () => {
  expect(generateConfig()).toMatchSnapshot()
})
```

è¿™æ—¶å€™ä¼šç”Ÿæˆ`__snapshots__`æ–‡ä»¶å¤¹ï¼Œé‡Œé¢ä¼šæœ‰ä¸€ä¸ª`snapshot.test.ts.snap` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```js
exports[`æµ‹è¯• generateConfig 1`] = `
{
  "port": 8080,
  "protocol": "http://",
  "server": "localhost",
}
`
```

å½“æµ‹è¯•ç”¨ä¾‹è¿è¡Œæ—¶ï¼Œä¼šæ‰¾åˆ°å¯¹åº”æ–‡ä»¶é‡Œçš„å¿«ç…§ï¼Œç„¶åå°†ç»“æœä¸å¿«ç…§å†…å®¹å¯¹æ¯”ã€‚

### æ›´æ–°å¿«ç…§

å‡è®¾æˆ‘ä»¬ç¡®å®ç”±äºä¸šåŠ¡çš„éœ€è¦ï¼Œæ›´æ–°äº†`generateConfig`çš„é…ç½®

```diff
export const generateConfig = () => {
  return {
    server: 'localhost',
    port: 8080,
    protocol: 'http://',
+    version: '1.0.0',
  };
};
```

è¿™æ—¶å€™å°±éœ€è¦æ›´æ–°å¿«ç…§ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š

1. ä½¿ç”¨ vscode- Jest æ’ä»¶

   vscode ä¸­çš„ Jest æ’ä»¶ä¼šæ£€æµ‹å¹¶è‡ªåŠ¨æç¤ºæ˜¯å¦è¦æ›´æ–° snapshot

   ![image-20221029173926654](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052018587.png)

2. å‘½ä»¤è¡Œä½¿ç”¨ watch æ¨¡å¼-u æ¨¡å¼

   ![image-20221029174105309](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052018190.png)

éšä¾¿ä½¿ç”¨å“ªç§æ–¹å¼ï¼Œéƒ½ä¼šç”Ÿæˆæ–°çš„å¿«ç…§

```js
// snapshot.test.ts.snap
exports[`æµ‹è¯• generateConfig 1`] = `
{
  "port": 8080,
  "protocol": "http://",
  "server": "localhost",
  "version": "1.0.0",
}
`
```

> Jest æ’ä»¶å’Œ u æ¨¡å¼éƒ½ä¼šæ›´æ–°å…¨éƒ¨å¿«ç…§ï¼Œå¦‚æœæƒ³è¦æŒ¨ä¸ªæ›´æ–°ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ i æ¨¡å¼

### ä¸ç²¾å‡†åŒ¹é…çš„å¿«ç…§

`toMatchSnapshot`å¯ä»¥æ¥å—ä¸€ä¸ªå¯¹è±¡å‚æ•°ï¼Œæˆ‘ä»¬é€šè¿‡å®ƒå¯ä»¥è®¾ç½®ä¸ç²¾ç¡®åŒ¹é…æŸä¸ªå¿«ç…§å†…å®¹ã€‚

ä¾‹å¦‚ï¼Œç°åœ¨çš„ config æ›´æ–°æˆå¦‚ä¸‹ä»£ç ï¼š

```js
export const generateConfig = () => {
  return {
    server: 'localhost',
    port: 8080,
    protocol: 'http://',
    version: '1.0.0',
+    time: new Date(),
  };
};
```

ç”±äº time å±æ€§æ˜¯ä¸æ–­æ”¹å˜çš„ï¼Œå¿«ç…§é‡Œçš„å†…å®¹åˆ™æ˜¯é™æ€çš„ã€‚æ¯æ¬¡è·Ÿå¿«ç…§å¯¹æ¯”æ—¶è‚¯å®šéƒ½ä¼šå‡ºé”™ã€‚

è¿™æ—¶å¯ä»¥æŒ‡å®šä¸€ä¸‹ä¸ç²¾ç¡®åŒ¹é…å¿«ç…§é‡Œé¢çš„ timeï¼Œè€Œæ˜¯åªéœ€è¦åˆ¤æ–­å®ƒæ˜¯ Date å³å¯é€šè¿‡æµ‹è¯•ã€‚

```js
it('æµ‹è¯• generateConfig', () => {
  expect(generateConfig()).toMatchSnapshot({
    time: expect.any(Date),
  })
})
```

## å¦‚ä½• Mock ç½‘é¡µåœ°å€

è™½ç„¶é€šè¿‡ jsdom é…ç½®äº†æµè§ˆå™¨ç¯å¢ƒï¼Œä½†æ˜¯ä¾ç„¶æœ‰ä¸å°‘éš¾æçš„åœ°æ–¹ã€‚æ¯”å¦‚ç½‘é¡µè·¯å¾„ã€‚

ä¸‹é¢æœ‰ä¸€ä¸ªå‡½æ•°èƒ½å¤Ÿå°†ç½‘é¡µçš„åœ°å€å˜æˆ objectã€‚

```js
// getUrlObject.ts
export function getUrlObj() {
  let urlObj = new URL(window.location.href);
  let obj = {};
  for (let key in urlObj) {
    if (['protocol', 'search', 'hash', 'href', 'pathname'].includes(key)) {
      Object.assign(obj, { [key]: urlObj[key as keyof typeof urlObj] });
    }
  }
  return obj;
}
```

æ¥ç€æ˜¯å¯¹å…¶çš„æµ‹è¯•æ–‡ä»¶

```js
// utils/getUrlObject.test.ts
import { getUrlObj } from 'utils/getUrlObject'

describe('æµ‹è¯•ç½‘é¡µåœ°å€', () => {
  it('å°†ç½‘é¡µåœ°å€æ˜ å°„æˆæ­£ç¡®çš„ object å¯¹è±¡', () => {
    window.location.href = 'https://baidu.com/hello-jest?name=qyx#age'
    expect(getUrlObj()).toEqual({
      href: 'https://baidu.com/hello-jest?name=qyx#age',
      search: '?name=qyx',
      hash: '#age',
      protocol: 'https:',
      pathname: '/hello-jest',
    })
  })
})
```

ç„¶è€Œæ‰§è¡Œ test åä¼šå¾—åˆ°ä»¥ä¸‹æŠ¥é”™ï¼š

![image-20221016085200589](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052018741.png)

è¿™è¯´æ˜ jsdom ä¸èƒ½ç›´æ¥ç”¨`window.location.href`è¿™ä¸ª API æµ‹è¯•ã€‚

### jest-location-mock

æœ‰ä¸€ä¸ªä¼˜é›…çš„å®ç°æ–¹æ³•ï¼š[jest-location-mock](https://www.npmjs.com/package/jest-location-mock)ï¼Œè¿™ä¸ªåŒ…æä¾›ä¿®æ”¹å’Œè·å– url çš„åŠŸèƒ½ã€‚

é¦–å…ˆå®‰è£…

```bash
npm i -D jest-location-mock
```

å®‰è£…å®ŒåŒ…ä¹‹åï¼Œéœ€è¦åœ¨ jest æµ‹è¯•æ¡†æ¶å¯åŠ¨å‰è£…è½½ä¸Šå»ã€‚å°†ä¹‹å‰æ³¨é‡Šè¿‡çš„`setupFilesAfterEnv`é…ç½®æ”¾å¼€

```json
 setupFilesAfterEnv: ['./src/tests/jest-setup.ts'],
```

ç„¶ååœ¨`jest-setup.ts`ä¸­å¼•å…¥è¯¥åŒ…

```js
// ä½¿ç”¨æ‰©å±•åŒ…æ¥ Mock 'window.location'
import 'jest-location-mock'
```

æœ€åè¿è¡Œ`npm run test`å¾—åˆ°ç»“æœ

![image-20221016092328983](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052018131.png)

### å°ç»“

å¯¹äºç½‘é¡µåœ°å€çš„ä¿®æ”¹å’Œæµ‹è¯•å¯ä»¥ä½¿ç”¨ jest-location-mock æ¥æ‰©å±• jsdom çš„èƒ½åŠ›ã€‚

æ‰©å±•çš„ä½¿ç”¨æ–¹æ³•æ˜¯å…ˆé…ç½®`setupFilesAfterEnv` é€‰é¡¹ï¼Œç„¶ååœ¨ setup æ–‡ä»¶ä¸­å¼•å…¥ï¼Œä½¿å…¶å˜æˆå…¨å±€ Mockã€‚

## TDD

TDD(æµ‹è¯•é©±åŠ¨å¼€å‘)æ˜¯ä¸€ç§éå¸¸å¥½çš„å¼€å‘æ¨¡å¼ï¼ŒåŸç†æ˜¯ï¼š**å…ˆå†™æµ‹è¯•ï¼Œå†å†™ä¸šåŠ¡ä»£ç ï¼Œå½“æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹éƒ½é€šè¿‡åï¼Œä¸šåŠ¡ä»£ç çš„å®ç°ä¹Ÿå‘¼ä¹‹æ¬²å‡ºäº†**ã€‚

![img](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052018065.jpg)

- çº¢è‰²éƒ¨åˆ†ï¼šåœ¨æ·»åŠ æ–°åŠŸèƒ½å‰å…ˆå†™æµ‹è¯•ç”¨ä¾‹ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¸®åŠ©ç¼•é€»è¾‘çš„è¿‡ç¨‹
- ç»¿è‰²éƒ¨åˆ†ï¼šå¼€å§‹æ·»åŠ ä¸šåŠ¡ä»£ç æ¥è®©æµ‹è¯•é€šè¿‡
- é‡æ„éƒ¨åˆ†ï¼šå›å¤´å®¡è§†è‡ªå·±çš„ä»£ç ï¼Œå°†å…¶é‡æ„æˆå¯è¯»æ€§å’Œç»´æŠ¤æ€§é«˜çš„ä»£ç ã€‚ï¼ˆåŒæ—¶é‡æ„åï¼Œæµ‹è¯•ç”¨ä¾‹ä¼šå¸®åŠ©æ£€æŸ¥é‡æ„åçš„é€»è¾‘æ˜¯å¦æœ‰æ¼æ´ï¼‰
- ...é‡å¤ä¸Šè¿°è¿‡ç¨‹

TDD çš„ä¸»è¦ä½œç”¨å¹¶ä¸æ˜¯ä¿è¯ä»£ç è´¨é‡ï¼Œè€Œæ˜¯åˆ›é€ ä¸€ä¸ªæ›´å¥½çš„å¼€å‘ç¯å¢ƒï¼Œåœ¨æ­¤åŸºç¡€ä¸Šä¿è¯ä»£ç çš„ä¸»è¦é€»è¾‘æ­£ç¡® âœ…ã€‚

### å®æˆ˜ä¸€ä¸ª search è½¬åŒ–åŠŸèƒ½

ä¸‹é¢æœ‰ä¸€ä¸ªéœ€æ±‚ï¼š

> å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°èƒ½å¤Ÿè·å– urlï¼Œç„¶åå°†å…¶ search è½¬åŒ–æˆå¯¹è±¡ã€‚å¦‚æœ search ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›ç©ºå¯¹è±¡
>
> å¦‚æœæœ‰ä¼ é€’å‚æ•°ï¼Œä¸”å‚æ•°ä¸º`xx=xxx&yy=yyy`å­—ç¬¦ä¸²æ—¶ï¼Œèƒ½å¤Ÿå°†å…¶è§£ææˆ`{xx:xxx,yy:yyy}`
>
> - `https://baidu.com?name=qyx` ===> `{ name: 'qyx' }`
> - `https://baidu.com` ===> `{}`
> - `?name=qyx&age=30` ===> `{ name: 'qyx',age: 30 }`

æ ¹æ®éœ€æ±‚ï¼Œæˆ‘ä»¬å…ˆå†™å¥½æµ‹è¯•æ–‡ä»¶ï¼š

```js
import { transformSearch } from 'utils/transformSearch'

describe('å°†url çš„ searchString å˜æˆ object', () => {
  it('èƒ½æ­£ç¡®è½¬åŒ–æˆå¯¹è±¡', () => {
    window.location.href = 'https://baidu.com?name=qyx&age=30#hello-jest'
    expect(transformSearch()).toEqual({ name: 'qyx', age: '30' })
  })

  it('æ— searchString ä½†æœ‰ ? æ—¶è§£æå‡ºç©ºå¯¹è±¡', () => {
    window.location.href = 'https://baidu.com?#hello-jest'
    expect(transformSearch()).toEqual({})
  })

  it('æ— searchString æ—  ? æ—¶è§£æå‡ºç©ºå¯¹è±¡', () => {
    window.location.href = 'https://baidu.com#hello-jest'
    expect(transformSearch()).toEqual({})
  })

  it('ä¼ å…¥?name=qyx&age=30è§£ææˆæ­£ç¡®å¯¹è±¡', () => {
    expect(transformSearch('?name=qyx&age=30')).toEqual({
      name: 'qyx',
      age: '30',
    })
  })

  it('ä¼ å…¥name=qyx&age=30è§£ææˆæ­£ç¡®å¯¹è±¡', () => {
    expect(transformSearch('name=qyx&age=30')).toEqual({
      name: 'qyx',
      age: '30',
    })
  })

  it('ä¼ å…¥https://baidu.com?name=qyx&age=30#hello-jestè§£ææˆæ­£ç¡®å¯¹è±¡', () => {
    expect(transformSearch('https://baidu.com?name=qyx&age=30#hello-jest')).toEqual({ name: 'qyx', age: '30' })
  })

  it('ä¼ å…¥ç©ºå­—ç¬¦ä¸²è§£ææˆç©ºå¯¹è±¡', () => {
    expect(transformSearch('')).toEqual({})
  })
})
```

é€šè¿‡ `window.location.href`æ¥è½¬åŒ–æˆå¯¹è±¡ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å†™å‡ºæ¥ï¼š

```js
export function transformSearch(searchString?: string) {
  if (searchString) {
  } else {
    let searchString = new URL(window.location.href).search
    searchString = searchString.replace(/\?/g, '')
    return Object.fromEntries(new URLSearchParams(searchString).entries())
  }
}
```

æµ‹è¯•åèƒ½é€šè¿‡å¤§éƒ¨åˆ†ç”¨ä¾‹ï¼Œåªå‰©é€šè¿‡ searchString å‚æ•°çš„é€»è¾‘æ˜¯å¤±è´¥çš„ã€‚é€šè¿‡ç”¨ä¾‹ï¼Œæˆ‘ä»¬èƒ½åˆ†æå‡ºç”¨æˆ·å¯èƒ½ä¼šä¼ é€’ä¸‰ç§æƒ…å†µï¼š

1. å¸¦é—®å·çš„æŸ¥è¯¢å­—ç¬¦ä¸²
2. ä¸å¸¦é—®å·çš„æŸ¥è¯¢å­—ç¬¦ä¸²
3. å¸¦é—®å·çš„æ•´ä¸ª URL è¿æ¥
4. ä¼ å…¥ä¸€ä¸ªç©ºå­—ç¬¦ä¸²

æ•´ä¸ª URL å¯ä»¥ä¼ é€’ç»™ `new URL()`æ¥æ„é€ ä¸€ä¸ª URL å¯¹è±¡ï¼Œè€Œå…¶ä»–çš„é url ä¼ è¿›å»ä¼šæŠ¥é”™ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆå†™ï¼š

```js
export function transformSearch(searchString?: string) {
  if (searchString) {
    try {
      let searchStr = new URL(searchString).search
      searchStr = searchStr.replace(/\?/g, '')
      return Object.fromEntries(new URLSearchParams(searchStr).entries())
    } catch (error) {
      let searchStr = searchString.replace(/\?/g, '')
      return Object.fromEntries(new URLSearchParams(searchStr).entries())
    }
  } else {
    let searchString = new URL(window.location.href).search
    searchString = searchString.replace(/\?/g, '')
    return Object.fromEntries(new URLSearchParams(searchString).entries())
  }
}
```

æ‰§è¡Œ`npm run test`æŸ¥çœ‹åˆ°æ‰€æœ‰ç”¨ä¾‹å·²ç»é€šè¿‡

![image-20221017214314575](https://raw.githubusercontent.com/18888628835/image-cloud/main/assets202307052018980.png)

ç°åœ¨å¯ä»¥ä¼˜åŒ–ä»£ç å•¦,å°†å®ƒä»¬å…±æœ‰çš„é€»è¾‘æŠ½ç¦»å‡ºæ¥å³å¯:

```js
function getObjFromSearch(search: string) {
  let searchString = search.replace(/\?/g, '')
  return Object.fromEntries(new URLSearchParams(searchString).entries())
}
export function transformSearch(searchString?: string) {
  if (searchString) {
    try {
      return getObjFromSearch(new URL(searchString).search)
    } catch (error) {
      return getObjFromSearch(searchString)
    }
  }
  return getObjFromSearch(new URL(window.location.href).search)
}
```

é‡æ–°æ‰§è¡Œ`npm run test`,æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ä¾ç„¶é€šè¿‡äº†ã€‚

å³ä½¿é‡æ„å†å¤šä»£ç ï¼Œæµ‹è¯•ç”¨ä¾‹ä¹Ÿèƒ½å¸®åŠ©æˆ‘ä»¬å…œåº•ï¼Œé¿å…é‡æ„åå½±å“ä¸»é€»è¾‘çš„å°´å°¬ã€‚

### å°ç»“

æœ‰ä¸¤ç§ä¸»è¦å¼€å‘æ¨¡å¼ï¼š

- TDD - æµ‹è¯•é©±åŠ¨å¼€å‘ï¼Œå³å…ˆå†™æµ‹è¯•ç”¨ä¾‹ï¼Œå†æ ¹æ®å®ƒä»¬è¡¥å……ä¸šåŠ¡ä»£ç 
- BDD - å…ˆå†™ä¸šåŠ¡ï¼Œå†å¯¹é‡è¦çš„éƒ¨åˆ†è¡¥å……æµ‹è¯•

TDD çš„å¥½å¤„æ˜¯æˆ‘ä»¬åœ¨å‰æœŸä¸ä»…èƒ½å¤Ÿå¯¹è¦åšçš„åŠŸèƒ½æœ‰ä¸€ä¸ªæ¸…æ™°çš„é€»è¾‘æ•´ç†ï¼Œè¿˜èƒ½å¤Ÿåœ¨åæœŸé‡æ„ä»£ç æ—¶å¯¹ä¸»é€»è¾‘å…œåº•ï¼Œä¸é™·å…¥é‡æ„åä¸»é€»è¾‘å‡ºé—®é¢˜çš„å¢ƒåœ°ã€‚

## github CI

ä»£ç æäº¤åˆ° github åï¼Œå¾€å¾€éœ€è¦é€šè¿‡ test æµ‹è¯•æ‰èƒ½åˆå¹¶åˆ°ä¸»åˆ†æ”¯ï¼Œæ‰€ä»¥è¿™é‡Œè´´ä¸€ä¸‹ giehub workflow çš„é…ç½®ï¼š

```bash
name: Test
on: push
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: codecov/codecov-action@v3
      - name: Install modules
        run: yarn
      - name: Upload coverage reports to Codecov
        run: npx codecov --token=${{ secrets.CODECOV_TOKEN }} --file=coverage.json
      - name: Run tests
        run: yarn test
```

codecov: token:
